<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Project Task Board</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Playfair+Display:wght@700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.6/Sortable.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root{
  --bg:#0b0d14;--surface:#131620;--surface-hover:#1a1d2a;--surface-elevated:#1e2130;
  --border:rgba(255,255,255,.06);--border-hover:rgba(255,255,255,.10);--border-strong:rgba(255,255,255,.16);
  --text:#e8e9ed;--text-secondary:#9a9db4;--text-muted:#5c6078;
  --accent:#c9a46c;--accent-light:#dfc28e;--accent-muted:rgba(201,164,108,.10);
  --today:#ef5350;--today-bg:rgba(239,83,80,.08);
  --tomorrow:#ffa726;--tomorrow-bg:rgba(255,167,38,.08);
  --weekly:#42a5f5;--weekly-bg:rgba(66,165,245,.08);
  --daily:#ab47bc;--daily-bg:rgba(171,71,188,.08);
  --done:#66bb6a;--done-bg:rgba(102,187,106,.06);
  --progress:#ffa726;--progress-bg:rgba(255,167,38,.06);
  --overdue:#ef5350;--overdue-bg:rgba(239,83,80,.06);
  --high:#ef5350;--medium:#ffa726;--low:#42a5f5;
  --my-task:rgba(201,164,108,.05);
  --radius:10px;--radius-sm:6px;--radius-lg:14px;
  --shadow-sm:0 1px 2px rgba(0,0,0,.4),0 2px 4px rgba(0,0,0,.2);
  --shadow-md:0 4px 12px rgba(0,0,0,.4),0 8px 24px rgba(0,0,0,.2);
  --shadow-lg:0 8px 24px rgba(0,0,0,.4),0 16px 48px rgba(0,0,0,.25)
}
*{margin:0;padding:0;box-sizing:border-box}
body{background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;min-height:100vh;-webkit-text-size-adjust:100%;overflow-x:hidden;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
::-webkit-scrollbar{width:6px;height:6px}::-webkit-scrollbar-track{background:transparent}::-webkit-scrollbar-thumb{background:rgba(255,255,255,.08);border-radius:3px}::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,.14)}

/* LOGIN */
.login-page{display:flex;align-items:center;justify-content:center;min-height:100vh;background:radial-gradient(ellipse at 30% 20%,rgba(201,164,108,.04) 0%,transparent 60%),radial-gradient(ellipse at 70% 80%,rgba(66,165,245,.03) 0%,transparent 60%),var(--bg)}
.login-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);padding:48px 44px;width:420px;max-width:92vw;box-shadow:var(--shadow-lg);animation:loginIn .5s cubic-bezier(.16,1,.3,1) both;position:relative;overflow:hidden}
.login-card::before{content:'';position:absolute;inset:0;border-radius:var(--radius-lg);padding:1px;background:linear-gradient(135deg,rgba(255,255,255,.08) 0%,rgba(255,255,255,.02) 50%,transparent 100%);-webkit-mask:linear-gradient(#fff 0 0) content-box,linear-gradient(#fff 0 0);-webkit-mask-composite:xor;mask-composite:exclude;pointer-events:none}
@keyframes loginIn{from{opacity:0;transform:translateY(24px) scale(.97)}to{opacity:1;transform:none}}
.login-logo{font-family:'Playfair Display',serif;font-size:2rem;font-weight:800;color:var(--accent-light);text-align:center;margin-bottom:6px;letter-spacing:2px}
.login-sub{text-align:center;color:var(--text-secondary);font-size:.88rem;margin-bottom:32px}
.login-field{margin-bottom:20px}
.login-field label{display:block;font-size:.75rem;font-weight:600;text-transform:uppercase;letter-spacing:.7px;color:var(--text-muted);margin-bottom:8px}
.login-field input{width:100%;padding:12px 16px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;font-size:16px;transition:border-color .15s ease,box-shadow .15s ease}
.login-field input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-muted)}
.login-btn{width:100%;padding:13px;border-radius:8px;border:none;background:var(--accent);color:var(--bg);font-family:'DM Sans',sans-serif;font-size:.95rem;font-weight:700;cursor:pointer;transition:all .15s ease;margin-top:8px}
.login-btn:hover{background:var(--accent-light);transform:translateY(-1px);box-shadow:0 4px 16px rgba(201,164,108,.3)}
.login-btn:active{transform:translateY(0) scale(.98);transition-duration:.1s}
.login-error{color:var(--overdue);font-size:.82rem;text-align:center;margin-top:14px;min-height:20px;font-weight:500}
.login-footer{text-align:center;margin-top:24px;font-size:.75rem;color:var(--text-muted);letter-spacing:.3px}

/* SPLASH SCREEN */
.splash{position:fixed;inset:0;z-index:9999;background:radial-gradient(ellipse at 50% 40%,#151720 0%,var(--bg) 70%);display:flex;flex-direction:column;align-items:center;justify-content:center;opacity:1;transition:opacity .5s ease,visibility .5s ease;visibility:visible}
.splash.hide{opacity:0;visibility:hidden;pointer-events:none}
.splash-logo-wrap{position:relative;display:flex;flex-direction:column;align-items:center;gap:0}
.splash-m{width:100px;height:100px;position:relative;opacity:0;animation:splashMIn .7s cubic-bezier(.16,1,.3,1) .2s forwards}
.splash-m svg{width:100%;height:100%}
@keyframes splashMIn{from{opacity:0;transform:scale(.7) translateY(16px)}to{opacity:1;transform:scale(1) translateY(0)}}
.splash-glow{position:absolute;top:50%;left:50%;width:180px;height:180px;transform:translate(-50%,-50%);background:radial-gradient(circle,rgba(201,164,108,.18) 0%,transparent 70%);border-radius:50%;opacity:0;animation:splashGlow 1s ease .4s forwards;pointer-events:none}
@keyframes splashGlow{from{opacity:0;transform:translate(-50%,-50%) scale(.5)}to{opacity:1;transform:translate(-50%,-50%) scale(1)}}
.splash-brand{display:flex;flex-direction:column;align-items:center;gap:4px;margin-top:16px}
.splash-title{font-family:'Playfair Display',serif;font-size:2.2rem;font-weight:800;letter-spacing:10px;color:var(--accent-light);opacity:0;animation:splashTextIn .6s cubic-bezier(.16,1,.3,1) .5s forwards}
.splash-sub{font-size:.68rem;font-weight:600;letter-spacing:5px;text-transform:uppercase;color:var(--text-muted);opacity:0;animation:splashTextIn .6s cubic-bezier(.16,1,.3,1) .7s forwards}
@keyframes splashTextIn{from{opacity:0;transform:translateY(10px);letter-spacing:18px}to{opacity:1;transform:translateY(0);letter-spacing:inherit}}
.splash-welcome{margin-top:28px;font-size:.82rem;color:var(--text-secondary);opacity:0;animation:splashFadeIn .5s ease 1s forwards}
@keyframes splashFadeIn{from{opacity:0}to{opacity:1}}
.splash-line{width:0;height:1px;background:linear-gradient(90deg,transparent,var(--accent),transparent);margin-top:18px;animation:splashLine .7s ease .4s forwards}
@keyframes splashLine{from{width:0}to{width:160px}}

.app{display:none!important}.app.visible{display:block!important}

/* HEADER */
.header{padding:20px 32px 16px;border-bottom:1px solid var(--border);background:linear-gradient(180deg,rgba(19,22,32,.8) 0%,var(--bg) 100%)}
.header-top{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px}
.header-left h1{font-family:'DM Sans',sans-serif;font-size:1.35rem;font-weight:700;color:var(--text);letter-spacing:-.3px}
.header-left h1 .brand-accent{color:var(--accent-light);font-family:'Playfair Display',serif;font-weight:800;letter-spacing:1px}
.header-left .subtitle{color:var(--text-muted);font-size:.8rem;margin-top:2px;font-weight:500}
.header-right{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.user-badge{display:flex;align-items:center;gap:7px;padding:5px 12px;border-radius:8px;background:var(--accent-muted);border:1px solid var(--border);font-size:.82rem;font-weight:500;transition:border-color .15s ease}
.user-badge:hover{border-color:var(--border-hover)}
.ub-avatar{width:24px;height:24px;border-radius:6px;background:var(--accent);display:flex;align-items:center;justify-content:center;font-size:.7rem;font-weight:700;color:var(--bg)}
.ub-role{font-size:.65rem;font-weight:600;text-transform:uppercase;letter-spacing:.5px;padding:2px 6px;border-radius:4px}
.hdr-btn{padding:6px 14px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text-secondary);font-family:'DM Sans',sans-serif;font-size:.8rem;font-weight:500;cursor:pointer;transition:all .15s ease;display:flex;align-items:center;gap:5px}
.hdr-btn:hover{border-color:var(--border-hover);color:var(--text);background:var(--surface-hover)}
.logout-btn:hover{border-color:rgba(239,83,80,.3)!important;color:var(--overdue)!important;background:var(--overdue-bg)!important}

.stats-row{display:flex;gap:4px;margin-top:14px;flex-wrap:wrap}
.stat{display:flex;align-items:center;gap:5px;font-size:.78rem;color:var(--text-secondary);padding:4px 10px;border-radius:var(--radius-sm);background:var(--surface);border:1px solid var(--border);transition:border-color .15s ease}
.stat:hover{border-color:var(--border-hover)}
.stat-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0}
.stat strong{color:var(--text);font-weight:600;font-variant-numeric:tabular-nums}

.team-bar{display:flex;gap:6px;margin-top:10px;flex-wrap:wrap;align-items:center}
.team-bar-label{font-size:.7rem;font-weight:600;text-transform:uppercase;letter-spacing:.8px;color:var(--text-muted);margin-right:2px}
.team-chip{display:flex;align-items:center;gap:5px;padding:4px 12px;border-radius:var(--radius-sm);background:var(--surface);border:1px solid var(--border);font-size:.78rem;font-weight:500;color:var(--text-secondary);transition:all .15s ease;cursor:pointer}
.team-chip:hover{border-color:var(--accent);color:var(--text);background:var(--accent-muted)}
.team-chip.active{background:var(--accent);border-color:var(--accent);color:var(--bg)}
.team-chip.active .chip-count{background:var(--bg);color:var(--accent)}
.chip-count{background:var(--accent);color:var(--bg);font-size:.68rem;font-weight:700;width:18px;height:18px;border-radius:4px;display:flex;align-items:center;justify-content:center}

.filter-bar{display:flex;gap:6px;align-items:center;flex-wrap:wrap;margin-top:10px}
.filter-btn{padding:5px 14px;border-radius:var(--radius-sm);border:1px solid var(--border);background:transparent;color:var(--text-secondary);font-family:'DM Sans',sans-serif;font-size:.78rem;font-weight:500;cursor:pointer;transition:all .15s ease}
.filter-btn:hover{border-color:var(--border-hover);color:var(--text);background:var(--surface-hover)}
.filter-btn.active{background:var(--accent);border-color:var(--accent);color:var(--bg);font-weight:600}
.add-project-btn{padding:5px 14px;border-radius:var(--radius-sm);border:1px dashed var(--accent);background:transparent;color:var(--accent);font-family:'DM Sans',sans-serif;font-size:.78rem;font-weight:600;cursor:pointer;transition:all .15s ease;display:inline-flex;align-items:center;gap:4px}
.add-project-btn:hover{background:var(--accent-muted)}
.backlog-btn{padding:5px 14px;border-radius:var(--radius-sm);border:1px solid rgba(66,165,245,.3);background:transparent;color:var(--weekly);font-family:'DM Sans',sans-serif;font-size:.78rem;font-weight:600;cursor:pointer;transition:all .15s ease;display:inline-flex;align-items:center;gap:4px}
.backlog-btn:hover{background:var(--weekly-bg)}
.backlog-btn.active{background:var(--weekly);color:var(--bg)}

.main{padding:24px 32px 48px}

/* PROJECT & TASKS */
.project{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:16px;overflow:hidden;animation:fadeUp .35s cubic-bezier(.16,1,.3,1) both;transition:border-color .15s ease,box-shadow .15s ease;position:relative}
.project::before{content:'';position:absolute;inset:0;border-radius:var(--radius);padding:1px;background:linear-gradient(180deg,rgba(255,255,255,.04) 0%,transparent 40%);-webkit-mask:linear-gradient(#fff 0 0) content-box,linear-gradient(#fff 0 0);-webkit-mask-composite:xor;mask-composite:exclude;pointer-events:none}
.project:hover{border-color:var(--border-hover);box-shadow:var(--shadow-sm)}
@keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}
.project-header{display:flex;justify-content:space-between;align-items:center;padding:14px 20px;cursor:pointer;user-select:none;transition:background .15s ease}
.project-header:hover{background:var(--surface-hover)}
.project-title-area{display:flex;align-items:center;gap:12px}
.project-icon{width:34px;height:34px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:1rem;font-weight:700;color:var(--bg);flex-shrink:0}
.project-name{font-size:1rem;font-weight:600;letter-spacing:-.2px}
.project-count{font-size:.75rem;color:var(--text-muted);font-weight:500;margin-left:2px}
.project-right{display:flex;align-items:center;gap:8px}
.project-progress{display:flex;align-items:center;gap:8px}
.progress-bar{width:80px;height:4px;background:rgba(255,255,255,.06);border-radius:2px;overflow:hidden}
.progress-fill{height:100%;background:var(--accent);border-radius:2px;transition:width .5s ease}
.progress-text{font-size:.75rem;color:var(--text-muted);font-weight:500;min-width:28px;text-align:right;font-variant-numeric:tabular-nums}
.chevron{color:var(--text-muted);transition:transform .2s ease;font-size:.8rem;margin-left:2px}
.project.collapsed .chevron{transform:rotate(-90deg)}
.project.collapsed .task-list{display:none}
.icon-btn{background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:.9rem;padding:4px 6px;border-radius:var(--radius-sm);transition:all .15s ease;display:flex;align-items:center;justify-content:center}
.icon-btn:hover{background:var(--surface-hover);color:var(--text)}
.icon-btn.danger:hover{background:var(--overdue-bg);color:var(--overdue)}

.task-list{border-top:1px solid var(--border)}
.task-row{display:grid;grid-template-columns:36px 1fr 140px 120px 110px 100px 32px;align-items:center;padding:11px 20px;border-bottom:1px solid var(--border);transition:background .15s ease;gap:6px}
.task-row:hover{background:var(--surface-hover)}
.task-row.done{background:var(--done-bg)}.task-row.done .task-text{text-decoration:line-through;color:var(--text-muted)}
.task-row.in-progress{background:var(--progress-bg)}
.task-row.overdue-row{background:var(--overdue-bg)}
.task-row.my-task{border-left:2px solid var(--accent);background:var(--my-task)}
.task-row.my-task:hover{background:rgba(201,164,108,.08)}
.task-row.my-task.done{background:var(--done-bg);border-left-color:var(--done)}
.task-row.my-task.in-progress{background:var(--progress-bg);border-left-color:var(--progress)}
.task-row.my-task.overdue-row{background:var(--overdue-bg);border-left-color:var(--overdue)}

.checkbox{width:18px;height:18px;border-radius:5px;border:1.5px solid var(--border-strong);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .15s ease;flex-shrink:0;-webkit-tap-highlight-color:transparent}
.checkbox:hover{border-color:var(--accent);background:var(--accent-muted)}
.checkbox.checked{background:var(--done);border-color:var(--done)}
.checkbox.checked::after{content:'✓';color:white;font-size:.7rem;font-weight:700}

.task-text-wrap{display:flex;align-items:center;gap:8px;min-width:0}
.task-text{font-size:.875rem;font-weight:500;line-height:1.4;transition:color .15s ease;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.overdue-icon{color:var(--overdue);font-size:.85rem;font-weight:700;display:flex;align-items:center;gap:3px;flex-shrink:0}
.overdue-icon .overdue-tip{font-size:.68rem;font-weight:600;color:var(--overdue);white-space:nowrap}

.deadline-cell{display:flex;align-items:center;gap:5px;cursor:pointer;position:relative}
.deadline-badge{font-size:.75rem;font-weight:600;padding:3px 8px;border-radius:4px;text-align:center;width:fit-content;white-space:nowrap}
.deadline-today{background:var(--today-bg);color:var(--today)}
.deadline-tomorrow{background:var(--tomorrow-bg);color:var(--tomorrow)}
.deadline-weekly{background:var(--weekly-bg);color:var(--weekly)}
.deadline-daily{background:var(--daily-bg);color:var(--daily)}
.deadline-pending{background:rgba(255,255,255,.04);color:var(--text-muted)}
.deadline-date{background:var(--accent-muted);color:var(--accent-light)}
.deadline-overdue{background:var(--overdue-bg);color:var(--overdue)}
.deadline-edit-icon{font-size:.68rem;color:var(--text-muted);opacity:0;transition:opacity .15s ease}
.deadline-cell:hover .deadline-edit-icon{opacity:1}

.deadline-popover{position:fixed;z-index:999;background:var(--surface-elevated);border:1px solid var(--border-hover);border-radius:var(--radius);padding:12px;box-shadow:var(--shadow-lg);display:none;min-width:200px;max-width:calc(100vw - 24px)}
.deadline-popover.show{display:block}
.deadline-popover select,.deadline-popover input{width:100%;padding:7px 10px;border-radius:var(--radius-sm);border:1px solid var(--border);background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;font-size:.85rem;margin-bottom:8px}
.deadline-popover input[type="date"]{color-scheme:dark}
.pop-actions{display:flex;gap:6px;justify-content:flex-end}
.pop-btn{padding:5px 14px;border-radius:var(--radius-sm);font-family:'DM Sans',sans-serif;font-size:.78rem;font-weight:600;cursor:pointer;border:none;transition:all .15s ease}
.pop-btn-save{background:var(--accent);color:var(--bg)}.pop-btn-save:hover{background:var(--accent-light)}
.pop-btn-cancel{background:transparent;border:1px solid var(--border);color:var(--text-muted)}

.priority-select{font-size:.75rem;font-weight:600;padding:3px 6px;border-radius:4px;border:1px solid transparent;background:transparent;font-family:'DM Sans',sans-serif;cursor:pointer;transition:all .15s ease;-webkit-appearance:none;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%235c6078'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 4px center;padding-right:18px}
.priority-select:hover{border-color:var(--border-hover)}
.priority-select option{background:var(--surface)}
.priority-select.p-high{color:var(--high)}.priority-select.p-medium{color:var(--medium)}.priority-select.p-low{color:var(--low)}
.status-select{font-size:.75rem;font-weight:500;padding:3px 6px;border-radius:4px;border:1px solid var(--border);background:transparent;color:var(--text-secondary);font-family:'DM Sans',sans-serif;cursor:pointer;transition:all .15s ease}
.status-select:hover{border-color:var(--border-hover)}
.status-select option{background:var(--surface);color:var(--text)}
.status-select.s-progress{border-color:rgba(255,167,38,.3);color:var(--progress)}
.status-select.s-done{border-color:rgba(102,187,106,.3);color:var(--done)}
.person-select{font-size:.78rem;font-weight:500;padding:3px 6px;border-radius:4px;border:1px solid var(--border);background:transparent;color:var(--text);font-family:'DM Sans',sans-serif;cursor:pointer;transition:all .15s ease;max-width:120px}
.person-select:hover{border-color:var(--border-hover)}
.person-select option{background:var(--surface);color:var(--text)}
.person-select:disabled,.priority-select:disabled,.status-select:disabled{opacity:.4;cursor:default;pointer-events:none}

.task-header{display:grid;grid-template-columns:36px 1fr 140px 120px 110px 100px 32px;padding:8px 20px;font-size:.7rem;font-weight:600;text-transform:uppercase;letter-spacing:.8px;color:var(--text-muted);border-bottom:1px solid var(--border);gap:6px}
.add-task-row{display:flex;align-items:center;gap:8px;padding:9px 20px;border-top:1px dashed var(--border);cursor:pointer;transition:background .15s ease}
.add-task-row:hover{background:var(--surface-hover)}
.add-icon{width:18px;height:18px;border-radius:5px;border:1.5px dashed rgba(255,255,255,.12);display:flex;align-items:center;justify-content:center;font-size:.8rem;color:var(--text-muted);font-weight:500;transition:all .15s ease}
.add-task-row:hover .add-icon{border-color:var(--accent);color:var(--accent)}
.add-task-label{font-size:.8rem;color:var(--text-muted);font-weight:500}
.add-task-row:hover .add-task-label{color:var(--accent)}

/* MODALS */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.6);backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;z-index:1000;opacity:0;pointer-events:none;transition:opacity .2s ease}
.modal-overlay.open{opacity:1;pointer-events:all}
.modal{background:var(--surface);border:1px solid var(--border-hover);border-radius:var(--radius-lg);width:520px;max-width:92vw;padding:0;transform:translateY(16px) scale(.98);transition:transform .25s cubic-bezier(.16,1,.3,1);box-shadow:var(--shadow-lg);max-height:90vh;overflow-y:auto}
.modal-overlay.open .modal{transform:translateY(0) scale(1)}
.modal-header{padding:20px 24px 14px;border-bottom:1px solid var(--border)}
.modal-header h2{font-size:1.1rem;font-weight:700;color:var(--text)}
.modal-header p{font-size:.82rem;color:var(--text-secondary);margin-top:3px}
.modal-body{padding:18px 24px 8px}
.field{margin-bottom:16px}
.field label{display:block;font-size:.72rem;font-weight:600;text-transform:uppercase;letter-spacing:.7px;color:var(--text-muted);margin-bottom:7px}
.field input,.field select,.field textarea{width:100%;padding:10px 14px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;font-size:16px;transition:border-color .15s ease,box-shadow .15s ease}
.field input:focus,.field select:focus,.field textarea:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-muted)}
.field select option{background:var(--bg);color:var(--text)}
.field-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.field input[type="date"]{color-scheme:dark}
.modal-footer{padding:14px 24px 20px;display:flex;justify-content:flex-end;gap:8px}
.btn{padding:9px 20px;border-radius:8px;font-family:'DM Sans',sans-serif;font-size:.85rem;font-weight:600;cursor:pointer;border:none;transition:all .15s ease}
.btn-cancel{background:transparent;border:1px solid var(--border);color:var(--text-secondary)}.btn-cancel:hover{border-color:var(--border-hover);color:var(--text);background:var(--surface-hover)}
.btn-add{background:var(--accent);color:var(--bg)}.btn-add:hover{background:var(--accent-light);transform:translateY(-1px);box-shadow:0 4px 12px rgba(201,164,108,.25)}
.btn-add:active{transform:translateY(0) scale(.98)}
.btn-danger{background:var(--overdue);color:white}.btn-danger:hover{background:#ff6680;transform:translateY(-1px)}.btn-danger:active{transform:translateY(0) scale(.98)}
.color-options{display:flex;gap:6px;flex-wrap:wrap}
.color-swatch{width:28px;height:28px;border-radius:6px;cursor:pointer;border:2px solid transparent;transition:all .15s ease}
.color-swatch:hover{transform:scale(1.12)}
.color-swatch.selected{border-color:white;box-shadow:0 0 0 2px var(--accent)}

/* SETTINGS */
.settings-section{margin-bottom:20px}
.settings-section h3{font-size:.82rem;font-weight:700;color:var(--text);margin-bottom:10px;text-transform:uppercase;letter-spacing:.5px}
.settings-user-row{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:var(--bg);border:1px solid var(--border);border-radius:8px;margin-bottom:6px;gap:10px;transition:border-color .15s ease}
.settings-user-row:hover{border-color:var(--border-hover)}
.settings-user-info{display:flex;align-items:center;gap:10px}
.settings-user-avatar{width:28px;height:28px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:.7rem;font-weight:700;color:var(--bg);flex-shrink:0}
.settings-user-name{font-size:.85rem;font-weight:600}
.settings-user-pass{font-size:.75rem;color:var(--text-muted);font-family:'DM Sans',monospace}
.settings-remove-btn{background:none;border:1px solid var(--border);color:var(--text-secondary);padding:4px 10px;border-radius:var(--radius-sm);font-size:.75rem;cursor:pointer;transition:all .15s ease;font-family:'DM Sans',sans-serif}
.settings-remove-btn:hover{border-color:rgba(239,83,80,.3);color:var(--overdue);background:var(--overdue-bg)}
.settings-add-row{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
.settings-add-row input,.settings-add-row select{flex:1;min-width:80px;padding:8px 12px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;font-size:.85rem;transition:border-color .15s ease}
.settings-add-row input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-muted)}
.settings-add-btn{padding:8px 16px;border-radius:8px;border:none;background:var(--accent);color:var(--bg);font-family:'DM Sans',sans-serif;font-size:.8rem;font-weight:600;cursor:pointer;transition:all .15s ease}
.settings-add-btn:hover{background:var(--accent-light)}
.vis-project-row{display:flex;align-items:center;justify-content:space-between;padding:8px 14px;background:var(--bg);border:1px solid var(--border);border-radius:8px;margin-bottom:6px}
.vis-project-name{font-size:.85rem;font-weight:500}
.vis-toggles{display:flex;gap:4px;flex-wrap:wrap}
.vis-toggle{padding:3px 8px;border-radius:4px;font-size:.7rem;font-weight:600;border:1px solid var(--border);background:transparent;color:var(--text-muted);cursor:pointer;transition:all .15s ease}
.vis-toggle.on{background:var(--accent);border-color:var(--accent);color:var(--bg)}
.vis-toggle:hover{border-color:var(--accent);color:var(--accent)}

/* BACKLOG */
.backlog-section{margin-bottom:24px}
.backlog-user-header{display:flex;align-items:center;gap:10px;margin-bottom:10px;padding:12px 16px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);transition:border-color .15s ease}
.backlog-user-header:hover{border-color:var(--border-hover)}
.backlog-avatar{width:32px;height:32px;border-radius:8px;background:var(--accent);display:flex;align-items:center;justify-content:center;font-size:.75rem;font-weight:700;color:var(--bg)}
.backlog-name{font-size:.95rem;font-weight:700}
.backlog-count{font-size:.78rem;color:var(--text-muted);margin-left:4px}
.backlog-task{display:flex;align-items:center;gap:10px;padding:9px 16px;background:var(--surface);border:1px solid var(--border);border-radius:8px;margin-bottom:4px;font-size:.85rem;transition:border-color .15s ease}
.backlog-task:hover{border-color:var(--border-hover)}
.backlog-task .bt-check{color:var(--done);font-weight:700;font-size:.78rem}
.backlog-task .bt-text{flex:1;color:var(--text-muted);text-decoration:line-through}
.backlog-task .bt-project{font-size:.7rem;padding:2px 7px;border-radius:4px;font-weight:600;white-space:nowrap}
.backlog-task .bt-date{font-size:.72rem;color:var(--text-muted)}
.backlog-empty{color:var(--text-muted);font-size:.85rem;font-style:italic;padding:12px 16px}

/* KPI Cards */
.kpi-row{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:12px}
.kpi-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px 16px;display:flex;flex-direction:column;gap:3px;transition:border-color .15s ease,box-shadow .15s ease;position:relative;overflow:hidden}
.kpi-card::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.06),transparent)}
.kpi-card:hover{border-color:var(--border-hover);box-shadow:var(--shadow-sm)}
.kpi-label{font-size:.68rem;font-weight:600;text-transform:uppercase;letter-spacing:.7px;color:var(--text-muted)}
.kpi-value{font-size:1.4rem;font-weight:700;line-height:1.2;font-variant-numeric:tabular-nums}
.kpi-sub{font-size:.72rem;color:var(--text-muted);font-weight:500}
.kpi-value.kpi-green{color:var(--done)}
.kpi-value.kpi-red{color:var(--overdue)}
.kpi-value.kpi-gold{color:var(--accent-light)}
.kpi-value.kpi-blue{color:var(--weekly)}
.kpi-bar{width:100%;height:4px;background:rgba(255,255,255,.04);border-radius:2px;margin-top:6px;overflow:hidden}
.kpi-bar-fill{height:100%;border-radius:2px;transition:width .5s ease}
.backlog-task .bt-undo{background:none;border:1px solid var(--border);color:var(--text-secondary);padding:3px 8px;border-radius:4px;font-size:.7rem;cursor:pointer;transition:all .15s ease;font-family:'DM Sans',sans-serif;white-space:nowrap}
.backlog-task .bt-undo:hover{border-color:var(--accent);color:var(--accent);background:var(--accent-muted)}

/* VIEW TOGGLE */
.view-toggle{display:flex;gap:0;background:var(--bg);border:1px solid var(--border);border-radius:8px;overflow:hidden;padding:2px}
.view-toggle-btn{padding:5px 14px;border:none;background:transparent;color:var(--text-secondary);font-family:'DM Sans',sans-serif;font-size:.78rem;font-weight:600;cursor:pointer;transition:all .15s ease;display:flex;align-items:center;gap:5px;border-radius:6px}
.view-toggle-btn:hover{color:var(--text);background:var(--surface-hover)}
.view-toggle-btn.active{background:var(--accent);color:var(--bg)}

/* FINANCIAL DASHBOARD */
.fin-upload-area{border:1.5px dashed var(--border-strong);border-radius:var(--radius);padding:36px 28px;text-align:center;transition:all .2s ease;cursor:pointer;background:var(--surface);margin-bottom:24px}
.fin-upload-area:hover,.fin-upload-area.dragover{border-color:var(--accent);background:var(--accent-muted)}
.fin-upload-icon{font-size:2rem;margin-bottom:8px;opacity:.5}
.fin-upload-title{font-size:.95rem;font-weight:600;color:var(--text);margin-bottom:3px}
.fin-upload-sub{font-size:.8rem;color:var(--text-secondary)}
.fin-upload-input{display:none}

.fin-business-tabs{display:flex;gap:6px;margin-bottom:20px;flex-wrap:wrap;align-items:center}
.fin-tab{padding:6px 14px;border-radius:var(--radius-sm);border:1px solid var(--border);background:transparent;color:var(--text-secondary);font-family:'DM Sans',sans-serif;font-size:.8rem;font-weight:600;cursor:pointer;transition:all .15s ease;display:flex;align-items:center;gap:5px}
.fin-tab:hover{border-color:var(--border-hover);color:var(--text);background:var(--surface-hover)}
.fin-tab.active{background:var(--accent);border-color:var(--accent);color:var(--bg)}
.fin-tab .tab-remove{font-size:.68rem;opacity:.5;margin-left:2px;transition:opacity .15s ease}
.fin-tab:hover .tab-remove{opacity:1}
.fin-overview-tab{border-color:rgba(171,71,188,.3);color:#ab47bc}
.fin-overview-tab:hover{background:rgba(171,71,188,.08)}
.fin-overview-tab.active{background:#ab47bc;color:var(--bg);border-color:#ab47bc}

.fin-kpi-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:24px}
.fin-kpi{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:18px;transition:border-color .15s ease,box-shadow .15s ease;position:relative;overflow:hidden}
.fin-kpi::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.06),transparent)}
.fin-kpi:hover{border-color:var(--border-hover);box-shadow:var(--shadow-sm)}
.fin-kpi-label{font-size:.68rem;font-weight:600;text-transform:uppercase;letter-spacing:.7px;color:var(--text-muted);margin-bottom:8px}
.fin-kpi-value{font-size:1.6rem;font-weight:700;line-height:1.1;margin-bottom:4px;font-variant-numeric:tabular-nums}
.fin-kpi-sub{font-size:.75rem;color:var(--text-secondary);font-weight:500;display:flex;align-items:center;gap:4px}
.fin-kpi-sub .up{color:var(--done)}.fin-kpi-sub .down{color:var(--overdue)}
.fin-kpi-value.green{color:var(--done)}.fin-kpi-value.red{color:var(--overdue)}.fin-kpi-value.gold{color:var(--accent-light)}.fin-kpi-value.blue{color:var(--weekly)}.fin-kpi-value.purple{color:#ab47bc}

.fin-charts-row{display:grid;grid-template-columns:2fr 1fr;gap:16px;margin-bottom:24px}
.fin-chart-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px;overflow:hidden;transition:border-color .15s ease}
.fin-chart-card:hover{border-color:var(--border-hover)}
.fin-chart-title{font-size:.85rem;font-weight:700;margin-bottom:14px;color:var(--text)}
.fin-chart-wrap{position:relative;width:100%;height:280px}
.fin-chart-wrap canvas{width:100%!important;height:100%!important}

.fin-details-table{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;margin-bottom:24px}
.fin-details-title{padding:14px 20px;font-size:.85rem;font-weight:700;border-bottom:1px solid var(--border)}
.fin-details-row{display:grid;grid-template-columns:var(--fin-detail-cols,200px repeat(auto-fill,minmax(90px,1fr)));padding:9px 20px;border-bottom:1px solid var(--border);font-size:.82rem;gap:8px;align-items:center;font-variant-numeric:tabular-nums}
.fin-details-row:hover{background:var(--surface-hover)}
.fin-details-row.header{font-size:.7rem;font-weight:600;text-transform:uppercase;letter-spacing:.7px;color:var(--text-muted)}
.fin-details-row.total{font-weight:700;background:var(--accent-muted);border-top:1px solid var(--border-strong)}
.fin-details-row .label{font-weight:600;color:var(--text)}.fin-details-row .sub-label{color:var(--text-secondary);padding-left:16px}
.fin-details-row .neg{color:var(--overdue)}.fin-details-row .pos{color:var(--done)}

.fin-empty{text-align:center;padding:60px 32px;color:var(--text-secondary)}
.fin-empty-icon{font-size:2.5rem;margin-bottom:10px;opacity:.35}
.fin-empty-title{font-size:1rem;font-weight:600;color:var(--text);margin-bottom:5px}
.fin-empty-sub{font-size:.85rem;color:var(--text-secondary)}

/* ═══ RESPONSIVE ═══ */

/* Tablet */
@media(max-width:900px){
  .header{padding:16px 20px 14px}
  .main{padding:20px 20px 40px}
  .header-left h1{font-size:1.2rem}
  .login-card{padding:32px 24px}
  .task-row,.task-header{grid-template-columns:32px 1fr 120px 100px 100px 90px 28px;gap:5px}
  .task-row{padding:10px 16px}
  .task-header{padding:7px 16px}
  .project-header{padding:12px 16px}
  .fin-kpi-grid{gap:10px}
  .fin-kpi{padding:14px}
}

/* Mobile */
@media(max-width:640px){
  .header{padding:14px 14px 12px}
  .main{padding:14px 12px 36px}
  .header-left h1{font-size:1.1rem}
  .header-left .subtitle{font-size:.75rem}
  .header-top{gap:8px}
  .header-right{gap:6px;width:100%;justify-content:flex-end}
  .user-badge{padding:4px 8px;font-size:.75rem}
  .ub-avatar{width:20px;height:20px;font-size:.62rem;border-radius:5px}
  .ub-role{font-size:.6rem;padding:1px 5px}
  .hdr-btn{padding:5px 10px;font-size:.75rem}

  /* Stats row: wrap tightly */
  .stats-row{gap:3px;margin-top:10px;flex-wrap:wrap}
  .stat{font-size:.72rem;padding:3px 7px}
  .stat-dot{width:5px;height:5px}

  /* Team & filter bars */
  .team-bar{gap:4px;margin-top:8px}
  .team-chip{padding:3px 8px;font-size:.72rem}
  .chip-count{width:16px;height:16px;font-size:.6rem;border-radius:3px}
  .filter-bar{gap:4px;margin-top:8px}
  .filter-btn{padding:4px 10px;font-size:.72rem}
  .add-project-btn,.backlog-btn{padding:4px 10px;font-size:.72rem}

  /* Project cards */
  .project{border-radius:8px;margin-bottom:10px}
  .project-header{padding:10px 12px;flex-wrap:wrap;gap:6px}
  .project-title-area{gap:8px}
  .project-icon{width:28px;height:28px;font-size:.82rem;border-radius:6px}
  .project-name{font-size:.88rem}
  .project-count{font-size:.68rem}
  .progress-bar{width:50px;height:3px}
  .progress-text{font-size:.68rem}
  .chevron{font-size:.7rem}

  /* Task rows: stacked layout */
  .task-header{display:none}
  .task-row{display:flex;flex-wrap:wrap;gap:6px 8px;padding:10px 12px;align-items:center}
  .task-row>div:first-child{flex:0 0 auto}
  .task-text-wrap{flex:1 1 calc(100% - 36px);min-width:0}
  .task-text{font-size:.82rem;white-space:normal}
  .overdue-icon{font-size:.78rem}
  .overdue-icon .overdue-tip{font-size:.6rem}

  .deadline-cell,.task-row>div:nth-child(4),.task-row>div:nth-child(5),.task-row>div:nth-child(6){flex:0 0 auto}
  .deadline-badge{font-size:.68rem;padding:2px 6px}
  .person-select{font-size:.72rem;padding:2px 4px;max-width:90px}
  .priority-select{font-size:.68rem;padding:2px 4px;padding-right:16px}
  .status-select{font-size:.68rem;padding:2px 4px}
  .task-row>div:last-child{flex:0 0 auto;margin-left:auto}

  .add-task-row{padding:8px 12px}
  .add-icon{width:16px;height:16px;font-size:.75rem}
  .add-task-label{font-size:.75rem}

  /* Deadline popover */
  .deadline-popover{min-width:180px;padding:10px;left:auto;right:0}

  /* Modals: bottom sheet on mobile */
  .modal{width:100%;max-width:100vw;border-radius:var(--radius-lg) var(--radius-lg) 0 0;margin-top:auto;max-height:85vh}
  .modal-overlay.open{align-items:flex-end}
  .modal-header{padding:16px 18px 12px}
  .modal-header h2{font-size:1rem}
  .modal-body{padding:12px 18px 8px}
  .modal-footer{padding:10px 18px 18px}
  .field label{font-size:.7rem}
  .field input,.field select,.field textarea{padding:9px 12px;font-size:16px}
  .field-row{grid-template-columns:1fr;gap:8px}
  .btn{padding:8px 16px;font-size:.82rem}

  /* Settings */
  .settings-user-row{flex-direction:column;align-items:flex-start;gap:8px;padding:10px 12px}
  .settings-user-row>div:last-child{width:100%;display:flex;gap:4px}
  .settings-user-row>div:last-child .settings-remove-btn{flex:1}
  .settings-add-row{flex-direction:column}
  .settings-add-row input,.settings-add-row select{width:100%;min-width:unset}
  .vis-project-row{flex-direction:column;align-items:flex-start;gap:5px;padding:8px 12px}
  .vis-toggles{gap:3px}
  .vis-toggle{font-size:.68rem;padding:2px 6px}

  /* Backlog */
  .backlog-user-header{padding:10px 12px}
  .backlog-avatar{width:26px;height:26px;font-size:.68rem;border-radius:6px}
  .backlog-name{font-size:.88rem}
  .backlog-task{padding:8px 12px;gap:6px;flex-wrap:wrap}
  .backlog-task .bt-text{font-size:.78rem}
  .backlog-task .bt-project{font-size:.68rem}
  .kpi-row{grid-template-columns:repeat(2,1fr);gap:6px;margin-bottom:10px}
  .kpi-card{padding:10px 12px}
  .kpi-value{font-size:1.15rem}
  .kpi-label{font-size:.62rem}

  /* Financial */
  .fin-kpi-grid{grid-template-columns:repeat(2,1fr);gap:8px}
  .fin-kpi{padding:12px}
  .fin-kpi-value{font-size:1.2rem}
  .fin-kpi-label{font-size:.62rem}
  .fin-charts-row{grid-template-columns:1fr;gap:12px}
  .fin-chart-wrap{height:200px}
  .fin-upload-area{padding:24px 16px}
  .fin-details-row{grid-template-columns:130px repeat(auto-fill,minmax(65px,1fr));font-size:.74rem;padding:7px 12px}
  .view-toggle-btn{padding:5px 10px;font-size:.72rem}
  .view-toggle{padding:1px}

  /* Login */
  .login-card{padding:28px 20px;width:100%;max-width:100vw;border-radius:var(--radius-lg);margin:12px}
  .login-logo{font-size:1.5rem}
  .login-sub{font-size:.8rem;margin-bottom:24px}
  .login-field input{padding:11px 14px;font-size:16px}
  .login-btn{padding:12px;font-size:.9rem}
}

/* Small phones */
@media(max-width:380px){
  .header{padding:12px 10px 10px}
  .main{padding:10px 8px 32px}
  .header-left h1{font-size:1rem}
  .stats-row{gap:3px}
  .stat{font-size:.68rem;padding:2px 5px}
  .project-header{padding:8px 10px}
  .task-row{padding:8px 10px;gap:5px 6px}
  .task-text{font-size:.78rem}
  .person-select,.priority-select,.status-select{font-size:.66rem}
  .modal{border-radius:12px 12px 0 0}
  .kpi-row{gap:4px}
  .kpi-card{padding:8px 10px}
  .kpi-value{font-size:1rem}
}

/* ═══ ANIMATED BACKGROUND ═══ */
.bg-mesh{position:fixed;inset:0;z-index:-1;overflow:hidden;pointer-events:none}
.bg-orb{position:absolute;border-radius:50%;filter:blur(80px);opacity:.12;animation:orbFloat 20s ease-in-out infinite}
.bg-orb:nth-child(1){width:500px;height:500px;background:var(--accent);top:-10%;left:-10%;animation-delay:0s}
.bg-orb:nth-child(2){width:400px;height:400px;background:#42a5f5;bottom:-10%;right:-10%;animation-delay:-7s}
.bg-orb:nth-child(3){width:350px;height:350px;background:#ab47bc;top:50%;left:50%;transform:translate(-50%,-50%);animation-delay:-14s}
@keyframes orbFloat{0%,100%{transform:translate(0,0) scale(1)}25%{transform:translate(30px,-40px) scale(1.1)}50%{transform:translate(-20px,30px) scale(.95)}75%{transform:translate(40px,20px) scale(1.05)}}

/* ═══ GLASSMORPHISM ═══ */
.glass{background:rgba(19,22,32,.65)!important;backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px)}
.header{background:rgba(19,22,32,.7)!important;backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px)}

/* ═══ TOAST NOTIFICATIONS ═══ */
.toast-container{position:fixed;top:20px;right:20px;z-index:9000;display:flex;flex-direction:column;gap:8px;pointer-events:none}
.toast{display:flex;align-items:center;gap:10px;padding:12px 18px;border-radius:10px;font-size:.85rem;font-weight:500;pointer-events:all;transform:translateX(120%);opacity:0;transition:all .3s cubic-bezier(.16,1,.3,1);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);border:1px solid var(--border-hover);box-shadow:var(--shadow-lg);max-width:340px}
.toast.show{transform:translateX(0);opacity:1}
.toast-icon{font-size:1rem;flex-shrink:0;width:24px;height:24px;display:flex;align-items:center;justify-content:center;border-radius:50%;font-size:.75rem;font-weight:700}
.toast-success{background:rgba(102,187,106,.12);color:var(--done)}.toast-success .toast-icon{background:var(--done);color:var(--bg)}
.toast-error{background:rgba(239,83,80,.12);color:var(--overdue)}.toast-error .toast-icon{background:var(--overdue);color:white}
.toast-warning{background:rgba(255,167,38,.12);color:var(--tomorrow)}.toast-warning .toast-icon{background:var(--tomorrow);color:var(--bg)}
.toast-info{background:rgba(66,165,245,.12);color:var(--weekly)}.toast-info .toast-icon{background:var(--weekly);color:var(--bg)}

/* ═══ ACTIVITY LOG ═══ */
.activity-list{max-height:400px;overflow-y:auto}
.activity-item{display:flex;gap:12px;padding:10px 0;border-bottom:1px solid var(--border);align-items:flex-start}
.activity-item:last-child{border-bottom:none}
.activity-dot{width:8px;height:8px;border-radius:50%;background:var(--accent);flex-shrink:0;margin-top:6px}
.activity-content{flex:1;min-width:0}
.activity-action{font-size:.85rem;font-weight:500;color:var(--text)}
.activity-action strong{color:var(--accent-light);font-weight:600}
.activity-detail{font-size:.78rem;color:var(--text-secondary);margin-top:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.activity-time{font-size:.7rem;color:var(--text-muted);flex-shrink:0;margin-top:3px}

/* ═══ KANBAN VIEW ═══ */
.kanban-board{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;min-height:400px}
.kanban-col{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px;display:flex;flex-direction:column;backdrop-filter:blur(12px);-webkit-backdrop-filter:blur(12px)}
.kanban-col-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;padding-bottom:10px;border-bottom:1px solid var(--border)}
.kanban-col-title{font-size:.82rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px;display:flex;align-items:center;gap:8px}
.kanban-col-count{font-size:.72rem;font-weight:600;background:var(--border-strong);color:var(--text-secondary);padding:1px 7px;border-radius:4px}
.kanban-col-todo .kanban-col-title{color:var(--text-secondary)}
.kanban-col-progress .kanban-col-title{color:var(--progress)}
.kanban-col-done .kanban-col-title{color:var(--done)}
.kanban-cards{flex:1;display:flex;flex-direction:column;gap:6px;min-height:60px}
.kanban-card{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:10px 12px;cursor:grab;transition:all .15s ease;position:relative}
.kanban-card:hover{border-color:var(--border-hover);box-shadow:var(--shadow-sm);transform:translateY(-1px)}
.kanban-card:active{cursor:grabbing;box-shadow:var(--shadow-md);transform:scale(1.02)}
.kanban-card-title{font-size:.82rem;font-weight:500;margin-bottom:6px;line-height:1.3}
.kanban-card-meta{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
.kanban-card-meta .deadline-badge{font-size:.68rem;padding:1px 6px}
.kanban-card-project{font-size:.65rem;font-weight:600;padding:1px 6px;border-radius:3px;white-space:nowrap}
.kanban-card-person{font-size:.7rem;color:var(--text-secondary);margin-left:auto}
.kanban-card.my-task{border-left:2px solid var(--accent)}
.kanban-card.overdue-card{border-left:2px solid var(--overdue)}
.sortable-ghost{opacity:.3}
.sortable-drag{box-shadow:var(--shadow-lg)!important;transform:rotate(2deg)!important}
.kanban-empty{font-size:.78rem;color:var(--text-muted);text-align:center;padding:20px 8px;font-style:italic;border:1px dashed var(--border);border-radius:8px}

/* View toggle for list/kanban */
.task-view-toggle{display:flex;gap:0;background:var(--bg);border:1px solid var(--border);border-radius:8px;overflow:hidden;padding:2px;margin-left:auto}
.task-view-btn{padding:4px 12px;border:none;background:transparent;color:var(--text-muted);font-family:'DM Sans',sans-serif;font-size:.72rem;font-weight:600;cursor:pointer;transition:all .15s ease;border-radius:6px;display:flex;align-items:center;gap:4px}
.task-view-btn:hover{color:var(--text)}
.task-view-btn.active{background:var(--accent);color:var(--bg)}

/* ═══ ANIMATED COUNTERS ═══ */
.counter-animate{display:inline-block;transition:all .4s cubic-bezier(.16,1,.3,1)}

/* ═══ PAGE TRANSITIONS ═══ */
.view-fade{animation:viewFadeIn .35s cubic-bezier(.16,1,.3,1) both}
@keyframes viewFadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

/* ═══ STAGGER ANIMATIONS ═══ */
.project:nth-child(1){animation-delay:.05s}
.project:nth-child(2){animation-delay:.1s}
.project:nth-child(3){animation-delay:.15s}
.project:nth-child(4){animation-delay:.2s}
.project:nth-child(5){animation-delay:.25s}
.project:nth-child(6){animation-delay:.3s}
.project:nth-child(7){animation-delay:.35s}

/* ═══ ENHANCED HOVER EFFECTS ═══ */
.project:hover{border-color:var(--border-hover);box-shadow:var(--shadow-sm),0 0 20px rgba(201,164,108,.04)}
.kpi-card:hover,.fin-kpi:hover{box-shadow:var(--shadow-sm),0 0 20px rgba(201,164,108,.04)}
.login-card:hover{box-shadow:var(--shadow-lg),0 0 40px rgba(201,164,108,.06)}

/* Kanban responsive */
@media(max-width:900px){.kanban-board{grid-template-columns:1fr;gap:12px}.kanban-col{min-height:auto}}
@media(max-width:640px){
  .toast-container{top:12px;right:12px;left:12px}
  .toast{max-width:100%;font-size:.8rem;padding:10px 14px}
  .kanban-card-title{font-size:.78rem}
  .kanban-card-meta .deadline-badge{font-size:.62rem}
}

/* Reduce motion for accessibility */
@media(prefers-reduced-motion:reduce){
  *,*::before,*::after{animation-duration:.01ms!important;transition-duration:.01ms!important}
  .bg-orb{animation:none!important}
}

/* ═══ LIGHT THEME ═══ */
body.light-theme{--bg:#f4f5f7;--surface:#ffffff;--surface-hover:#f0f1f3;--surface-elevated:#ffffff;--border:rgba(0,0,0,.08);--border-hover:rgba(0,0,0,.14);--border-strong:rgba(0,0,0,.18);--text:#1a1c24;--text-secondary:#5c6078;--text-muted:#8b8fa3;--accent:#b08a3e;--accent-light:#8b6d2e;--accent-muted:rgba(176,138,62,.10);--my-task:rgba(176,138,62,.06);--shadow-sm:0 1px 3px rgba(0,0,0,.08);--shadow-md:0 4px 12px rgba(0,0,0,.1);--shadow-lg:0 8px 24px rgba(0,0,0,.12)}
body.light-theme .bg-orb{opacity:.04}
body.light-theme .login-page{background:radial-gradient(ellipse at 30% 20%,rgba(176,138,62,.06) 0%,transparent 60%),var(--bg)}
body.light-theme .header{background:rgba(255,255,255,.85)!important;backdrop-filter:blur(20px)}
body.light-theme .glass{background:rgba(255,255,255,.75)!important}
body.light-theme .priority-select{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%235c6078'/%3E%3C/svg%3E")}
body.light-theme .kanban-card{background:var(--surface)}
body.light-theme ::-webkit-scrollbar-thumb{background:rgba(0,0,0,.12)}
body.light-theme .deadline-popover select,body.light-theme .deadline-popover input,body.light-theme .field input,body.light-theme .field select{color-scheme:light}
body.light-theme .login-field input{background:var(--surface);border-color:var(--border-strong)}
body.light-theme .splash{background:radial-gradient(ellipse at 50% 40%,#e8e9ed 0%,var(--bg) 70%)}
body.light-theme .splash-title,body.light-theme .splash-m svg path,body.light-theme .splash-m svg rect{color:var(--accent);stroke:var(--accent)}
body.light-theme .splash-glow{background:radial-gradient(circle,rgba(176,138,62,.12) 0%,transparent 70%)}

/* ═══ EXECUTIVE DASHBOARD ═══ */
.exec-dash{animation:viewFadeIn .35s cubic-bezier(.16,1,.3,1) both}
.exec-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px}
.exec-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:18px;position:relative;overflow:hidden;transition:border-color .15s ease,box-shadow .15s ease}
.exec-card::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.06),transparent)}
.exec-card:hover{border-color:var(--border-hover);box-shadow:var(--shadow-sm)}
.exec-card-label{font-size:.68rem;font-weight:600;text-transform:uppercase;letter-spacing:.7px;color:var(--text-muted);margin-bottom:8px}
.exec-card-value{font-size:1.6rem;font-weight:700;line-height:1.1;margin-bottom:4px;font-variant-numeric:tabular-nums}
.exec-card-sub{font-size:.75rem;color:var(--text-secondary);font-weight:500}
.exec-sparkline{width:100%;height:40px;margin-top:8px}
.exec-section-title{font-size:.85rem;font-weight:700;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid var(--border);color:var(--text)}
.exec-two-col{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px}
.exec-project-row{display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);margin-bottom:6px;transition:border-color .15s ease}
.exec-project-row:hover{border-color:var(--border-hover)}
.exec-project-dot{width:10px;height:10px;border-radius:3px;flex-shrink:0}
.exec-project-name{font-size:.85rem;font-weight:600;flex:1}
.exec-project-stat{font-size:.78rem;color:var(--text-secondary)}
@media(max-width:900px){.exec-grid{grid-template-columns:repeat(2,1fr)}.exec-two-col{grid-template-columns:1fr}}
@media(max-width:640px){.exec-grid{grid-template-columns:1fr 1fr;gap:8px}.exec-card{padding:14px}.exec-card-value{font-size:1.2rem}}

/* ═══ NOTIFICATION BELL ═══ */
.notif-btn{position:relative;padding:6px 10px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text-secondary);font-size:1rem;cursor:pointer;transition:all .15s ease;display:flex;align-items:center}
.notif-btn:hover{border-color:var(--border-hover);color:var(--text);background:var(--surface-hover)}
.notif-badge{position:absolute;top:-2px;right:-2px;min-width:16px;height:16px;border-radius:8px;background:var(--overdue);color:white;font-size:.6rem;font-weight:700;display:flex;align-items:center;justify-content:center;padding:0 4px}
.notif-badge:empty,.notif-badge[data-count="0"]{display:none}
.notif-panel{position:absolute;top:calc(100% + 8px);right:0;width:360px;max-height:400px;overflow-y:auto;background:var(--surface-elevated);border:1px solid var(--border-hover);border-radius:var(--radius);box-shadow:var(--shadow-lg);z-index:100;display:none}
.notif-panel.open{display:block}
.notif-panel-header{padding:12px 16px;border-bottom:1px solid var(--border);font-size:.85rem;font-weight:700;display:flex;justify-content:space-between;align-items:center}
.notif-item{padding:10px 16px;border-bottom:1px solid var(--border);font-size:.82rem;transition:background .15s ease;cursor:default}
.notif-item:hover{background:var(--surface-hover)}
.notif-item:last-child{border-bottom:none}
.notif-item-title{font-weight:600;margin-bottom:2px}
.notif-item-sub{font-size:.75rem;color:var(--text-secondary)}
.notif-item-time{font-size:.68rem;color:var(--text-muted);margin-top:2px}
.notif-item.unread{border-left:3px solid var(--accent)}
.notif-empty{padding:24px;text-align:center;color:var(--text-muted);font-size:.85rem}
@media(max-width:640px){.notif-panel{width:calc(100vw - 24px);right:-60px}}

/* ═══ TIME TRACKING ═══ */
.time-entry-row{display:flex;gap:8px;align-items:center;padding:6px 0;border-bottom:1px solid var(--border)}
.time-entry-row:last-child{border-bottom:none}
.time-hours{font-size:1rem;font-weight:700;color:var(--accent-light);min-width:40px;text-align:center}
.time-task{font-size:.82rem;flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.time-date{font-size:.72rem;color:var(--text-muted)}
.time-input{width:60px;padding:4px 8px;border-radius:var(--radius-sm);border:1px solid var(--border);background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;font-size:.85rem;text-align:center}
.time-input:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-muted)}
.timesheet-grid{display:grid;grid-template-columns:1fr repeat(7,60px) 70px;gap:1px;background:var(--border);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;margin-bottom:16px}
.timesheet-cell{background:var(--surface);padding:8px 6px;font-size:.78rem;text-align:center;min-height:36px;display:flex;align-items:center;justify-content:center}
.timesheet-cell.header{font-weight:600;text-transform:uppercase;font-size:.68rem;letter-spacing:.5px;color:var(--text-muted);background:var(--surface-elevated)}
.timesheet-cell.name{text-align:left;padding-left:12px;font-weight:600;justify-content:flex-start}
.timesheet-cell.total{font-weight:700;color:var(--accent-light);background:var(--accent-muted)}
.utilization-bar{height:6px;background:rgba(255,255,255,.06);border-radius:3px;overflow:hidden;margin-top:4px}
.utilization-fill{height:100%;border-radius:3px;transition:width .5s ease}

/* ═══ HR DIRECTORY ═══ */
.hr-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px;transition:border-color .15s ease,box-shadow .15s ease}
.hr-card:hover{border-color:var(--border-hover);box-shadow:var(--shadow-sm)}
.hr-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px;margin-bottom:20px}
.hr-avatar-lg{width:48px;height:48px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:1.2rem;font-weight:700;color:var(--bg)}
.hr-name{font-size:1rem;font-weight:700}
.hr-role-badge{font-size:.68rem;font-weight:600;text-transform:uppercase;letter-spacing:.5px;padding:2px 8px;border-radius:4px}
.hr-stat-row{display:flex;gap:16px;margin-top:10px}
.hr-stat{text-align:center}
.hr-stat-val{font-size:1.1rem;font-weight:700;font-variant-numeric:tabular-nums}
.hr-stat-label{font-size:.65rem;text-transform:uppercase;letter-spacing:.5px;color:var(--text-muted)}
.hr-leave-row{display:flex;align-items:center;gap:8px;padding:8px 12px;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius-sm);margin-bottom:4px;font-size:.82rem}
.hr-leave-row .leave-type{font-weight:600;min-width:70px}
.hr-leave-row .leave-date{color:var(--text-secondary);flex:1}
.hr-leave-row .leave-status{font-size:.72rem;font-weight:600;padding:2px 8px;border-radius:4px}
.leave-approved{background:var(--done-bg);color:var(--done)}
.leave-pending{background:var(--tomorrow-bg);color:var(--tomorrow)}
.leave-rejected{background:var(--overdue-bg);color:var(--overdue)}
@media(max-width:640px){.hr-grid{grid-template-columns:1fr}}

/* ═══ TASK COMMENTS ═══ */
.comment-list{max-height:250px;overflow-y:auto;margin-bottom:12px}
.comment-item{display:flex;gap:8px;padding:8px 0;border-bottom:1px solid var(--border)}
.comment-item:last-child{border-bottom:none}
.comment-avatar{width:24px;height:24px;border-radius:6px;background:var(--accent);display:flex;align-items:center;justify-content:center;font-size:.6rem;font-weight:700;color:var(--bg);flex-shrink:0;margin-top:2px}
.comment-body{flex:1;min-width:0}
.comment-author{font-size:.75rem;font-weight:600;color:var(--accent-light)}
.comment-text{font-size:.82rem;margin-top:2px;line-height:1.4;word-break:break-word}
.comment-time{font-size:.65rem;color:var(--text-muted);margin-top:2px}
.comment-input-row{display:flex;gap:8px}
.comment-input-row input{flex:1;padding:8px 12px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;font-size:.85rem}
.comment-input-row input:focus{outline:none;border-color:var(--accent)}
.comment-send{padding:8px 14px;border-radius:8px;border:none;background:var(--accent);color:var(--bg);font-family:'DM Sans',sans-serif;font-size:.8rem;font-weight:600;cursor:pointer}
.task-comment-btn{font-size:.68rem;color:var(--text-muted);cursor:pointer;background:none;border:none;font-family:'DM Sans',sans-serif;padding:2px 6px;border-radius:4px;transition:all .15s ease}
.task-comment-btn:hover{color:var(--accent);background:var(--accent-muted)}

/* ═══ GANTT VIEW ═══ */
.gantt-container{overflow-x:auto;margin-bottom:20px}
.gantt-chart{min-width:800px;position:relative}
.gantt-header{display:flex;border-bottom:1px solid var(--border);padding:8px 0}
.gantt-header-label{width:200px;flex-shrink:0;font-size:.72rem;font-weight:600;text-transform:uppercase;letter-spacing:.7px;color:var(--text-muted);padding-left:12px}
.gantt-header-dates{flex:1;display:flex}
.gantt-header-date{flex:1;text-align:center;font-size:.68rem;color:var(--text-muted);font-weight:500}
.gantt-row{display:flex;align-items:center;padding:6px 0;border-bottom:1px solid var(--border)}
.gantt-row:hover{background:var(--surface-hover)}
.gantt-row-label{width:200px;flex-shrink:0;font-size:.82rem;font-weight:500;padding-left:12px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.gantt-row-bars{flex:1;position:relative;height:24px;display:flex}
.gantt-bar{position:absolute;height:18px;border-radius:4px;top:3px;min-width:12px;font-size:.65rem;color:white;font-weight:600;display:flex;align-items:center;padding:0 6px;overflow:hidden;white-space:nowrap;transition:opacity .15s ease}
.gantt-bar:hover{opacity:.85}
.gantt-milestone{position:absolute;top:5px;width:14px;height:14px;transform:rotate(45deg);border-radius:2px}
.gantt-today-line{position:absolute;top:0;bottom:0;width:2px;background:var(--overdue);z-index:5;opacity:.5}
.milestone-section{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:12px}
.milestone-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
.milestone-name{font-size:.95rem;font-weight:700}
.milestone-date{font-size:.78rem;color:var(--text-secondary)}
.milestone-progress{display:flex;align-items:center;gap:8px}
.milestone-bar{flex:1;height:6px;background:rgba(255,255,255,.06);border-radius:3px;overflow:hidden}
.milestone-fill{height:100%;border-radius:3px;transition:width .5s ease}
.milestone-pct{font-size:.78rem;font-weight:600;color:var(--text-secondary);min-width:35px;text-align:right}

/* ═══ CRM / CONTACTS ═══ */
.crm-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px;margin-bottom:20px}
.crm-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px;transition:border-color .15s ease}
.crm-card:hover{border-color:var(--border-hover)}
.crm-name{font-size:.95rem;font-weight:700;margin-bottom:2px}
.crm-company{font-size:.78rem;color:var(--text-secondary);margin-bottom:8px}
.crm-type{font-size:.65rem;font-weight:600;text-transform:uppercase;letter-spacing:.5px;padding:2px 8px;border-radius:4px;display:inline-block;margin-bottom:8px}
.crm-type-client{background:rgba(102,187,106,.1);color:var(--done)}
.crm-type-vendor{background:rgba(171,71,188,.1);color:#ab47bc}
.crm-type-partner{background:rgba(66,165,245,.1);color:var(--weekly)}
.crm-type-freelancer{background:rgba(255,183,77,.1);color:#ffb74d}
.crm-detail{font-size:.78rem;color:var(--text-secondary);margin-bottom:3px;display:flex;align-items:center;gap:6px}
.crm-projects{display:flex;gap:4px;flex-wrap:wrap;margin-top:8px}
.crm-project-tag{font-size:.65rem;font-weight:600;padding:2px 6px;border-radius:3px}
@media(max-width:640px){.crm-grid{grid-template-columns:1fr}}

/* ═══ DOCUMENTS ═══ */
.doc-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px;margin-bottom:16px}
.doc-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px;text-align:center;transition:border-color .15s ease;cursor:default}
.doc-card:hover{border-color:var(--border-hover)}
.doc-icon{font-size:1.5rem;margin-bottom:6px}
.doc-name{font-size:.82rem;font-weight:600;margin-bottom:3px;word-break:break-word}
.doc-meta{font-size:.7rem;color:var(--text-muted)}
.doc-upload-zone{border:1.5px dashed var(--border-strong);border-radius:var(--radius);padding:20px;text-align:center;cursor:pointer;transition:all .2s ease;margin-bottom:12px}
.doc-upload-zone:hover{border-color:var(--accent);background:var(--accent-muted)}
.doc-project-section{margin-bottom:16px}
.doc-project-title{font-size:.82rem;font-weight:700;margin-bottom:8px;display:flex;align-items:center;gap:8px}

/* ═══ EXPORT ═══ */
.export-btn{padding:6px 14px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text-secondary);font-family:'DM Sans',sans-serif;font-size:.8rem;font-weight:500;cursor:pointer;transition:all .15s ease;display:flex;align-items:center;gap:5px}
.export-btn:hover{border-color:var(--accent);color:var(--accent);background:var(--accent-muted)}

/* ═══ NAV TABS (for new sections) ═══ */
.nav-tabs{display:flex;gap:4px;margin-bottom:16px;flex-wrap:wrap;padding:2px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);width:fit-content}
.nav-tab{padding:7px 16px;border-radius:8px;border:none;background:transparent;color:var(--text-secondary);font-family:'DM Sans',sans-serif;font-size:.8rem;font-weight:600;cursor:pointer;transition:all .15s ease;display:flex;align-items:center;gap:5px}
.nav-tab:hover{color:var(--text);background:var(--surface-hover)}
.nav-tab.active{background:var(--accent);color:var(--bg)}
</style>
</head>
<body>

<!-- Animated Background -->
<div class="bg-mesh"><div class="bg-orb"></div><div class="bg-orb"></div><div class="bg-orb"></div></div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<!-- Splash Screen -->
<div class="splash" id="splashScreen" style="display:none">
  <div class="splash-logo-wrap">
    <div class="splash-glow"></div>
    <div class="splash-m">
      <svg viewBox="0 0 120 120" fill="none" xmlns="http://www.w3.org/2000/svg">
        <!-- Outer frame -->
        <rect x="4" y="4" width="112" height="112" rx="22" stroke="#c9a46c" stroke-width="2.5" fill="none" opacity=".3"/>
        <!-- M lettermark -->
        <path d="M32 88V38l28 30 28-30v50" stroke="#c9a46c" stroke-width="6" stroke-linecap="round" stroke-linejoin="round" fill="none">
          <animate attributeName="stroke-dasharray" from="0 250" to="250 0" dur="1s" begin=".3s" fill="freeze"/>
        </path>
        <!-- Accent dot -->
        <circle cx="60" cy="32" r="4" fill="#e0c98f" opacity="0">
          <animate attributeName="opacity" from="0" to="1" dur=".3s" begin="1s" fill="freeze"/>
          <animate attributeName="r" from="0" to="4" dur=".3s" begin="1s" fill="freeze"/>
        </circle>
      </svg>
    </div>
    <div class="splash-line"></div>
    <div class="splash-brand">
      <div class="splash-title">MPIRE</div>
    </div>
    <div class="splash-welcome" id="splashWelcome"></div>
  </div>
</div>

<div class="login-page" id="loginPage">
  <button class="hdr-btn" id="loginThemeBtn" onclick="toggleTheme()" title="Toggle theme" style="position:absolute;top:16px;right:16px;z-index:10">☀</button>
  <div class="login-card">
    <div class="login-logo">MPIRE</div>
    <div class="login-sub">Sign in to access your dashboard</div>
    <div class="login-field"><label>Username</label><input type="text" id="loginUser" placeholder="Enter your username" autocomplete="off"></div>
    <div class="login-field"><label>Password</label><input type="password" id="loginPass" placeholder="Enter your password"></div>
    <button class="login-btn" onclick="doLogin()">Sign In</button>
    <div class="login-error" id="loginError"></div>
    <div class="login-footer">Project Task Board · Secure Login</div>
  </div>
</div>

<div class="app" id="app">
<div class="header">
  <div class="header-top">
    <div class="header-left"><h1><span class="brand-accent">M</span>PIRE</h1><div class="subtitle"><span id="projectCount">0</span> projects · <span id="totalTasks">0</span> tasks</div></div>
    <div class="header-right">
      <div class="user-badge"><span class="ub-avatar" id="ubAvatar"></span><span id="ubName"></span><span class="ub-role" id="ubRole"></span></div>
      <div class="view-toggle" id="viewToggle" style="display:none">
        <button class="view-toggle-btn" id="viewDashBtn" onclick="switchView('dashboard')">Dashboard</button>
        <button class="view-toggle-btn active" id="viewTasksBtn" onclick="switchView('tasks')">Tasks</button>
        <button class="view-toggle-btn" id="viewHrBtn" onclick="switchView('hr')">HR</button>
        <button class="view-toggle-btn" id="viewTimeBtn" onclick="switchView('timetracking')">Time</button>
        <button class="view-toggle-btn" id="viewCrmBtn" onclick="switchView('crm')">Contacts</button>
        <button class="view-toggle-btn" id="viewDocsBtn" onclick="switchView('docs')">Docs</button>
        <button class="view-toggle-btn" id="viewFinBtn" onclick="switchView('financials')">Financials</button>
      </div>
      <div style="position:relative;display:inline-block" id="notifWrap">
        <button class="notif-btn" id="notifBtn" style="display:none" onclick="toggleNotifPanel(event)">🔔<span class="notif-badge" id="notifBadge"></span></button>
        <div class="notif-panel" id="notifPanel" onclick="event.stopPropagation()"><div class="notif-panel-header"><span>Notifications</span><button style="background:none;border:none;color:var(--text-muted);font-size:.75rem;cursor:pointer" onclick="event.stopPropagation();clearNotifications()">Clear all</button></div><div id="notifList"></div></div>
      </div>
      <button class="hdr-btn" id="activityBtn" style="display:none" onclick="openActivityLog()">◷ Log</button>
      <button class="hdr-btn" id="settingsBtn" style="display:none" onclick="openSettingsModal()">⚙ Settings</button>
      <button class="hdr-btn" id="themeToggleBtn" onclick="toggleTheme()" title="Toggle light/dark theme">☀</button>
      <button class="hdr-btn logout-btn" onclick="doLogout()">Logout</button>
    </div>
  </div>
  <div id="tasksHeaderSection">
  <div class="stats-row">
    <div class="stat"><div class="stat-dot" style="background:var(--today)"></div>Today <strong id="statToday">0</strong></div>
    <div class="stat"><div class="stat-dot" style="background:var(--tomorrow)"></div>Tomorrow <strong id="statTomorrow">0</strong></div>
    <div class="stat"><div class="stat-dot" style="background:var(--daily)"></div>Daily <strong id="statDaily">0</strong></div>
    <div class="stat"><div class="stat-dot" style="background:var(--weekly)"></div>Weekly <strong id="statWeekly">0</strong></div>
    <div class="stat"><div class="stat-dot" style="background:var(--overdue)"></div>Overdue <strong id="statOverdue">0</strong></div>
    <div class="stat"><div class="stat-dot" style="background:var(--progress)"></div>In Progress <strong id="statProgress">0</strong></div>
    <div class="stat"><div class="stat-dot" style="background:var(--done)"></div>Done <strong id="statDone">0</strong></div>
  </div>
  <div class="team-bar" id="teamBar"><span class="team-bar-label">Team</span></div>
  <div class="filter-bar" id="filterBar">
    <button class="filter-btn active" data-filter="all">All</button>
    <button class="filter-btn" data-filter="today">Today</button>
    <button class="filter-btn" data-filter="tomorrow">Tomorrow</button>
    <button class="filter-btn" data-filter="pending">Pending</button>
    <button class="add-project-btn" id="addProjectBtn" style="display:none" onclick="openProjectModal()">+ New Project</button>
    <button class="backlog-btn" id="backlogBtn" style="display:none" onclick="toggleBacklog()">📋 Backlog</button>
    <div class="task-view-toggle" id="taskViewToggle">
      <button class="task-view-btn active" id="listViewBtn" onclick="switchTaskView('list')">☰ List</button>
      <button class="task-view-btn" id="kanbanViewBtn" onclick="switchTaskView('kanban')">▦ Board</button>
    </div>
  </div>
  </div>
</div>
<div class="main" id="dashboardContainer" style="display:none"></div>
<div class="main" id="projectContainer"></div>
<div class="main" id="hrContainer" style="display:none"></div>
<div class="main" id="timeContainer" style="display:none"></div>
<div class="main" id="crmContainer" style="display:none"></div>
<div class="main" id="docsContainer" style="display:none"></div>
<div class="main" id="financialContainer" style="display:none"></div>
</div>

<!-- Task Modal (Add) -->
<div class="modal-overlay" id="taskModalOverlay"><div class="modal">
  <div class="modal-header"><h2 id="taskModalTitle">Add New Task</h2><p>Project: <strong id="modalProjectName"></strong></p></div>
  <div class="modal-body">
    <div class="field"><label>Task Description</label><input type="text" id="newTaskText" placeholder="What needs to be done?" autocomplete="off"></div>
    <div class="field-row"><div class="field"><label>Deadline</label><select id="newDeadlineType" onchange="toggleDateField()"><option value="today">Today</option><option value="tomorrow">Tomorrow</option><option value="daily">Daily</option><option value="weekly">Weekly</option><option value="pending">Pending</option><option value="date">Pick a Date</option></select></div><div class="field" id="datePickerField" style="display:none"><label>Date</label><input type="date" id="newDeadlineDate"></div></div>
    <div class="field-row"><div class="field"><label>Person</label><select id="newPerson"></select></div><div class="field"><label>Priority</label><select id="newPriority"><option value="high">🔴 High</option><option value="medium" selected>🟡 Medium</option><option value="low">🔵 Low</option></select></div></div>
  </div>
  <div class="modal-footer"><button class="btn btn-cancel" onclick="closeTaskModal()">Cancel</button><button class="btn btn-add" id="taskModalSaveBtn" onclick="saveTaskModal()">Add Task</button></div>
</div></div>

<!-- Project Modal -->
<div class="modal-overlay" id="projectModalOverlay"><div class="modal">
  <div class="modal-header"><h2>New Project</h2><p>Create a new project</p></div>
  <div class="modal-body"><div class="field"><label>Project Name</label><input type="text" id="newProjectName" placeholder="e.g. Marketing Campaign" autocomplete="off"></div><div class="field"><label>Color</label><div class="color-options" id="colorOptions"></div></div></div>
  <div class="modal-footer"><button class="btn btn-cancel" onclick="closeProjectModal()">Cancel</button><button class="btn btn-add" onclick="addProject()">Create Project</button></div>
</div></div>

<!-- Delete Modal -->
<div class="modal-overlay" id="deleteModalOverlay"><div class="modal">
  <div class="modal-header"><h2>Delete Project</h2><p>Are you sure you want to delete <strong id="deleteProjectName"></strong>?</p></div>
  <div class="modal-footer"><button class="btn btn-cancel" onclick="closeDeleteModal()">Cancel</button><button class="btn btn-danger" onclick="confirmDeleteProject()">Delete</button></div>
</div></div>

<!-- Settings Modal -->
<div class="modal-overlay" id="settingsModalOverlay"><div class="modal" style="width:620px">
  <div class="modal-header"><h2>⚙ Admin Settings</h2><p>Manage users, roles & project visibility</p></div>
  <div class="modal-body" id="settingsBody"></div>
  <div class="modal-footer"><button class="btn btn-add" onclick="closeSettingsModal()">Done</button></div>
</div></div>

<!-- Activity Log Modal (enhanced with filters) -->
<div class="modal-overlay" id="activityModalOverlay"><div class="modal" style="width:620px">
  <div class="modal-header"><h2>Activity Log</h2><p>Recent changes by your team</p></div>
  <div class="modal-body">
    <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap">
      <select id="actFilterUser" onchange="renderActivityList()" style="padding:6px 10px;border-radius:var(--radius-sm);border:1px solid var(--border);background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;font-size:.8rem"><option value="">All Users</option></select>
      <select id="actFilterAction" onchange="renderActivityList()" style="padding:6px 10px;border-radius:var(--radius-sm);border:1px solid var(--border);background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;font-size:.8rem"><option value="">All Actions</option></select>
      <input type="date" id="actFilterDate" onchange="renderActivityList()" style="padding:6px 10px;border-radius:var(--radius-sm);border:1px solid var(--border);background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;font-size:.8rem;color-scheme:dark">
      <button class="export-btn" onclick="exportActivityLog()" style="margin-left:auto">⤓ Export</button>
    </div>
    <div class="activity-list" id="activityList"></div>
  </div>
  <div class="modal-footer"><button class="btn btn-cancel" onclick="document.getElementById('activityModalOverlay').classList.remove('open')">Close</button></div>
</div></div>

<!-- Task Comments Modal -->
<div class="modal-overlay" id="commentModalOverlay"><div class="modal" style="width:500px">
  <div class="modal-header"><h2 id="commentModalTitle">Task Comments</h2><p id="commentModalTask"></p></div>
  <div class="modal-body">
    <div class="comment-list" id="commentList"></div>
    <div class="comment-input-row"><input type="text" id="commentInput" placeholder="Add a comment..." autocomplete="off"><button class="comment-send" onclick="addComment()">Send</button></div>
  </div>
  <div class="modal-footer"><button class="btn btn-cancel" onclick="closeCommentModal()">Close</button></div>
</div></div>

<!-- HR Leave Modal -->
<div class="modal-overlay" id="leaveModalOverlay"><div class="modal">
  <div class="modal-header"><h2>Request Leave</h2><p>Submit a leave request</p></div>
  <div class="modal-body">
    <div class="field"><label>Employee</label><select id="leaveEmployee"></select></div>
    <div class="field-row"><div class="field"><label>Type</label><select id="leaveType"><option value="Vacation">Vacation</option><option value="Sick">Sick</option><option value="Personal">Personal</option><option value="Other">Other</option></select></div><div class="field"><label>Status</label><select id="leaveStatus"><option value="pending">Pending</option><option value="approved">Approved</option><option value="rejected">Rejected</option></select></div></div>
    <div class="field-row"><div class="field"><label>Start Date</label><input type="date" id="leaveStart"></div><div class="field"><label>End Date</label><input type="date" id="leaveEnd"></div></div>
  </div>
  <div class="modal-footer"><button class="btn btn-cancel" onclick="closeModal('leaveModalOverlay')">Cancel</button><button class="btn btn-add" onclick="saveLeave()">Submit</button></div>
</div></div>

<!-- CRM Contact Modal -->
<div class="modal-overlay" id="contactModalOverlay"><div class="modal">
  <div class="modal-header"><h2 id="contactModalTitle">Add Contact</h2><p>Add a client, vendor, or partner</p></div>
  <div class="modal-body">
    <div class="field"><label>Name</label><input type="text" id="contactName" placeholder="Full name" autocomplete="off"></div>
    <div class="field-row"><div class="field"><label>Type</label><select id="contactType"><option value="client">Client</option><option value="vendor">Vendor</option><option value="freelancer">Freelancer</option></select></div><div class="field"><label>Company</label><input type="text" id="contactCompany" placeholder="Company name" autocomplete="off"></div></div>
    <div class="field-row"><div class="field"><label>Email</label><input type="email" id="contactEmail" placeholder="email@example.com" autocomplete="off"></div><div class="field"><label>Phone</label><input type="tel" id="contactPhone" placeholder="+1 234 567 8900" autocomplete="off"></div></div>
    <div class="field"><label>Linked Projects</label><div id="contactProjects" style="display:flex;gap:6px;flex-wrap:wrap"></div></div>
    <div class="field"><label>Notes</label><textarea id="contactNotes" rows="2" placeholder="Optional notes..."></textarea></div>
  </div>
  <div class="modal-footer"><button class="btn btn-cancel" onclick="closeModal('contactModalOverlay')">Cancel</button><button class="btn btn-add" id="contactSaveBtn" onclick="saveContact()">Add Contact</button></div>
</div></div>

<!-- Milestone Modal -->
<div class="modal-overlay" id="milestoneModalOverlay"><div class="modal">
  <div class="modal-header"><h2>Add Milestone</h2><p>Group tasks under a milestone</p></div>
  <div class="modal-body">
    <div class="field"><label>Milestone Name</label><input type="text" id="milestoneName" placeholder="e.g. Phase 1 Launch" autocomplete="off"></div>
    <div class="field-row"><div class="field"><label>Project</label><select id="milestoneProject"></select></div><div class="field"><label>Target Date</label><input type="date" id="milestoneDate"></div></div>
  </div>
  <div class="modal-footer"><button class="btn btn-cancel" onclick="closeModal('milestoneModalOverlay')">Cancel</button><button class="btn btn-add" onclick="saveMilestone()">Create</button></div>
</div></div>

<!-- Time Entry Modal -->
<div class="modal-overlay" id="timeModalOverlay"><div class="modal">
  <div class="modal-header"><h2>Log Time</h2><p>Record hours worked</p></div>
  <div class="modal-body">
    <div class="field"><label>Employee</label><select id="timeEmployee"></select></div>
    <div class="field-row"><div class="field"><label>Project</label><select id="timeProject" onchange="updateTimeTasks()"></select></div><div class="field"><label>Task</label><select id="timeTask"></select></div></div>
    <div class="field-row"><div class="field"><label>Hours</label><input type="number" id="timeHours" min="0.25" max="24" step="0.25" value="1" placeholder="Hours"></div><div class="field"><label>Date</label><input type="date" id="timeDate"></div></div>
    <div class="field"><label>Notes</label><input type="text" id="timeNotes" placeholder="What did you work on?" autocomplete="off"></div>
  </div>
  <div class="modal-footer"><button class="btn btn-cancel" onclick="closeModal('timeModalOverlay')">Cancel</button><button class="btn btn-add" onclick="saveTimeEntry()">Log Hours</button></div>
</div></div>

<script>
// ═══ DATA ═══
const DEFAULT_USERS=[
  {username:'Almuhannad',password:'7242',role:'owner',displayName:'Almuhannad'},
  {username:'Fajer',password:'0101',role:'manager',displayName:'Fajer'},
  {username:'Manar',password:'0110',role:'manager',displayName:'Manar'},
  {username:'Hala',password:'0202',role:'user',displayName:'Hala'},
  {username:'Ahmad',password:'0300',role:'user',displayName:'Ahmad'},
];
let USERS=[...DEFAULT_USERS];
const DEFAULT_PROJECTS=[
  {name:"Sama Hotel",color:"#c9a46c",visibility:{},tasks:[
    {text:"Tell Harith to buy descent",person:"Harith",deadline:"today",priority:"high",status:"todo"},
    {text:"Follow up on pending rents",person:"—",deadline:"daily",priority:"high",status:"todo"},
    {text:"Send the sheet to ROP",person:"—",deadline:"today",priority:"medium",status:"todo"},
    {text:"Take cheque to bank",person:"—",deadline:"tomorrow",priority:"medium",status:"todo"},
  ]},
  {name:"Real Estate",color:"#5ca0e0",visibility:{},tasks:[
    {text:"Follow up with Harith on filling the sheet (before end of month)",person:"Harith",deadline:"weekly",priority:"high",status:"todo"},
    {text:"Take cheque to bank",person:"—",deadline:"tomorrow",priority:"medium",status:"todo"},
  ]},
  {name:"MPire Production",color:"#9b7ae0",visibility:{},tasks:[
    {text:"Follow up with team to send quotes",person:"Team",deadline:"tomorrow",priority:"high",status:"todo"},
  ]},
  {name:"Hospitality Company",color:"#e0a33c",visibility:{},tasks:[
    {text:"Waiting on Hilal's reply",person:"Hilal",deadline:"pending",priority:"medium",status:"todo"},
  ]},
  {name:"The Peak",color:"#4ead6b",visibility:{},tasks:[
    {text:"Print new cups",person:"—",deadline:"today",priority:"low",status:"todo"},
    {text:"Follow up with Harith on purchases and delivery time",person:"Harith",deadline:"tomorrow",priority:"medium",status:"todo"},
  ]},
  {name:"Al Jaban Alali",color:"#e05c5c",visibility:{},tasks:[
    {text:"Review contract with Marwan",person:"Marwan",deadline:"today",priority:"high",status:"todo"},
  ]},
  {name:"Business Manager",color:"#e08a5c",visibility:{},tasks:[
    {text:"Take Porsche to dealership",person:"—",deadline:"tomorrow",priority:"low",status:"todo"},
  ]}
];
let PROJECTS=JSON.parse(JSON.stringify(DEFAULT_PROJECTS));
const PROJECT_COLORS=['#c9a46c','#5ca0e0','#9b7ae0','#e0a33c','#4ead6b','#e05c5c','#e08a5c','#5cc0b8','#b06ec9','#7a8ee0'];
let currentUser=null,activeFilter='all',activePersonFilter=null,taskModalProjectIndex=null,deleteProjectIndex=null,selectedProjectColor=PROJECT_COLORS[0],openPopover=null;
let editingTask=null; // {pi,ti} when editing
let showBacklog=false;
let currentView='tasks'; // 'tasks' or 'financials'
let currentTaskView='list'; // 'list' or 'kanban'
let financialData=[]; // [{businessName,fileName,parsedPL:{periods,revenue,cogs,grossProfit,opex,netProfit,otherRows}}]
let activeFinBusiness=null; // null = overview, or index into financialData
let finCharts={}; // store chart instances for cleanup
let activityLog=[]; // [{ts,user,action,detail}]

// ═══ NEW FEATURE DATA ═══
let timeEntries=[]; // [{id,employee,project,task,hours,date,notes}]
let hrLeaves=[]; // [{id,employee,type,startDate,endDate,status}]
let crmContacts=[]; // [{id,name,type,company,email,phone,projects:[],notes}]
let milestones=[]; // [{id,name,projectIndex,targetDate,taskIndices:[]}]
let documents=[]; // [{id,name,size,type,project,uploadedBy,uploadedAt,dataUrl}]
let notifications=[]; // [{id,title,body,time,read}]
let editingContactIndex=null;
let currentTheme=localStorage.getItem('mpire_theme')||'dark';

// ═══ SUPABASE SETUP ═══
let sbClient=null;
try{
  const{createClient}=window.supabase;
  sbClient=createClient('https://tqhanahgzlkrqdbmfpfp.supabase.co','sb_publishable_4qWwGX4zgtzMhrB8YI4vHw_LcE6eNRr');
}catch(e){console.warn('Supabase init failed, cloud sync disabled:',e)}

// ═══ FINANCIAL DATA PERSISTENCE (Cloud + Local Cache) ═══
function saveFinancialData(){
  try{localStorage.setItem('mpire_financial_data',JSON.stringify(financialData))}catch(e){}
  if(!currentUser||!sbClient)return;
  sbClient.from('financial_data').upsert({username:currentUser.username,data:financialData,updated_at:new Date().toISOString()},{onConflict:'username'}).then(({error})=>{
    if(error)console.warn('Supabase save error:',error.message);
  });
}
function loadFinancialData(){
  try{const d=localStorage.getItem('mpire_financial_data');if(d){financialData=JSON.parse(d)}}catch(e){financialData=[]}
}
async function loadFinancialDataFromCloud(){
  if(!currentUser||!sbClient)return;
  try{
    const{data,error}=await sbClient.from('financial_data').select('data').eq('username',currentUser.username).maybeSingle();
    if(error){console.warn('Supabase load error:',error.message);return}
    if(data&&data.data){
      financialData=data.data;
      try{localStorage.setItem('mpire_financial_data',JSON.stringify(financialData))}catch(e){}
    }
  }catch(e){console.warn('Cloud load failed, using local cache:',e)}
}
loadFinancialData();

// ═══ USER DATA PERSISTENCE (Cloud + Local Cache) ═══
function saveUsers(){
  try{localStorage.setItem('mpire_users',JSON.stringify(USERS))}catch(e){}
  if(!sbClient)return;
  sbClient.from('financial_data').upsert({username:'_system_users',data:USERS,updated_at:new Date().toISOString()},{onConflict:'username'}).then(({error})=>{
    if(error)console.warn('Supabase user save error:',error.message);
  });
}
function mergeUsers(saved){
  // Start with saved users, then add any new defaults not already present
  const merged=[...saved];
  const names=new Set(saved.map(u=>u.username.toLowerCase()));
  for(const d of DEFAULT_USERS){
    if(!names.has(d.username.toLowerCase())) merged.push({...d});
  }
  return merged;
}
function loadUsers(){
  try{
    const d=localStorage.getItem('mpire_users');
    if(d){
      const saved=JSON.parse(d);
      if(Array.isArray(saved)&&saved.length>0){USERS=mergeUsers(saved);return}
    }
  }catch(e){}
  USERS=[...DEFAULT_USERS];
}
async function loadUsersFromCloud(){
  if(!sbClient)return;
  try{
    const{data,error}=await sbClient.from('financial_data').select('data').eq('username','_system_users').maybeSingle();
    if(error){console.warn('Supabase user load error:',error.message);return}
    if(data&&Array.isArray(data.data)&&data.data.length>0){
      USERS=mergeUsers(data.data);
      try{localStorage.setItem('mpire_users',JSON.stringify(USERS))}catch(e){}
    }
  }catch(e){console.warn('Cloud user load failed, using local cache:',e)}
}
loadUsers();
loadUsersFromCloud();

// ═══ PROJECT DATA PERSISTENCE (Cloud + Local Cache) ═══
function saveProjects(){
  try{localStorage.setItem('mpire_projects',JSON.stringify(PROJECTS))}catch(e){}
  if(!sbClient)return;
  sbClient.from('financial_data').upsert({username:'_system_projects',data:PROJECTS,updated_at:new Date().toISOString()},{onConflict:'username'}).then(({error})=>{
    if(error)console.warn('Supabase project save error:',error.message);
  });
}
function mergeProjects(saved){
  // Start with saved projects, then add any new defaults not already present
  const merged=JSON.parse(JSON.stringify(saved));
  const names=new Set(saved.map(p=>p.name.toLowerCase()));
  for(const d of DEFAULT_PROJECTS){
    if(!names.has(d.name.toLowerCase())) merged.push(JSON.parse(JSON.stringify(d)));
  }
  return merged;
}
function loadProjects(){
  try{
    const d=localStorage.getItem('mpire_projects');
    if(d){const saved=JSON.parse(d);if(Array.isArray(saved)&&saved.length>0){PROJECTS=mergeProjects(saved);return}}
  }catch(e){}
  PROJECTS=JSON.parse(JSON.stringify(DEFAULT_PROJECTS));
}
async function loadProjectsFromCloud(){
  if(!sbClient)return;
  try{
    const{data,error}=await sbClient.from('financial_data').select('data').eq('username','_system_projects').maybeSingle();
    if(error){console.warn('Supabase project load error:',error.message);return}
    if(data&&Array.isArray(data.data)&&data.data.length>0){
      PROJECTS=mergeProjects(data.data);
      try{localStorage.setItem('mpire_projects',JSON.stringify(PROJECTS))}catch(e){}
    }
  }catch(e){console.warn('Cloud project load failed:',e)}
}
loadProjects();
loadProjectsFromCloud();

// ═══ ACTIVITY LOG ═══
function loadActivityLog(){
  try{const d=localStorage.getItem('mpire_activity');if(d)activityLog=JSON.parse(d)||[]}catch(e){activityLog=[]}
}
function saveActivityLog(){
  try{localStorage.setItem('mpire_activity',JSON.stringify(activityLog.slice(-200)))}catch(e){}
  if(!sbClient)return;
  sbClient.from('financial_data').upsert({username:'_system_activity',data:activityLog.slice(-200),updated_at:new Date().toISOString()},{onConflict:'username'}).then(({error})=>{
    if(error)console.warn('Activity log save error:',error.message);
  });
}
async function loadActivityFromCloud(){
  if(!sbClient)return;
  try{
    const{data,error}=await sbClient.from('financial_data').select('data').eq('username','_system_activity').maybeSingle();
    if(error)return;
    if(data&&Array.isArray(data.data)){activityLog=data.data;try{localStorage.setItem('mpire_activity',JSON.stringify(activityLog))}catch(e){}}
  }catch(e){}
}
function logActivity(action,detail){
  const entry={ts:new Date().toISOString(),user:currentUser?currentUser.displayName:'System',action,detail};
  activityLog.push(entry);
  saveActivityLog();
}
loadActivityLog();
loadActivityFromCloud();

// ═══ TOAST NOTIFICATIONS ═══
function showToast(msg,type='info'){
  const c=document.getElementById('toastContainer');if(!c)return;
  const t=document.createElement('div');
  t.className='toast toast-'+type;
  t.innerHTML=`<span class="toast-icon">${type==='success'?'✓':type==='error'?'✕':type==='warning'?'⚠':'ℹ'}</span><span>${msg}</span>`;
  c.appendChild(t);
  requestAnimationFrame(()=>t.classList.add('show'));
  setTimeout(()=>{t.classList.remove('show');setTimeout(()=>t.remove(),300)},3000);
}

function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML}
function getTodayStr(){const d=new Date();return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0')}
function getPeopleList(){return ['—',...USERS.map(u=>u.displayName),'Team']}
function isOverdue(t){if(t.status==='done')return false;const dl=t.deadline;if(dl&&dl.includes('-')&&dl<getTodayStr())return true;return false}

// Permissions
function isOwner(){return currentUser&&currentUser.role==='owner'}
function isManager(){return currentUser&&currentUser.role==='manager'}
function canManage(){return isOwner()||isManager()}
function canEditTask(){return canManage()}
function canChangeStatus(t){if(canManage())return true;return currentUser&&t.person===currentUser.displayName}
function canAccessSettings(){return isOwner()}
function canSeeProject(p){if(!currentUser)return false;if(isOwner())return true;if(p.visibility[currentUser.username]===false)return false;return true}
function getRoleLabel(r){return r==='owner'?'Owner':r==='manager'?'Manager':'User'}
function getRoleColor(r){return r==='owner'?'var(--accent)':r==='manager'?'#5ca0e0':'var(--text-muted)'}
function getDeadlineLabel(d){const m={today:'Today',tomorrow:'Tomorrow',daily:'Daily',weekly:'Weekly',pending:'Pending'};if(m[d])return m[d];if(d&&d.includes('-')){const dt=new Date(d+'T00:00:00');return dt.toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'})}return d||'None'}
function getDeadlineClass(d,t){if(t&&isOverdue(t))return'deadline-overdue';return['today','tomorrow','weekly','daily','pending'].includes(d)?`deadline-${d}`:'deadline-date'}

// ═══ LOGIN ═══
async function doLogin(){
  const u=document.getElementById('loginUser').value.trim(),p=document.getElementById('loginPass').value;
  const btn=document.querySelector('.login-btn');
  btn.textContent='Signing in...';btn.disabled=true;
  let user=USERS.find(x=>x.username.toLowerCase()===u.toLowerCase()&&x.password===p);
  // If not found locally, fetch latest users from cloud and retry
  if(!user&&sbClient){
    await loadUsersFromCloud();
    user=USERS.find(x=>x.username.toLowerCase()===u.toLowerCase()&&x.password===p);
  }
  if(!user){document.getElementById('loginError').textContent='Invalid username or password';btn.textContent='Sign In';btn.disabled=false;return}
  currentUser=user;
  // Load data from cloud while splash plays
  const cloudLoad=Promise.all([loadFinancialDataFromCloud(),loadProjectsFromCloud(),loadActivityFromCloud()]);
  document.getElementById('loginPage').style.display='none';
  // Show splash screen
  const splash=document.getElementById('splashScreen');
  splash.style.display='flex';splash.classList.remove('hide');
  document.getElementById('splashWelcome').textContent='Welcome back, '+user.displayName;
  // After animation, transition to dashboard
  setTimeout(async()=>{
    await cloudLoad;
    splash.classList.add('hide');
    document.getElementById('app').classList.add('visible');
    setupApp();
    setTimeout(()=>{splash.style.display='none'},700);
  },2600);
}
function doLogout(){currentUser=null;showBacklog=false;currentView='tasks';financialData=[];activeFinBusiness=null;notifications=[];document.getElementById('app').classList.remove('visible');document.getElementById('loginPage').style.display='flex';document.getElementById('loginUser').value='';document.getElementById('loginPass').value='';document.getElementById('loginError').textContent=''}
document.getElementById('loginPass').addEventListener('keydown',e=>{if(e.key==='Enter')doLogin()});
document.getElementById('loginUser').addEventListener('keydown',e=>{if(e.key==='Enter')document.getElementById('loginPass').focus()});

function setupApp(){
  document.getElementById('ubAvatar').textContent=currentUser.displayName.charAt(0);
  document.getElementById('ubName').textContent=currentUser.displayName;
  const rl=document.getElementById('ubRole');rl.textContent=getRoleLabel(currentUser.role);rl.style.color=getRoleColor(currentUser.role);rl.style.background=currentUser.role==='owner'?'rgba(201,164,108,.15)':currentUser.role==='manager'?'rgba(92,160,224,.15)':'rgba(139,143,163,.15)';
  document.getElementById('settingsBtn').style.display=canAccessSettings()?'flex':'none';
  document.getElementById('activityBtn').style.display=canManage()?'flex':'none';
  document.getElementById('notifBtn').style.display='flex';
  document.getElementById('viewToggle').style.display='flex';
  document.getElementById('viewDashBtn').style.display=canManage()?'':'none';
  document.getElementById('viewTimeBtn').style.display=canManage()?'':'none';
  document.getElementById('viewCrmBtn').style.display=canManage()?'':'none';
  document.getElementById('viewDocsBtn').style.display=canManage()?'':'none';
  document.getElementById('viewFinBtn').style.display=canManage()?'':'none';
  document.getElementById('addProjectBtn').style.display=canManage()?'inline-flex':'none';
  document.getElementById('backlogBtn').style.display=canManage()?'inline-flex':'none';
  activeFilter='all';activePersonFilter=null;showBacklog=false;currentView='tasks';currentTaskView='list';
  applyTheme();loadAllFeatureData();generateNotifications();switchView('tasks');
}

// ═══ TEAM BAR ═══
function renderTeamBar(){
  const bar=document.getElementById('teamBar'),counts={};
  PROJECTS.forEach(p=>{if(!canSeeProject(p))return;p.tasks.forEach(t=>{if(t.person&&t.person!=='—'&&t.status!=='done')counts[t.person]=(counts[t.person]||0)+1})});
  bar.innerHTML='<span class="team-bar-label">Team</span>';
  if(!Object.keys(counts).length){bar.innerHTML+='<span style="font-size:.82rem;color:var(--text-muted)">No assigned tasks</span>';return}
  bar.innerHTML+=`<div class="team-chip ${activePersonFilter===null?'active':''}" onclick="setPersonFilter(null)"><span>All</span></div>`;
  Object.entries(counts).sort((a,b)=>b[1]-a[1]).forEach(([n,c])=>{bar.innerHTML+=`<div class="team-chip ${activePersonFilter===n?'active':''}" onclick="setPersonFilter('${esc(n)}')"><span>${esc(n)}</span><span class="chip-count">${c}</span></div>`});
}
function setPersonFilter(p){activePersonFilter=p;render()}

// ═══ BACKLOG ═══
function toggleBacklog(){showBacklog=!showBacklog;document.querySelector('.backlog-btn').classList.toggle('active',showBacklog);render()}

function renderBacklog(){
  const container=document.getElementById('projectContainer');container.innerHTML='';
  // Gather all tasks by user for KPI calculation
  const userStats={};
  PROJECTS.forEach((p,pi)=>{if(!canSeeProject(p))return;p.tasks.forEach((t,ti)=>{
    const person=t.person||'—';
    if(!userStats[person])userStats[person]={completed:[],overdue:[],total:0,inProgress:0,todo:0};
    userStats[person].total++;
    if(t.status==='done')userStats[person].completed.push({...t,projectName:p.name,projectColor:p.color,pi,ti});
    else if(t.status==='progress')userStats[person].inProgress++;
    else userStats[person].todo++;
    if(isOverdue(t))userStats[person].overdue.push({...t,projectName:p.name,projectColor:p.color});
  })});
  // Only show users who have completed tasks or overdue tasks
  const relevantUsers=Object.entries(userStats).filter(([_,s])=>s.completed.length>0||s.overdue.length>0);
  if(!relevantUsers.length){container.innerHTML='<div class="backlog-empty">No completed tasks yet.</div>';return}
  relevantUsers.sort((a,b)=>b[1].completed.length-a[1].completed.length).forEach(([person,stats])=>{
    const sec=document.createElement('div');sec.className='backlog-section';
    const completionRate=stats.total>0?Math.round((stats.completed.length/stats.total)*100):0;
    const overdueCount=stats.overdue.length;
    const barColor=completionRate>=75?'var(--done)':completionRate>=40?'var(--progress)':'var(--overdue)';
    sec.innerHTML=`
      <div class="backlog-user-header"><div class="backlog-avatar">${person.charAt(0)}</div><span class="backlog-name">${esc(person)}</span><span class="backlog-count">${stats.total} total tasks</span></div>
      <div class="kpi-row">
        <div class="kpi-card"><span class="kpi-label">Completed</span><span class="kpi-value kpi-green">${stats.completed.length}</span><span class="kpi-sub">of ${stats.total} tasks</span><div class="kpi-bar"><div class="kpi-bar-fill" style="width:${completionRate}%;background:${barColor}"></div></div></div>
        <div class="kpi-card"><span class="kpi-label">Past Due</span><span class="kpi-value ${overdueCount>0?'kpi-red':'kpi-green'}">${overdueCount}</span><span class="kpi-sub">${overdueCount>0?'tasks overdue':'all on track'}</span></div>
        <div class="kpi-card"><span class="kpi-label">In Progress</span><span class="kpi-value kpi-gold">${stats.inProgress}</span><span class="kpi-sub">${stats.todo} still to do</span></div>
        <div class="kpi-card"><span class="kpi-label">Performance</span><span class="kpi-value ${completionRate>=75?'kpi-green':completionRate>=40?'kpi-gold':'kpi-red'}">${completionRate}%</span><span class="kpi-sub">completion rate</span><div class="kpi-bar"><div class="kpi-bar-fill" style="width:${completionRate}%;background:${barColor}"></div></div></div>
      </div>
      ${overdueCount>0?`<div style="margin-bottom:12px"><div style="font-size:.78rem;font-weight:600;color:var(--overdue);margin-bottom:6px;padding:0 4px">⚠ OVERDUE TASKS</div>${stats.overdue.map(t=>`<div class="backlog-task" style="border-left:3px solid var(--overdue)"><span class="overdue-icon" style="animation:none">⚠</span><span style="flex:1;font-size:.88rem">${esc(t.text)}</span><span class="bt-project" style="background:${t.projectColor}20;color:${t.projectColor}">${esc(t.projectName)}</span><span class="bt-date" style="color:var(--overdue)">${getDeadlineLabel(t.deadline)}</span></div>`).join('')}</div>`:''}
      ${stats.completed.length>0?`<div style="font-size:.78rem;font-weight:600;color:var(--done);margin-bottom:6px;padding:0 4px">✓ COMPLETED TASKS</div>`:''}
      ${stats.completed.map(t=>`<div class="backlog-task"><span class="bt-check">✓</span><span class="bt-text">${esc(t.text)}</span><span class="bt-project" style="background:${t.projectColor}20;color:${t.projectColor}">${esc(t.projectName)}</span><span class="bt-date">${getDeadlineLabel(t.deadline)}</span><button class="bt-undo" onclick="undoComplete(${t.pi},${t.ti})" title="Move back to task list">↩ Undo</button></div>`).join('')}`;
    container.appendChild(sec);
  });
}
function undoComplete(pi,ti){PROJECTS[pi].tasks[ti].status='todo';logActivity('reopened',`"${PROJECTS[pi].tasks[ti].text}"`);showToast('Task moved back to active','info');saveProjects();render()}

// ═══ RENDER ═══
function render(){
  if(showBacklog){renderBacklog();renderTeamBar();updateStats();return}
  const container=document.getElementById('projectContainer');container.innerHTML='';
  const PEOPLE=getPeopleList();
  let totalTasks=0,doneCount=0,progressCount=0,overdueCount=0,todayCount=0,tomorrowCount=0,dailyCount=0,weeklyCount=0,visibleProjects=0;

  PROJECTS.forEach((project,pi)=>{
    if(!canSeeProject(project))return;
    let tasks=project.tasks.filter(t=>t.status!=='done');
    if(activeFilter!=='all')tasks=tasks.filter(t=>t.deadline===activeFilter);
    if(activePersonFilter)tasks=tasks.filter(t=>t.person===activePersonFilter);
    if((activeFilter!=='all'||activePersonFilter)&&tasks.length===0)return;

    visibleProjects++;totalTasks+=tasks.length;
    progressCount+=tasks.filter(t=>t.status==='progress').length;
    overdueCount+=tasks.filter(t=>isOverdue(t)).length;
    // Progress bar uses all tasks (including done in backlog) to show true project progress
    const allProjectTasks=project.tasks;
    const doneInPAll=allProjectTasks.filter(t=>t.status==='done').length;doneCount+=doneInPAll;
    const pct=allProjectTasks.length?Math.round((doneInPAll/allProjectTasks.length)*100):0;
    tasks.forEach(t=>{if(t.deadline==='today')todayCount++;else if(t.deadline==='tomorrow')tomorrowCount++;else if(t.deadline==='daily')dailyCount++;else if(t.deadline==='weekly')weeklyCount++});

    const el=document.createElement('div');el.className='project';
    el.innerHTML=`
      <div class="project-header">
        <div class="project-title-area" onclick="toggleProject(this.parentElement)"><div class="project-icon" style="background:${project.color}">${project.name.charAt(0)}</div><div><span class="project-name">${esc(project.name)}</span><span class="project-count">${tasks.length} task${tasks.length!==1?'s':''}</span></div></div>
        <div class="project-right">
          <div class="project-progress" onclick="toggleProject(this.parentElement.parentElement)"><div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div><span class="progress-text">${pct}%</span><span class="chevron">▼</span></div>
          ${canManage()?`<button class="icon-btn danger" title="Delete project" onclick="event.stopPropagation();openDeleteModal(${pi})">🗑</button>`:''}
        </div>
      </div>
      <div class="task-list">
        <div class="task-header"><div></div><div>Task</div><div>Deadline</div><div>Person</div><div>Priority</div><div>Status</div><div></div></div>
        ${tasks.map(t=>{
          const ri=project.tasks.indexOf(t),isDone=t.status==='done',isProg=t.status==='progress',overdue=isOverdue(t),isMyTask=currentUser&&t.person===currentUser.displayName;
          let rowCls=isDone?'done':(isProg?'in-progress':'');if(overdue&&!isDone)rowCls+=' overdue-row';if(isMyTask)rowCls+=' my-task';
          const statusCls=isDone?'s-done':(isProg?'s-progress':''),dlClass=getDeadlineClass(t.deadline,t);
          const canEdit=canEditTask(),canStatus=canChangeStatus(t),dis=canEdit?'':'disabled',sDis=canStatus?'':'disabled';
          return `<div class="task-row ${rowCls}">
            <div class="checkbox ${isDone?'checked':''}" ${canStatus?`onclick="toggleCheck(${pi},${ri})"`:'style="opacity:.4;cursor:default"'}></div>
            <div class="task-text-wrap">${overdue?'<span class="overdue-icon">⚠ <span class="overdue-tip">OVERDUE</span></span>':''}<span class="task-text">${esc(t.text)}</span></div>
            ${canEdit?`<div class="deadline-cell" onclick="event.stopPropagation();toggleDeadlinePopover('pop-${pi}-${ri}')"><span class="deadline-badge ${dlClass}">${getDeadlineLabel(t.deadline)}</span><span class="deadline-edit-icon">✎</span><div class="deadline-popover" id="pop-${pi}-${ri}"><select id="dltype-${pi}-${ri}" onchange="togglePopDateField(${pi},${ri})"><option value="today" ${t.deadline==='today'?'selected':''}>Today</option><option value="tomorrow" ${t.deadline==='tomorrow'?'selected':''}>Tomorrow</option><option value="daily" ${t.deadline==='daily'?'selected':''}>Daily</option><option value="weekly" ${t.deadline==='weekly'?'selected':''}>Weekly</option><option value="pending" ${t.deadline==='pending'?'selected':''}>Pending</option><option value="date" ${(t.deadline&&t.deadline.includes('-'))?'selected':''}>Pick a Date</option></select><input type="date" id="dldate-${pi}-${ri}" value="${(t.deadline&&t.deadline.includes('-'))?t.deadline:''}" style="display:${(t.deadline&&t.deadline.includes('-'))?'block':'none'}"><div class="pop-actions"><button class="pop-btn pop-btn-cancel" onclick="event.stopPropagation();closeDeadlinePopover()">Cancel</button><button class="pop-btn pop-btn-save" onclick="event.stopPropagation();saveDeadline(${pi},${ri})">Save</button></div></div></div>`:`<div><span class="deadline-badge ${dlClass}">${getDeadlineLabel(t.deadline)}</span></div>`}
            <div><select class="person-select" ${dis} onchange="PROJECTS[${pi}].tasks[${ri}].person=this.value;saveProjects();renderTeamBar()">${PEOPLE.map(p=>`<option value="${esc(p)}" ${t.person===p?'selected':''}>${esc(p)}</option>`).join('')}</select></div>
            <div><select class="priority-select p-${t.priority}" ${dis} onchange="setPriority(${pi},${ri},this.value)"><option value="high" ${t.priority==='high'?'selected':''}>🔴 High</option><option value="medium" ${t.priority==='medium'?'selected':''}>🟡 Medium</option><option value="low" ${t.priority==='low'?'selected':''}>🔵 Low</option></select></div>
            <div><select class="status-select ${statusCls}" ${sDis} onchange="setStatus(${pi},${ri},this.value)"><option value="todo" ${t.status==='todo'?'selected':''}>To Do</option><option value="progress" ${t.status==='progress'?'selected':''}>In Progress</option><option value="done" ${t.status==='done'?'selected':''}>Done</option></select></div>
            <div>${canEdit?`<button class="icon-btn" title="Edit task" onclick="openEditTask(${pi},${ri})">✎</button>`:''}</div>
          </div>`}).join('')}
        ${canManage()?`<div class="add-task-row" onclick="openTaskModal(${pi})"><div class="add-icon">+</div><span class="add-task-label">Add task</span></div>`:''}
      </div>`;
    container.appendChild(el);
  });
  document.getElementById('projectCount').textContent=visibleProjects;
  document.getElementById('totalTasks').textContent=totalTasks;
  document.getElementById('statToday').textContent=todayCount;document.getElementById('statTomorrow').textContent=tomorrowCount;
  document.getElementById('statDaily').textContent=dailyCount;document.getElementById('statWeekly').textContent=weeklyCount;
  document.getElementById('statOverdue').textContent=overdueCount;document.getElementById('statProgress').textContent=progressCount;
  document.getElementById('statDone').textContent=doneCount;renderTeamBar();
}

function updateStats(){
  let todayCount=0,tomorrowCount=0,dailyCount=0,weeklyCount=0,overdueCount=0,progressCount=0,doneCount=0,totalTasks=0,visibleProjects=0;
  PROJECTS.forEach(p=>{if(!canSeeProject(p))return;visibleProjects++;p.tasks.forEach(t=>{totalTasks++;if(t.status==='done')doneCount++;if(t.status==='progress')progressCount++;if(isOverdue(t))overdueCount++;if(t.deadline==='today')todayCount++;else if(t.deadline==='tomorrow')tomorrowCount++;else if(t.deadline==='daily')dailyCount++;else if(t.deadline==='weekly')weeklyCount++})});
  document.getElementById('projectCount').textContent=visibleProjects;document.getElementById('totalTasks').textContent=totalTasks;
  document.getElementById('statToday').textContent=todayCount;document.getElementById('statTomorrow').textContent=tomorrowCount;
  document.getElementById('statDaily').textContent=dailyCount;document.getElementById('statWeekly').textContent=weeklyCount;
  document.getElementById('statOverdue').textContent=overdueCount;document.getElementById('statProgress').textContent=progressCount;document.getElementById('statDone').textContent=doneCount;
}

function toggleProject(h){h.closest('.project').classList.toggle('collapsed')}
function toggleCheck(pi,ti){const t=PROJECTS[pi].tasks[ti];if(!canChangeStatus(t))return;const was=t.status;t.status=t.status==='done'?'todo':'done';logActivity(t.status==='done'?'completed':'reopened',`"${t.text}" in ${PROJECTS[pi].name}`);showToast(t.status==='done'?`Task completed`:'Task reopened',t.status==='done'?'success':'info');saveProjects();render()}
function setStatus(pi,ti,v){if(!canChangeStatus(PROJECTS[pi].tasks[ti]))return;PROJECTS[pi].tasks[ti].status=v;logActivity('status changed',`"${PROJECTS[pi].tasks[ti].text}" → ${v}`);saveProjects();render()}
function setPriority(pi,ti,v){if(!canManage())return;PROJECTS[pi].tasks[ti].priority=v;logActivity('priority changed',`"${PROJECTS[pi].tasks[ti].text}" → ${v}`);saveProjects();render()}

// Deadline popover
function toggleDeadlinePopover(id){closeDeadlinePopover();const p=document.getElementById(id);if(p){const trigger=p.parentElement;const rect=trigger.getBoundingClientRect();let top=rect.bottom+4;let left=rect.left;p.classList.add('show');openPopover=p;const pH=p.offsetHeight;const pW=p.offsetWidth;if(top+pH>window.innerHeight)top=rect.top-pH-4;if(left+pW>window.innerWidth)left=window.innerWidth-pW-12;if(left<8)left=8;p.style.top=top+'px';p.style.left=left+'px'}}
function closeDeadlinePopover(){if(openPopover){openPopover.classList.remove('show');openPopover=null}}
function togglePopDateField(pi,ri){document.getElementById(`dldate-${pi}-${ri}`).style.display=document.getElementById(`dltype-${pi}-${ri}`).value==='date'?'block':'none'}
function saveDeadline(pi,ri){let dl=document.getElementById(`dltype-${pi}-${ri}`).value;if(dl==='date')dl=document.getElementById(`dldate-${pi}-${ri}`).value||'pending';PROJECTS[pi].tasks[ri].deadline=dl;logActivity('deadline changed',`"${PROJECTS[pi].tasks[ri].text}" → ${dl}`);saveProjects();closeDeadlinePopover();render()}
document.addEventListener('click',e=>{if(openPopover&&!e.target.closest('.deadline-cell'))closeDeadlinePopover()});

// ═══ TASK MODAL (Add & Edit) ═══
function openTaskModal(pi){
  editingTask=null;taskModalProjectIndex=pi;
  document.getElementById('taskModalTitle').textContent='Add New Task';
  document.getElementById('taskModalSaveBtn').textContent='Add Task';
  document.getElementById('modalProjectName').textContent=PROJECTS[pi].name;
  document.getElementById('newTaskText').value='';document.getElementById('newDeadlineType').value='today';
  document.getElementById('newDeadlineDate').value='';document.getElementById('newPriority').value='medium';
  document.getElementById('datePickerField').style.display='none';
  document.getElementById('newPerson').innerHTML=getPeopleList().map(p=>`<option value="${p}">${p}</option>`).join('');
  document.getElementById('taskModalOverlay').classList.add('open');
  setTimeout(()=>document.getElementById('newTaskText').focus(),200);
}
function openEditTask(pi,ti){
  const t=PROJECTS[pi].tasks[ti];editingTask={pi,ti};taskModalProjectIndex=pi;
  document.getElementById('taskModalTitle').textContent='Edit Task';
  document.getElementById('taskModalSaveBtn').textContent='Save Changes';
  document.getElementById('modalProjectName').textContent=PROJECTS[pi].name;
  document.getElementById('newTaskText').value=t.text;
  if(t.deadline&&t.deadline.includes('-')){document.getElementById('newDeadlineType').value='date';document.getElementById('newDeadlineDate').value=t.deadline;document.getElementById('datePickerField').style.display='block'}else{document.getElementById('newDeadlineType').value=t.deadline||'today';document.getElementById('newDeadlineDate').value='';document.getElementById('datePickerField').style.display='none'}
  document.getElementById('newPriority').value=t.priority;
  const PEOPLE=getPeopleList();document.getElementById('newPerson').innerHTML=PEOPLE.map(p=>`<option value="${p}" ${t.person===p?'selected':''}>${p}</option>`).join('');
  document.getElementById('taskModalOverlay').classList.add('open');
  setTimeout(()=>document.getElementById('newTaskText').focus(),200);
}
function closeTaskModal(){document.getElementById('taskModalOverlay').classList.remove('open');taskModalProjectIndex=null;editingTask=null}
function toggleDateField(){document.getElementById('datePickerField').style.display=document.getElementById('newDeadlineType').value==='date'?'block':'none'}
function saveTaskModal(){
  const text=document.getElementById('newTaskText').value.trim();if(!text)return;
  let dt=document.getElementById('newDeadlineType').value,deadline=dt;
  if(dt==='date')deadline=document.getElementById('newDeadlineDate').value||'pending';
  const person=document.getElementById('newPerson').value,priority=document.getElementById('newPriority').value;
  if(editingTask){
    const t=PROJECTS[editingTask.pi].tasks[editingTask.ti];
    t.text=text;t.deadline=deadline;t.person=person;t.priority=priority;
    logActivity('edited task',`"${text}" in ${PROJECTS[editingTask.pi].name}`);
    showToast('Task updated','success');
  }else{
    if(taskModalProjectIndex===null)return;
    PROJECTS[taskModalProjectIndex].tasks.push({text,person,deadline,priority,status:'todo'});
    logActivity('added task',`"${text}" to ${PROJECTS[taskModalProjectIndex].name}`);
    showToast('Task added','success');
  }
  saveProjects();closeTaskModal();render();
}
document.getElementById('taskModalOverlay').addEventListener('click',e=>{if(e.target===e.currentTarget)closeTaskModal()});

// Project Modal
function openProjectModal(){document.getElementById('newProjectName').value='';selectedProjectColor=PROJECT_COLORS[0];renderColorOptions();document.getElementById('projectModalOverlay').classList.add('open');setTimeout(()=>document.getElementById('newProjectName').focus(),200)}
function closeProjectModal(){document.getElementById('projectModalOverlay').classList.remove('open')}
function renderColorOptions(){document.getElementById('colorOptions').innerHTML=PROJECT_COLORS.map(c=>`<div class="color-swatch ${c===selectedProjectColor?'selected':''}" style="background:${c}" onclick="selectedProjectColor='${c}';renderColorOptions()"></div>`).join('')}
function addProject(){const name=document.getElementById('newProjectName').value.trim();if(!name)return;PROJECTS.push({name,color:selectedProjectColor,visibility:{},tasks:[]});logActivity('created project',name);showToast(`Project "${name}" created`,'success');saveProjects();closeProjectModal();render()}
document.getElementById('projectModalOverlay').addEventListener('click',e=>{if(e.target===e.currentTarget)closeProjectModal()});

// Delete Modal
function openDeleteModal(pi){deleteProjectIndex=pi;document.getElementById('deleteProjectName').textContent=PROJECTS[pi].name;document.getElementById('deleteModalOverlay').classList.add('open')}
function closeDeleteModal(){document.getElementById('deleteModalOverlay').classList.remove('open');deleteProjectIndex=null}
function confirmDeleteProject(){if(deleteProjectIndex!==null){const name=PROJECTS[deleteProjectIndex].name;PROJECTS.splice(deleteProjectIndex,1);logActivity('deleted project',name);showToast(`Project "${name}" deleted`,'warning');saveProjects()}closeDeleteModal();render()}
document.getElementById('deleteModalOverlay').addEventListener('click',e=>{if(e.target===e.currentTarget)closeDeleteModal()});

// ═══ SETTINGS ═══
function openSettingsModal(){renderSettings();document.getElementById('settingsModalOverlay').classList.add('open')}
function closeSettingsModal(){document.getElementById('settingsModalOverlay').classList.remove('open');render()}
document.getElementById('settingsModalOverlay').addEventListener('click',e=>{if(e.target===e.currentTarget)closeSettingsModal()});

function renderSettings(){
  const body=document.getElementById('settingsBody');
  body.innerHTML=`
    <div class="settings-section">
      <h3>👥 Users & Roles</h3>
      <p style="font-size:.82rem;color:var(--text-muted);margin-bottom:12px"><span style="color:var(--accent)">●</span> Owner &nbsp;<span style="color:#5ca0e0">●</span> Manager &nbsp;<span style="color:var(--text-muted)">●</span> User</p>
      ${USERS.map((u,i)=>{
        const rc=getRoleColor(u.role),rl=getRoleLabel(u.role);
        let actions='';
        if(u.role==='owner'){actions='<span style="font-size:.72rem;color:var(--text-muted);font-style:italic">God Mode</span>'}
        else{const pb=u.role==='user'?`<button class="settings-remove-btn" style="border-color:#5ca0e0;color:#5ca0e0" onclick="setRole(${i},'manager')">↑ Manager</button>`:`<button class="settings-remove-btn" onclick="setRole(${i},'user')">↓ User</button>`;actions=`${pb}<button class="settings-remove-btn" onclick="removeUser(${i})">Remove</button>`}
        return `<div class="settings-user-row"><div class="settings-user-info"><div class="settings-user-avatar" style="background:${rc}">${u.displayName.charAt(0)}</div><div><div class="settings-user-name">${esc(u.displayName)} <span style="color:${rc};font-size:.72rem;font-weight:600">${rl.toUpperCase()}</span></div><div class="settings-user-pass">Password: ${u.password}</div></div></div><div style="display:flex;gap:6px;align-items:center">${actions}</div></div>`
      }).join('')}
      <div style="margin-top:12px"><div class="settings-add-row"><input type="text" id="addUserName" placeholder="Username"><input type="text" id="addUserPass" placeholder="4-digit PIN" maxlength="4"><select id="addUserRole"><option value="user">User</option><option value="manager">Manager</option></select><button class="settings-add-btn" onclick="addUser()">+ Add</button></div></div>
    </div>
    <div class="settings-section">
      <h3>📁 Project Visibility</h3>
      <p style="font-size:.82rem;color:var(--text-muted);margin-bottom:12px">Toggle which projects each user/manager can see. Owner always sees all.</p>
      ${PROJECTS.map((p,pi)=>{
        const toggleUsers=USERS.filter(u=>u.role!=='owner');
        if(!toggleUsers.length)return'<p style="font-size:.82rem;color:var(--text-muted)">No users to configure.</p>';
        return `<div class="vis-project-row"><div class="vis-project-name" style="color:${p.color}">● ${esc(p.name)}</div><div class="vis-toggles">${toggleUsers.map(u=>{const isOn=p.visibility[u.username]!==false;const roleTag=u.role==='manager'?'<span style="font-size:.6rem;color:#5ca0e0"> M</span>':'';return `<button class="vis-toggle ${isOn?'on':''}" onclick="toggleVisibility(${pi},'${esc(u.username)}')">${esc(u.displayName)}${roleTag}</button>`}).join('')}</div></div>`
      }).join('')}
    </div>`;
}
function setRole(i,role){if(USERS[i].role==='owner')return;USERS[i].role=role;saveUsers();renderSettings()}
function removeUser(i){if(USERS[i].role==='owner')return;USERS.splice(i,1);saveUsers();renderSettings()}
function addUser(){const name=document.getElementById('addUserName').value.trim(),pass=document.getElementById('addUserPass').value.trim(),role=document.getElementById('addUserRole').value;if(!name){alert('Please enter a username');return}if(!pass||pass.length!==4||isNaN(pass)){alert('Please enter a 4-digit PIN');return}if(USERS.find(u=>u.username.toLowerCase()===name.toLowerCase())){alert('Username already exists');return}USERS.push({username:name,password:pass,role,displayName:name});saveUsers();renderSettings()}
function toggleVisibility(pi,username){const p=PROJECTS[pi];if(p.visibility[username]===false)delete p.visibility[username];else p.visibility[username]=false;saveProjects();renderSettings()}

// ═══ VIEW SWITCHING ═══
const viewContainers=['dashboardContainer','projectContainer','hrContainer','timeContainer','crmContainer','docsContainer','financialContainer'];
const viewBtns=['viewDashBtn','viewTasksBtn','viewHrBtn','viewTimeBtn','viewCrmBtn','viewDocsBtn','viewFinBtn'];
const viewNames=['dashboard','tasks','hr','timetracking','crm','docs','financials'];
const viewLabels={dashboard:'Dashboard',tasks:'',hr:'HR Directory',timetracking:'Time Tracking',crm:'Contacts',docs:'Documents',financials:'Financials'};
function switchView(view){
  const managerOnly=['dashboard','timetracking','crm','docs','financials'];
  if(managerOnly.includes(view)&&!canManage()){view='tasks'}
  currentView=view;
  viewBtns.forEach(id=>{const el=document.getElementById(id);if(el)el.classList.toggle('active',viewNames[viewBtns.indexOf(id)]===view)});
  viewContainers.forEach(id=>{document.getElementById(id).style.display='none'});
  const tasksHeader=document.getElementById('tasksHeaderSection');
  const h1=document.querySelector('.header-left h1');
  const subtitle=document.querySelector('.header-left .subtitle');
  tasksHeader.style.display=view==='tasks'?'':'none';
  subtitle.style.display=view==='tasks'?'':'none';
  if(viewLabels[view]){h1.innerHTML='<span class="brand-accent">M</span>PIRE'+(viewLabels[view]?` <span style="font-weight:500;color:var(--text-secondary);font-size:.85em">${viewLabels[view]}</span>`:'')}
  else{h1.innerHTML='<span class="brand-accent">M</span>PIRE'}
  const containerMap={dashboard:'dashboardContainer',tasks:'projectContainer',hr:'hrContainer',timetracking:'timeContainer',crm:'crmContainer',docs:'docsContainer',financials:'financialContainer'};
  const c=document.getElementById(containerMap[view]);
  c.style.display='';c.classList.add('view-fade');setTimeout(()=>c.classList.remove('view-fade'),400);
  if(view==='tasks')render();
  else if(view==='financials')renderFinancialDashboard();
  else if(view==='dashboard')renderExecDashboard();
  else if(view==='hr')renderHR();
  else if(view==='timetracking')renderTimeTracking();
  else if(view==='crm')renderCRM();
  else if(view==='docs')renderDocs();
}

function handleFinFileUpload(files){
  Array.from(files).forEach(file=>{
    if(!file.name.match(/\.(xlsx|xls|csv)$/i)){alert('Please upload Excel files (.xlsx, .xls) or CSV files');return}
    const reader=new FileReader();
    reader.onload=function(e){
      try{
        const wb=XLSX.read(e.target.result,{type:'array'});
        const parsed=parsePLFromWorkbook(wb,file.name);
        if(parsed){
          financialData.push(parsed);
          saveFinancialData();
          activeFinBusiness=financialData.length-1;
          renderFinancialDashboard();
        }else{alert('Could not find P&L data in "'+file.name+'". Make sure the file contains a Profit & Loss sheet with recognizable line items (Revenue, Cost, Profit, etc.).')}
      }catch(err){alert('Error reading file: '+err.message)}
    };
    reader.readAsArrayBuffer(file);
  });
}

function removeFinBusiness(idx){
  financialData.splice(idx,1);
  saveFinancialData();
  if(activeFinBusiness>=financialData.length)activeFinBusiness=financialData.length>0?0:null;
  if(financialData.length===0)activeFinBusiness=null;
  renderFinancialDashboard();
}

// ═══ P&L AUTO-DETECTION ═══
const PL_KEYWORDS={
  revenue:['revenue','total revenue','sales','total sales','net revenue','net sales','income','total income','turnover','gross revenue'],
  cogs:['cost of goods sold','cogs','cost of sales','cost of revenue','direct costs','cost of goods','cos'],
  grossProfit:['gross profit','gross income','gross margin'],
  opex:['operating expenses','total operating expenses','total expenses','operating costs','overhead','selling general','sg&a','admin expenses','general & administrative','general and administrative'],
  operatingIncome:['operating income','operating profit','ebit','earnings before interest'],
  netProfit:['net profit','net income','net earnings','profit after tax','net profit/(loss)','net income/(loss)','profit for the period','profit for the year','bottom line','net profit after tax'],
  ebitda:['ebitda','earnings before interest tax depreciation'],
  depreciation:['depreciation','depreciation & amortization','depreciation and amortization','d&a'],
  interest:['interest expense','interest','finance costs','financial expenses'],
  tax:['tax','income tax','tax expense','provision for taxes','taxation']
};

function matchPLKey(label){
  if(!label)return null;
  const l=label.toString().toLowerCase().replace(/[^a-z0-9&/ ]/g,'').trim();
  if(!l)return null;
  for(const[key,patterns]of Object.entries(PL_KEYWORDS)){
    for(const p of patterns){if(l===p||l.startsWith(p))return key}
  }
  return null;
}

function detectPeriodHeaders(row){
  const periods=[];
  const monthPat=/^(jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)/i;
  const qPat=/^q[1-4]/i;
  const yearPat=/^(19|20)\d{2}$/;
  const dateMonthPat=/^\d{1,2}[\/\-]\d{4}$/;
  for(let c=1;c<row.length;c++){
    const v=row[c];
    if(v==null)continue;
    const s=v.toString().trim();
    if(monthPat.test(s)||qPat.test(s)||yearPat.test(s)||dateMonthPat.test(s)){
      periods.push({col:c,label:s});
    }
  }
  return periods;
}

function parsePLFromWorkbook(wb,fileName){
  // Try to find a P&L sheet by name
  const plNamePats=[/p\s*[&\/]\s*l/i,/profit/i,/loss/i,/income\s*statement/i,/pnl/i];
  let targetSheet=null;
  for(const name of wb.SheetNames){
    for(const pat of plNamePats){if(pat.test(name)){targetSheet=name;break}}
    if(targetSheet)break;
  }
  // If not found by name, scan all sheets for P&L content
  const sheetsToTry=targetSheet?[targetSheet]:wb.SheetNames;
  for(const sheetName of sheetsToTry){
    const ws=wb.Sheets[sheetName];
    const data=XLSX.utils.sheet_to_json(ws,{header:1,defval:null});
    if(!data||data.length<3)continue;
    const result=extractPLData(data);
    if(result){
      const bizName=fileName.replace(/\.(xlsx|xls|csv)$/i,'').replace(/[_-]/g,' ');
      return{businessName:bizName,fileName,sheetName,...result};
    }
  }
  return null;
}

function extractPLData(data){
  let periods=[];
  let headerRow=-1;
  // Find the header row with period labels
  for(let r=0;r<Math.min(data.length,15);r++){
    const row=data[r];
    if(!row)continue;
    const detected=detectPeriodHeaders(row);
    if(detected.length>=1){periods=detected;headerRow=r;break}
  }
  // If no period headers found, treat as single-period (column B = values)
  if(periods.length===0){
    // Check if column B has numbers for known P&L rows
    const singlePeriod=extractSinglePeriod(data);
    if(singlePeriod)return singlePeriod;
    return null;
  }
  // Extract P&L values
  const plData={periods:periods.map(p=>p.label),revenue:[],cogs:[],grossProfit:[],opex:[],operatingIncome:[],netProfit:[],ebitda:[],depreciation:[],interest:[],tax:[],otherRows:[]};
  let foundAny=false;
  for(let r=headerRow+1;r<data.length;r++){
    const row=data[r];
    if(!row||!row[0])continue;
    const label=row[0].toString().trim();
    const key=matchPLKey(label);
    const values=periods.map(p=>{const v=row[p.col];return typeof v==='number'?v:(parseFloat(String(v).replace(/[,$()]/g,''))||0)});
    if(key&&plData[key]!==undefined){
      if(plData[key].length===0){plData[key]=values;foundAny=true}
      else{plData.otherRows.push({label,key,values})}
    }else if(label&&values.some(v=>v!==0)){
      plData.otherRows.push({label,key:null,values});
    }
  }
  if(!foundAny)return null;
  // Auto-calculate missing fields
  if(plData.revenue.length&&plData.cogs.length&&!plData.grossProfit.length){
    plData.grossProfit=plData.revenue.map((r,i)=>r-(plData.cogs[i]||0));
  }
  if(plData.grossProfit.length&&plData.opex.length&&!plData.netProfit.length&&!plData.operatingIncome.length){
    plData.netProfit=plData.grossProfit.map((g,i)=>g-Math.abs(plData.opex[i]||0));
  }
  return{parsedPL:plData};
}

function extractSinglePeriod(data){
  const plData={periods:['Total'],revenue:[],cogs:[],grossProfit:[],opex:[],operatingIncome:[],netProfit:[],ebitda:[],depreciation:[],interest:[],tax:[],otherRows:[]};
  let foundAny=false;
  for(let r=0;r<data.length;r++){
    const row=data[r];
    if(!row||!row[0])continue;
    const label=row[0].toString().trim();
    const key=matchPLKey(label);
    // Find first numeric value in the row
    let val=0;
    for(let c=1;c<row.length;c++){
      const v=row[c];
      if(typeof v==='number'){val=v;break}
      const parsed=parseFloat(String(v||'').replace(/[,$()]/g,''));
      if(!isNaN(parsed)){val=parsed;break}
    }
    if(key&&plData[key]!==undefined&&plData[key].length===0){
      plData[key]=[val];foundAny=true;
    }else if(label&&val!==0){
      plData.otherRows.push({label,key,values:[val]});
    }
  }
  if(!foundAny)return null;
  if(plData.revenue.length&&plData.cogs.length&&!plData.grossProfit.length){
    plData.grossProfit=plData.revenue.map((r,i)=>r-(plData.cogs[i]||0));
  }
  return{parsedPL:plData};
}

// ═══ FINANCIAL KPI HELPERS ═══
function fmtMoney(n){
  if(n==null||isNaN(n))return'—';
  const abs=Math.abs(n);
  const sign=n<0?'-':'';
  if(abs>=1e9)return sign+(abs/1e9).toFixed(1)+'B';
  if(abs>=1e6)return sign+(abs/1e6).toFixed(1)+'M';
  if(abs>=1e3)return sign+(abs/1e3).toFixed(1)+'K';
  return sign+abs.toFixed(0);
}
function fmtPct(n){return n==null||isNaN(n)?'—':n.toFixed(1)+'%'}
function arrSum(a){return a.reduce((s,v)=>s+(v||0),0)}
function arrLast(a){return a.length?a[a.length-1]:0}
function calcGrowth(a){if(a.length<2)return null;const prev=a[a.length-2],cur=a[a.length-1];if(!prev)return null;return((cur-prev)/Math.abs(prev))*100}

// ═══ RENDER FINANCIAL DASHBOARD ═══
function destroyFinCharts(){Object.values(finCharts).forEach(c=>{if(c&&c.destroy)c.destroy()});finCharts={}}

function renderFinancialDashboard(){
  destroyFinCharts();
  const container=document.getElementById('financialContainer');
  if(!financialData.length){
    container.innerHTML=`
      <div class="fin-upload-area" id="finUploadArea" onclick="document.getElementById('finFileInput').click()" ondragover="event.preventDefault();this.classList.add('dragover')" ondragleave="this.classList.remove('dragover')" ondrop="event.preventDefault();this.classList.remove('dragover');handleFinFileUpload(event.dataTransfer.files)">
        <div class="fin-upload-icon">📊</div>
        <div class="fin-upload-title">Upload P&L Excel File</div>
        <div class="fin-upload-sub">Drag & drop your Excel file here, or click to browse. Each file represents one business.</div>
        <input type="file" id="finFileInput" class="fin-upload-input" accept=".xlsx,.xls,.csv" multiple onchange="handleFinFileUpload(this.files)">
      </div>
      <div class="fin-empty">
        <div class="fin-empty-icon">📈</div>
        <div class="fin-empty-title">No Financial Data Yet</div>
        <div class="fin-empty-sub">Upload Excel files with P&L sheets to see your financial KPIs, charts, and performance metrics.</div>
      </div>`;
    return;
  }
  // Build HTML
  let html=`
    <div class="fin-upload-area" style="padding:18px 24px;margin-bottom:20px;display:flex;align-items:center;gap:16px;cursor:pointer" onclick="document.getElementById('finFileInput').click()" ondragover="event.preventDefault();this.classList.add('dragover')" ondragleave="this.classList.remove('dragover')" ondrop="event.preventDefault();this.classList.remove('dragover');handleFinFileUpload(event.dataTransfer.files)">
      <span style="font-size:1.3rem">📊</span>
      <div><div style="font-size:.88rem;font-weight:600">Upload Another Business</div><div style="font-size:.78rem;color:var(--text-muted)">Drop Excel file or click to browse</div></div>
      <input type="file" id="finFileInput" class="fin-upload-input" accept=".xlsx,.xls,.csv" multiple onchange="handleFinFileUpload(this.files)">
    </div>
    <div class="fin-business-tabs">
      <button class="fin-tab fin-overview-tab ${activeFinBusiness===null?'active':''}" onclick="activeFinBusiness=null;renderFinancialDashboard()">Overview</button>
      ${financialData.map((b,i)=>`<button class="fin-tab ${activeFinBusiness===i?'active':''}" onclick="activeFinBusiness=${i};renderFinancialDashboard()">${esc(b.businessName)}<span class="tab-remove" onclick="event.stopPropagation();removeFinBusiness(${i})">✕</span></button>`).join('')}
    </div>`;
  if(activeFinBusiness===null){
    html+=renderFinOverview();
  }else{
    html+=renderFinBusiness(financialData[activeFinBusiness]);
  }
  container.innerHTML=html;
  // Render charts after DOM is ready
  setTimeout(()=>{
    if(activeFinBusiness===null)renderOverviewCharts();
    else renderBusinessCharts(financialData[activeFinBusiness]);
  },50);
}

function renderFinOverview(){
  // Aggregate across all businesses
  let totalRevenue=0,totalCogs=0,totalGP=0,totalOpex=0,totalNet=0,bizCount=financialData.length;
  const bizSummaries=[];
  financialData.forEach(b=>{
    const pl=b.parsedPL;
    const rev=arrSum(pl.revenue),cogs=arrSum(pl.cogs),gp=arrSum(pl.grossProfit),opex=arrSum(pl.opex),net=arrSum(pl.netProfit);
    totalRevenue+=rev;totalCogs+=cogs;totalGP+=gp;totalOpex+=opex;totalNet+=net;
    bizSummaries.push({name:b.businessName,revenue:rev,cogs,grossProfit:gp,opex,netProfit:net,margin:rev?((net/rev)*100):0});
  });
  const totalGrossMargin=totalRevenue?((totalGP/totalRevenue)*100):0;
  const totalNetMargin=totalRevenue?((totalNet/totalRevenue)*100):0;
  return `
    <div class="fin-kpi-grid">
      <div class="fin-kpi"><div class="fin-kpi-label">Total Revenue</div><div class="fin-kpi-value gold">${fmtMoney(totalRevenue)}</div><div class="fin-kpi-sub">${bizCount} business${bizCount!==1?'es':''}</div></div>
      <div class="fin-kpi"><div class="fin-kpi-label">Total Gross Profit</div><div class="fin-kpi-value green">${fmtMoney(totalGP)}</div><div class="fin-kpi-sub">Margin: ${fmtPct(totalGrossMargin)}</div></div>
      <div class="fin-kpi"><div class="fin-kpi-label">Total Net Profit</div><div class="fin-kpi-value ${totalNet>=0?'green':'red'}">${fmtMoney(totalNet)}</div><div class="fin-kpi-sub">Margin: ${fmtPct(totalNetMargin)}</div></div>
      <div class="fin-kpi"><div class="fin-kpi-label">Total Expenses</div><div class="fin-kpi-value red">${fmtMoney(totalCogs+totalOpex)}</div><div class="fin-kpi-sub">COGS: ${fmtMoney(totalCogs)} + OpEx: ${fmtMoney(totalOpex)}</div></div>
    </div>
    <div class="fin-charts-row">
      <div class="fin-chart-card"><div class="fin-chart-title">Revenue by Business</div><div class="fin-chart-wrap"><canvas id="overviewRevenueChart"></canvas></div></div>
      <div class="fin-chart-card"><div class="fin-chart-title">Profit Margin Comparison</div><div class="fin-chart-wrap"><canvas id="overviewMarginChart"></canvas></div></div>
    </div>
    <div class="fin-details-table" style="--fin-detail-cols:200px repeat(6,minmax(80px,1fr))">
      <div class="fin-details-title">Business Performance Summary</div>
      <div class="fin-details-row header"><div>Business</div><div>Revenue</div><div>COGS</div><div>Gross Profit</div><div>OpEx</div><div>Net Profit</div><div>Margin</div></div>
      ${bizSummaries.map(b=>`<div class="fin-details-row"><div class="label">${esc(b.name)}</div><div>${fmtMoney(b.revenue)}</div><div class="neg">${fmtMoney(b.cogs)}</div><div class="pos">${fmtMoney(b.grossProfit)}</div><div class="neg">${fmtMoney(b.opex)}</div><div class="${b.netProfit>=0?'pos':'neg'}">${fmtMoney(b.netProfit)}</div><div class="${b.margin>=0?'pos':'neg'}">${fmtPct(b.margin)}</div></div>`).join('')}
      <div class="fin-details-row total"><div class="label">TOTAL</div><div>${fmtMoney(totalRevenue)}</div><div class="neg">${fmtMoney(totalCogs)}</div><div class="pos">${fmtMoney(totalGP)}</div><div class="neg">${fmtMoney(totalOpex)}</div><div class="${totalNet>=0?'pos':'neg'}">${fmtMoney(totalNet)}</div><div class="${totalNetMargin>=0?'pos':'neg'}">${fmtPct(totalNetMargin)}</div></div>
    </div>`;
}

function renderFinBusiness(biz){
  const pl=biz.parsedPL,periods=pl.periods;
  const totalRev=arrSum(pl.revenue),totalCogs=arrSum(pl.cogs),totalGP=arrSum(pl.grossProfit);
  const totalOpex=arrSum(pl.opex),totalNet=arrSum(pl.netProfit);
  const grossMargin=totalRev?((totalGP/totalRev)*100):0;
  const netMargin=totalRev?((totalNet/totalRev)*100):0;
  const revGrowth=calcGrowth(pl.revenue);
  const profitGrowth=calcGrowth(pl.netProfit);
  return `
    <div class="fin-kpi-grid">
      <div class="fin-kpi"><div class="fin-kpi-label">Revenue</div><div class="fin-kpi-value gold">${fmtMoney(totalRev)}</div><div class="fin-kpi-sub">${revGrowth!==null?`<span class="${revGrowth>=0?'up':'down'}">${revGrowth>=0?'▲':'▼'} ${fmtPct(Math.abs(revGrowth))}</span> vs prev period`:`${periods.length} period${periods.length!==1?'s':''}`}</div></div>
      <div class="fin-kpi"><div class="fin-kpi-label">Gross Profit</div><div class="fin-kpi-value green">${fmtMoney(totalGP)}</div><div class="fin-kpi-sub">Margin: ${fmtPct(grossMargin)}</div></div>
      <div class="fin-kpi"><div class="fin-kpi-label">Net Profit</div><div class="fin-kpi-value ${totalNet>=0?'green':'red'}">${fmtMoney(totalNet)}</div><div class="fin-kpi-sub">${profitGrowth!==null?`<span class="${profitGrowth>=0?'up':'down'}">${profitGrowth>=0?'▲':'▼'} ${fmtPct(Math.abs(profitGrowth))}</span> vs prev`:`Margin: ${fmtPct(netMargin)}`}</div></div>
      <div class="fin-kpi"><div class="fin-kpi-label">Net Margin</div><div class="fin-kpi-value ${netMargin>=20?'green':netMargin>=0?'gold':'red'}">${fmtPct(netMargin)}</div><div class="fin-kpi-sub">Gross: ${fmtPct(grossMargin)}</div></div>
    </div>
    <div class="fin-kpi-grid" style="grid-template-columns:repeat(4,1fr)">
      <div class="fin-kpi"><div class="fin-kpi-label">COGS</div><div class="fin-kpi-value red">${fmtMoney(totalCogs)}</div><div class="fin-kpi-sub">${totalRev?fmtPct((totalCogs/totalRev)*100):''} of revenue</div></div>
      <div class="fin-kpi"><div class="fin-kpi-label">Operating Expenses</div><div class="fin-kpi-value red">${fmtMoney(totalOpex)}</div><div class="fin-kpi-sub">${totalRev?fmtPct((totalOpex/totalRev)*100):''} of revenue</div></div>
      <div class="fin-kpi"><div class="fin-kpi-label">EBITDA</div><div class="fin-kpi-value purple">${pl.ebitda.length?fmtMoney(arrSum(pl.ebitda)):'—'}</div><div class="fin-kpi-sub">${pl.ebitda.length&&totalRev?fmtPct((arrSum(pl.ebitda)/totalRev)*100)+' margin':''}</div></div>
      <div class="fin-kpi"><div class="fin-kpi-label">Last Period Revenue</div><div class="fin-kpi-value gold">${fmtMoney(arrLast(pl.revenue))}</div><div class="fin-kpi-sub">${periods.length?periods[periods.length-1]:''}</div></div>
    </div>
    ${periods.length>1?`
    <div class="fin-charts-row">
      <div class="fin-chart-card"><div class="fin-chart-title">Revenue & Profit Trend</div><div class="fin-chart-wrap"><canvas id="bizTrendChart"></canvas></div></div>
      <div class="fin-chart-card"><div class="fin-chart-title">Expense Breakdown</div><div class="fin-chart-wrap"><canvas id="bizExpenseChart"></canvas></div></div>
    </div>
    <div class="fin-charts-row" style="grid-template-columns:1fr 1fr">
      <div class="fin-chart-card"><div class="fin-chart-title">Margin Trend</div><div class="fin-chart-wrap"><canvas id="bizMarginChart"></canvas></div></div>
      <div class="fin-chart-card"><div class="fin-chart-title">Revenue vs Costs</div><div class="fin-chart-wrap"><canvas id="bizWaterfallChart"></canvas></div></div>
    </div>`:''}
    <div class="fin-details-table" style="--fin-detail-cols:200px repeat(${periods.length+1},minmax(80px,1fr))">
      <div class="fin-details-title">P&L Details — ${esc(biz.businessName)} (Sheet: ${esc(biz.sheetName||'—')})</div>
      <div class="fin-details-row header"><div>Line Item</div>${periods.map(p=>`<div>${esc(p)}</div>`).join('')}<div>Total</div></div>
      ${pl.revenue.length?`<div class="fin-details-row"><div class="label">Revenue</div>${pl.revenue.map(v=>`<div class="pos">${fmtMoney(v)}</div>`).join('')}<div class="pos"><strong>${fmtMoney(totalRev)}</strong></div></div>`:''}
      ${pl.cogs.length?`<div class="fin-details-row"><div class="label">COGS</div>${pl.cogs.map(v=>`<div class="neg">${fmtMoney(v)}</div>`).join('')}<div class="neg"><strong>${fmtMoney(totalCogs)}</strong></div></div>`:''}
      ${pl.grossProfit.length?`<div class="fin-details-row total"><div class="label">Gross Profit</div>${pl.grossProfit.map(v=>`<div class="pos">${fmtMoney(v)}</div>`).join('')}<div class="pos"><strong>${fmtMoney(totalGP)}</strong></div></div>`:''}
      ${pl.opex.length?`<div class="fin-details-row"><div class="label">Operating Expenses</div>${pl.opex.map(v=>`<div class="neg">${fmtMoney(v)}</div>`).join('')}<div class="neg"><strong>${fmtMoney(totalOpex)}</strong></div></div>`:''}
      ${pl.operatingIncome.length?`<div class="fin-details-row"><div class="label">Operating Income</div>${pl.operatingIncome.map(v=>`<div class="${v>=0?'pos':'neg'}">${fmtMoney(v)}</div>`).join('')}<div class="${arrSum(pl.operatingIncome)>=0?'pos':'neg'}"><strong>${fmtMoney(arrSum(pl.operatingIncome))}</strong></div></div>`:''}
      ${pl.depreciation.length?`<div class="fin-details-row"><div class="sub-label">Depreciation</div>${pl.depreciation.map(v=>`<div>${fmtMoney(v)}</div>`).join('')}<div>${fmtMoney(arrSum(pl.depreciation))}</div></div>`:''}
      ${pl.interest.length?`<div class="fin-details-row"><div class="sub-label">Interest</div>${pl.interest.map(v=>`<div class="neg">${fmtMoney(v)}</div>`).join('')}<div class="neg">${fmtMoney(arrSum(pl.interest))}</div></div>`:''}
      ${pl.tax.length?`<div class="fin-details-row"><div class="sub-label">Tax</div>${pl.tax.map(v=>`<div class="neg">${fmtMoney(v)}</div>`).join('')}<div class="neg">${fmtMoney(arrSum(pl.tax))}</div></div>`:''}
      ${pl.netProfit.length?`<div class="fin-details-row total"><div class="label">Net Profit</div>${pl.netProfit.map(v=>`<div class="${v>=0?'pos':'neg'}">${fmtMoney(v)}</div>`).join('')}<div class="${totalNet>=0?'pos':'neg'}"><strong>${fmtMoney(totalNet)}</strong></div></div>`:''}
      ${pl.ebitda.length?`<div class="fin-details-row"><div class="label">EBITDA</div>${pl.ebitda.map(v=>`<div class="pos">${fmtMoney(v)}</div>`).join('')}<div class="pos"><strong>${fmtMoney(arrSum(pl.ebitda))}</strong></div></div>`:''}
    </div>`;
}

// ═══ CHART RENDERING ═══
const chartColors=['#c9a46c','#42a5f5','#ab47bc','#ffa726','#66bb6a','#ef5350','#e08a5c','#5cc0b8'];
const chartDefaults={responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#9a9db4',font:{family:'DM Sans',size:11},padding:16}}},scales:{x:{ticks:{color:'#5c6078',font:{family:'DM Sans',size:10}},grid:{color:'rgba(255,255,255,.04)'},border:{color:'rgba(255,255,255,.06)'}},y:{ticks:{color:'#5c6078',font:{family:'DM Sans',size:10},callback:v=>fmtMoney(v)},grid:{color:'rgba(255,255,255,.04)'},border:{color:'rgba(255,255,255,.06)'}}}};

function renderOverviewCharts(){
  const revEl=document.getElementById('overviewRevenueChart');
  const margEl=document.getElementById('overviewMarginChart');
  if(!revEl||!margEl)return;
  const names=financialData.map(b=>b.businessName);
  const revenues=financialData.map(b=>arrSum(b.parsedPL.revenue));
  const margins=financialData.map(b=>{const rev=arrSum(b.parsedPL.revenue);const net=arrSum(b.parsedPL.netProfit);return rev?(net/rev)*100:0});
  finCharts.overviewRevenue=new Chart(revEl,{type:'bar',data:{labels:names,datasets:[{label:'Revenue',data:revenues,backgroundColor:chartColors.slice(0,names.length),borderRadius:6}]},options:{...chartDefaults,plugins:{...chartDefaults.plugins,legend:{display:false}}}});
  finCharts.overviewMargin=new Chart(margEl,{type:'bar',data:{labels:names,datasets:[{label:'Net Margin %',data:margins,backgroundColor:margins.map(m=>m>=0?'rgba(78,173,107,.7)':'rgba(255,77,106,.7)'),borderRadius:6}]},options:{...chartDefaults,plugins:{...chartDefaults.plugins,legend:{display:false}},scales:{...chartDefaults.scales,y:{...chartDefaults.scales.y,ticks:{...chartDefaults.scales.y.ticks,callback:v=>v+'%'}}}}});
}

function renderBusinessCharts(biz){
  const pl=biz.parsedPL,periods=pl.periods;
  if(periods.length<2)return;
  // Revenue & Profit trend
  const trendEl=document.getElementById('bizTrendChart');
  if(trendEl){
    const datasets=[{label:'Revenue',data:pl.revenue,borderColor:'#c9a46c',backgroundColor:'rgba(201,164,108,.1)',fill:true,tension:.3}];
    if(pl.grossProfit.length)datasets.push({label:'Gross Profit',data:pl.grossProfit,borderColor:'#4ead6b',backgroundColor:'rgba(78,173,107,.1)',fill:true,tension:.3});
    if(pl.netProfit.length)datasets.push({label:'Net Profit',data:pl.netProfit,borderColor:'#5ca0e0',backgroundColor:'rgba(92,160,224,.1)',fill:true,tension:.3});
    finCharts.bizTrend=new Chart(trendEl,{type:'line',data:{labels:periods,datasets},options:chartDefaults});
  }
  // Expense breakdown
  const expEl=document.getElementById('bizExpenseChart');
  if(expEl){
    const expLabels=[],expValues=[],expColors=[];
    if(pl.cogs.length){expLabels.push('COGS');expValues.push(Math.abs(arrSum(pl.cogs)));expColors.push('#e05c5c')}
    if(pl.opex.length){expLabels.push('OpEx');expValues.push(Math.abs(arrSum(pl.opex)));expColors.push('#e0a33c')}
    if(pl.depreciation.length){expLabels.push('Depreciation');expValues.push(Math.abs(arrSum(pl.depreciation)));expColors.push('#9b7ae0')}
    if(pl.interest.length){expLabels.push('Interest');expValues.push(Math.abs(arrSum(pl.interest)));expColors.push('#5ca0e0')}
    if(pl.tax.length){expLabels.push('Tax');expValues.push(Math.abs(arrSum(pl.tax)));expColors.push('#e08a5c')}
    if(expLabels.length){
      finCharts.bizExpense=new Chart(expEl,{type:'doughnut',data:{labels:expLabels,datasets:[{data:expValues,backgroundColor:expColors,borderColor:'#181a22',borderWidth:3}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right',labels:{color:'#8b8fa3',font:{family:'DM Sans',size:11},padding:12}}}}});
    }
  }
  // Margin trend
  const margEl=document.getElementById('bizMarginChart');
  if(margEl&&pl.revenue.length){
    const grossMargins=pl.revenue.map((r,i)=>r?(((pl.grossProfit[i]||0)/r)*100):0);
    const netMargins=pl.revenue.map((r,i)=>r?(((pl.netProfit[i]||0)/r)*100):0);
    finCharts.bizMargin=new Chart(margEl,{type:'line',data:{labels:periods,datasets:[{label:'Gross Margin %',data:grossMargins,borderColor:'#4ead6b',tension:.3},{label:'Net Margin %',data:netMargins,borderColor:'#5ca0e0',tension:.3}]},options:{...chartDefaults,scales:{...chartDefaults.scales,y:{...chartDefaults.scales.y,ticks:{...chartDefaults.scales.y.ticks,callback:v=>v.toFixed(0)+'%'}}}}});
  }
  // Revenue vs Costs bar
  const watEl=document.getElementById('bizWaterfallChart');
  if(watEl){
    finCharts.bizWaterfall=new Chart(watEl,{type:'bar',data:{labels:periods,datasets:[{label:'Revenue',data:pl.revenue,backgroundColor:'rgba(201,164,108,.7)',borderRadius:4},{label:'Total Costs',data:pl.revenue.map((r,i)=>(pl.cogs[i]||0)+(pl.opex[i]||0)),backgroundColor:'rgba(224,92,92,.5)',borderRadius:4}]},options:chartDefaults});
  }
}

// ═══ TASK VIEW SWITCHING (List / Kanban) ═══
function switchTaskView(view){
  currentTaskView=view;
  document.getElementById('listViewBtn').classList.toggle('active',view==='list');
  document.getElementById('kanbanViewBtn').classList.toggle('active',view==='kanban');
  render();
}

// ═══ KANBAN BOARD ═══
function renderKanban(){
  const container=document.getElementById('projectContainer');
  container.innerHTML='';
  container.classList.add('view-fade');
  setTimeout(()=>container.classList.remove('view-fade'),400);
  const allTasks=[];
  PROJECTS.forEach((p,pi)=>{
    if(!canSeeProject(p))return;
    p.tasks.forEach((t,ti)=>{
      let show=true;
      if(activeFilter!=='all'&&t.deadline!==activeFilter)show=false;
      if(activePersonFilter&&t.person!==activePersonFilter)show=false;
      if(show)allTasks.push({...t,pi,ti,projectName:p.name,projectColor:p.color});
    });
  });
  const todo=allTasks.filter(t=>t.status==='todo');
  const progress=allTasks.filter(t=>t.status==='progress');
  const done=allTasks.filter(t=>t.status==='done');

  function cardHTML(t){
    const dlClass=getDeadlineClass(t.deadline,t);
    const isMyTask=currentUser&&t.person===currentUser.displayName;
    const overdue=isOverdue(t);
    let cls='kanban-card';if(isMyTask)cls+=' my-task';if(overdue)cls+=' overdue-card';
    return `<div class="${cls}" data-pi="${t.pi}" data-ti="${t.ti}">
      <div class="kanban-card-title">${overdue?'<span style="color:var(--overdue);font-size:.75rem">⚠ </span>':''}${esc(t.text)}</div>
      <div class="kanban-card-meta">
        <span class="deadline-badge ${dlClass}">${getDeadlineLabel(t.deadline)}</span>
        <span class="kanban-card-project" style="background:${t.projectColor}18;color:${t.projectColor}">${esc(t.projectName)}</span>
        ${t.person&&t.person!=='—'?`<span class="kanban-card-person">${esc(t.person)}</span>`:''}
      </div>
    </div>`;
  }

  container.innerHTML=`<div class="kanban-board">
    <div class="kanban-col kanban-col-todo">
      <div class="kanban-col-header"><span class="kanban-col-title">◯ To Do <span class="kanban-col-count">${todo.length}</span></span></div>
      <div class="kanban-cards" id="kanbanTodo">${todo.length?todo.map(cardHTML).join(''):'<div class="kanban-empty">No tasks</div>'}</div>
    </div>
    <div class="kanban-col kanban-col-progress">
      <div class="kanban-col-header"><span class="kanban-col-title">◐ In Progress <span class="kanban-col-count">${progress.length}</span></span></div>
      <div class="kanban-cards" id="kanbanProgress">${progress.length?progress.map(cardHTML).join(''):'<div class="kanban-empty">No tasks</div>'}</div>
    </div>
    <div class="kanban-col kanban-col-done">
      <div class="kanban-col-header"><span class="kanban-col-title">● Done <span class="kanban-col-count">${done.length}</span></span></div>
      <div class="kanban-cards" id="kanbanDone">${done.length?done.map(cardHTML).join(''):'<div class="kanban-empty">No tasks</div>'}</div>
    </div>
  </div>`;

  renderTeamBar();updateStats();
  // Init drag-and-drop with SortableJS
  if(typeof Sortable!=='undefined'){
    const statusMap={kanbanTodo:'todo',kanbanProgress:'progress',kanbanDone:'done'};
    ['kanbanTodo','kanbanProgress','kanbanDone'].forEach(id=>{
      const el=document.getElementById(id);if(!el)return;
      Sortable.create(el,{group:'kanban',animation:200,ghostClass:'sortable-ghost',dragClass:'sortable-drag',
        onAdd(evt){
          const card=evt.item;
          const pi=parseInt(card.dataset.pi),ti=parseInt(card.dataset.ti);
          const newStatus=statusMap[evt.to.id];
          if(!canChangeStatus(PROJECTS[pi].tasks[ti])){render();return}
          PROJECTS[pi].tasks[ti].status=newStatus;
          logActivity('moved to '+newStatus,`"${PROJECTS[pi].tasks[ti].text}"`);
          showToast(`Task moved to ${newStatus==='todo'?'To Do':newStatus==='progress'?'In Progress':'Done'}`,'success');
          saveProjects();
          setTimeout(()=>renderKanban(),50);
        }
      });
    });
  }
}

// Override render to support kanban view
const _origRender=render;
render=function(){
  if(currentTaskView==='kanban'&&!showBacklog&&currentView==='tasks'){renderKanban();return}
  _origRender();
}

// Global keys
document.addEventListener('keydown',e=>{if(e.key==='Escape'){closeTaskModal();closeProjectModal();closeDeleteModal();closeSettingsModal();closeDeadlinePopover();['activityModalOverlay','commentModalOverlay','leaveModalOverlay','contactModalOverlay','milestoneModalOverlay','timeModalOverlay'].forEach(id=>{const el=document.getElementById(id);if(el)el.classList.remove('open')});const np=document.getElementById('notifPanel');if(np)np.classList.remove('open')}if(e.key==='Enter'){if(document.getElementById('taskModalOverlay').classList.contains('open'))saveTaskModal();else if(document.getElementById('projectModalOverlay').classList.contains('open'))addProject();else if(document.getElementById('commentModalOverlay').classList.contains('open'))addComment()}});

// Filters
document.querySelectorAll('.filter-btn').forEach(btn=>{btn.addEventListener('click',()=>{document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');activeFilter=btn.dataset.filter;showBacklog=false;document.querySelector('.backlog-btn')?.classList.remove('active');render()})});

// Modal overlay click-to-close
['activityModalOverlay','commentModalOverlay','leaveModalOverlay','contactModalOverlay','milestoneModalOverlay','timeModalOverlay'].forEach(id=>{
  const el=document.getElementById(id);if(el)el.addEventListener('click',e=>{if(e.target===e.currentTarget)e.target.classList.remove('open')});
});
function closeModal(id){document.getElementById(id).classList.remove('open')}

// ═══ FEATURE DATA PERSISTENCE ═══
function saveFeatureData(){
  const d={timeEntries,hrLeaves,crmContacts,milestones,documents:documents.map(doc=>({...doc,dataUrl:doc.dataUrl?doc.dataUrl.substring(0,500)+'...':null}))};
  try{localStorage.setItem('mpire_features',JSON.stringify(d))}catch(e){}
  if(!sbClient)return;
  sbClient.from('financial_data').upsert({username:'_system_features',data:d,updated_at:new Date().toISOString()},{onConflict:'username'}).then(({error})=>{
    if(error)console.warn('Feature data save error:',error.message);
  });
}
function loadAllFeatureData(){
  try{
    const d=localStorage.getItem('mpire_features');
    if(d){const p=JSON.parse(d);timeEntries=p.timeEntries||[];hrLeaves=p.hrLeaves||[];crmContacts=(p.crmContacts||[]).map(c=>{if(c.type==='partner')c.type='freelancer';return c});milestones=p.milestones||[];documents=p.documents||[]}
  }catch(e){}
  if(sbClient){
    sbClient.from('financial_data').select('data').eq('username','_system_features').maybeSingle().then(({data,error})=>{
      if(!error&&data&&data.data){
        const p=data.data;
        timeEntries=p.timeEntries||[];hrLeaves=p.hrLeaves||[];crmContacts=p.crmContacts||[];milestones=p.milestones||[];documents=p.documents||[];
        try{localStorage.setItem('mpire_features',JSON.stringify(p))}catch(e){}
      }
    }).catch(()=>{});
  }
}

// ═══ 1. EXECUTIVE DASHBOARD ═══
function renderExecDashboard(){
  const c=document.getElementById('dashboardContainer');
  // Task stats
  let totalTasks=0,doneTasks=0,overdueTasks=0,progressTasks=0,todayTasks=0;
  const projectStats=[];
  PROJECTS.forEach(p=>{
    if(!canSeeProject(p))return;
    let done=0,total=p.tasks.length,overdue=0,inProg=0;
    p.tasks.forEach(t=>{totalTasks++;if(t.status==='done'){done++;doneTasks++}if(t.status==='progress'){inProg++;progressTasks++}if(isOverdue(t)){overdue++;overdueTasks++}if(t.deadline==='today'&&t.status!=='done')todayTasks++});
    projectStats.push({name:p.name,color:p.color,total,done,overdue,inProg,pct:total?Math.round(done/total*100):0});
  });
  const completionRate=totalTasks?Math.round(doneTasks/totalTasks*100):0;
  // Time stats
  const thisWeek=getWeekDates(new Date());
  const weekHours=timeEntries.filter(e=>e.date>=thisWeek[0]&&e.date<=thisWeek[6]).reduce((s,e)=>s+(e.hours||0),0);
  // Team utilization
  const teamSize=USERS.length;
  const avgUtil=teamSize?Math.round(weekHours/(teamSize*40)*100):0;
  // Revenue if financial data exists
  let totalRev=0;financialData.forEach(b=>{totalRev+=arrSum(b.parsedPL.revenue)});

  let html=`<div class="exec-dash">
    <div class="exec-grid">
      <div class="exec-card"><div class="exec-card-label">Total Tasks</div><div class="exec-card-value" style="color:var(--accent-light)">${totalTasks}</div><div class="exec-card-sub">${doneTasks} completed · ${progressTasks} in progress</div></div>
      <div class="exec-card"><div class="exec-card-label">Completion Rate</div><div class="exec-card-value ${completionRate>=75?'':completionRate>=40?'':'style=\"color:var(--overdue)\"'}" style="color:${completionRate>=75?'var(--done)':completionRate>=40?'var(--accent-light)':'var(--overdue)'}">${completionRate}%</div><div class="exec-card-sub"><div class="kpi-bar"><div class="kpi-bar-fill" style="width:${completionRate}%;background:${completionRate>=75?'var(--done)':completionRate>=40?'var(--accent)':'var(--overdue)'}"></div></div></div></div>
      <div class="exec-card"><div class="exec-card-label">Due Today</div><div class="exec-card-value" style="color:var(--today)">${todayTasks}</div><div class="exec-card-sub">${overdueTasks} overdue</div></div>
      <div class="exec-card"><div class="exec-card-label">Hours This Week</div><div class="exec-card-value" style="color:var(--weekly)">${weekHours.toFixed(1)}h</div><div class="exec-card-sub">${avgUtil}% team utilization</div></div>
    </div>`;

  if(financialData.length){
    let totalNet=0;financialData.forEach(b=>{totalNet+=arrSum(b.parsedPL.netProfit)});
    const totalNetMargin=totalRev?((totalNet/totalRev)*100):0;
    html+=`<div class="exec-grid" style="grid-template-columns:repeat(3,1fr);margin-bottom:20px">
      <div class="exec-card"><div class="exec-card-label">Total Revenue</div><div class="exec-card-value" style="color:var(--accent-light)">${fmtMoney(totalRev)}</div><div class="exec-card-sub">${financialData.length} business${financialData.length>1?'es':''}</div></div>
      <div class="exec-card"><div class="exec-card-label">Net Profit</div><div class="exec-card-value" style="color:${totalNet>=0?'var(--done)':'var(--overdue)'}">${fmtMoney(totalNet)}</div><div class="exec-card-sub">${fmtPct(totalNetMargin)} margin</div></div>
      <div class="exec-card"><div class="exec-card-label">Team Size</div><div class="exec-card-value" style="color:var(--weekly)">${USERS.length}</div><div class="exec-card-sub">${crmContacts.length} contacts · ${hrLeaves.filter(l=>l.status==='approved').length} leaves approved</div></div>
    </div>`;
  }

  html+=`<div class="exec-two-col">
    <div><div class="exec-section-title">Projects Overview</div>`;
  projectStats.sort((a,b)=>b.overdue-a.overdue||a.pct-b.pct).forEach(p=>{
    html+=`<div class="exec-project-row"><div class="exec-project-dot" style="background:${p.color}"></div><span class="exec-project-name">${esc(p.name)}</span><span class="exec-project-stat">${p.done}/${p.total}</span><div style="width:60px"><div class="kpi-bar"><div class="kpi-bar-fill" style="width:${p.pct}%;background:${p.overdue>0?'var(--overdue)':p.pct>=75?'var(--done)':'var(--accent)'}"></div></div></div><span class="exec-project-stat" style="min-width:30px;text-align:right">${p.pct}%</span>${p.overdue>0?`<span style="color:var(--overdue);font-size:.72rem;font-weight:600">${p.overdue} overdue</span>`:''}</div>`;
  });
  html+=`</div><div><div class="exec-section-title">Team Activity (Recent)</div>`;
  const recentAct=[...activityLog].reverse().slice(0,8);
  if(recentAct.length){
    recentAct.forEach(e=>{
      const d=new Date(e.ts);const tStr=d.toLocaleDateString('en-GB',{day:'numeric',month:'short'})+' '+d.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'});
      html+=`<div style="display:flex;gap:8px;padding:6px 0;border-bottom:1px solid var(--border);font-size:.82rem"><span style="color:var(--accent-light);font-weight:600;min-width:80px">${esc(e.user)}</span><span style="flex:1;color:var(--text-secondary)">${esc(e.action)}</span><span style="color:var(--text-muted);font-size:.72rem">${tStr}</span></div>`;
    });
  } else { html+=`<div style="color:var(--text-muted);font-size:.85rem;padding:12px">No recent activity</div>`; }
  html+=`</div></div>`;

  // Upcoming deadlines
  const upcoming=[];
  PROJECTS.forEach((p,pi)=>{if(!canSeeProject(p))return;p.tasks.forEach((t,ti)=>{if(t.status==='done')return;if(t.deadline==='today'||t.deadline==='tomorrow'||(t.deadline&&t.deadline.includes('-')&&t.deadline>=getTodayStr()))upcoming.push({...t,projectName:p.name,projectColor:p.color})})});
  upcoming.sort((a,b)=>{const order={today:0,tomorrow:1};const aO=order[a.deadline]??2,bO=order[b.deadline]??2;if(aO!==bO)return aO-bO;return(a.deadline||'').localeCompare(b.deadline||'')});
  if(upcoming.length){
    html+=`<div class="exec-section-title">Upcoming Deadlines</div><div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:8px;margin-bottom:20px">`;
    upcoming.slice(0,12).forEach(t=>{
      const dlClass=getDeadlineClass(t.deadline,t);
      html+=`<div style="display:flex;gap:8px;align-items:center;padding:10px 14px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm)${isOverdue(t)?';border-left:3px solid var(--overdue)':''}">
        <span class="deadline-badge ${dlClass}" style="flex-shrink:0">${getDeadlineLabel(t.deadline)}</span>
        <span style="flex:1;font-size:.82rem;font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(t.text)}</span>
        <span style="font-size:.65rem;font-weight:600;padding:2px 6px;border-radius:3px;background:${t.projectColor}18;color:${t.projectColor}">${esc(t.projectName)}</span>
      </div>`;
    });
    html+=`</div>`;
  }
  html+=`</div>`;
  c.innerHTML=html;
}

// ═══ 2. TIME TRACKING ═══
function renderTimeTracking(){
  const c=document.getElementById('timeContainer');
  const weekDates=getWeekDates(new Date());
  const dayNames=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  // Build timesheet grid
  let html=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:8px">
    <div class="exec-section-title" style="margin:0;border:0;padding:0">Weekly Timesheet</div>
    <div style="display:flex;gap:8px">
      <button class="export-btn" onclick="exportTimesheet()">⤓ Export</button>
      ${canManage()?`<button class="btn btn-add" style="font-size:.82rem;padding:7px 16px" onclick="openTimeModal()">+ Log Time</button>`:''}
    </div>
  </div>`;
  // Get all team members
  const people=USERS.map(u=>u.displayName);
  html+=`<div class="timesheet-grid" style="grid-template-columns:140px repeat(7,1fr) 70px">
    <div class="timesheet-cell header">Team Member</div>`;
  weekDates.forEach((d,i)=>{html+=`<div class="timesheet-cell header">${dayNames[i]}<br><span style="font-size:.6rem;opacity:.7">${d.substring(5)}</span></div>`});
  html+=`<div class="timesheet-cell header">Total</div>`;
  people.forEach(person=>{
    html+=`<div class="timesheet-cell name">${esc(person)}</div>`;
    let weekTotal=0;
    weekDates.forEach(date=>{
      const dayHours=timeEntries.filter(e=>e.employee===person&&e.date===date).reduce((s,e)=>s+(e.hours||0),0);
      weekTotal+=dayHours;
      html+=`<div class="timesheet-cell" style="${dayHours>0?'color:var(--text);font-weight:600':'color:var(--text-muted)'}">${dayHours>0?dayHours.toFixed(1):'—'}</div>`;
    });
    html+=`<div class="timesheet-cell total">${weekTotal.toFixed(1)}h</div>`;
  });
  html+=`</div>`;

  // Utilization overview
  html+=`<div class="exec-section-title">Team Utilization</div><div class="exec-grid" style="margin-bottom:20px">`;
  people.forEach(person=>{
    const totalHrs=timeEntries.filter(e=>e.employee===person).reduce((s,e)=>s+(e.hours||0),0);
    const weekHrs=timeEntries.filter(e=>e.employee===person&&weekDates.includes(e.date)).reduce((s,e)=>s+(e.hours||0),0);
    const util=Math.min(100,Math.round(weekHrs/40*100));
    html+=`<div class="exec-card"><div style="display:flex;align-items:center;gap:8px;margin-bottom:8px"><div class="ub-avatar" style="width:28px;height:28px;border-radius:6px;background:var(--accent);display:flex;align-items:center;justify-content:center;font-size:.7rem;font-weight:700;color:var(--bg)">${person.charAt(0)}</div><span style="font-weight:600;font-size:.85rem">${esc(person)}</span></div>
    <div style="display:flex;justify-content:space-between;font-size:.78rem;margin-bottom:4px"><span>This week: ${weekHrs.toFixed(1)}h</span><span style="color:var(--text-muted)">All time: ${totalHrs.toFixed(1)}h</span></div>
    <div class="utilization-bar"><div class="utilization-fill" style="width:${util}%;background:${util>=80?'var(--done)':util>=40?'var(--accent)':'var(--text-muted)'}"></div></div>
    <div style="font-size:.7rem;color:var(--text-muted);margin-top:4px">${util}% utilization</div></div>`;
  });
  html+=`</div>`;

  // Recent time entries
  html+=`<div class="exec-section-title">Recent Entries</div>`;
  const recent=[...timeEntries].reverse().slice(0,20);
  if(recent.length){
    recent.forEach(e=>{
      html+=`<div class="time-entry-row"><span class="time-hours">${e.hours}h</span><span class="time-task">${esc(e.task||e.project||'General')}</span><span style="font-size:.75rem;color:var(--text-secondary)">${esc(e.employee)}</span><span class="time-date">${e.date}</span>${canManage()?`<button class="icon-btn danger" style="font-size:.75rem" onclick="deleteTimeEntry('${e.id}')">✕</button>`:''}</div>`;
    });
  }else{html+=`<div style="color:var(--text-muted);font-size:.85rem;padding:16px;text-align:center">No time entries yet. ${canManage()?'Click + Log Time to start tracking.':''}</div>`}
  c.innerHTML=html;
}

function getWeekDates(d){
  const dates=[];const day=d.getDay();const start=new Date(d);start.setDate(d.getDate()-day);
  for(let i=0;i<7;i++){const dd=new Date(start);dd.setDate(start.getDate()+i);dates.push(dd.getFullYear()+'-'+String(dd.getMonth()+1).padStart(2,'0')+'-'+String(dd.getDate()).padStart(2,'0'))}
  return dates;
}

function openTimeModal(){
  document.getElementById('timeEmployee').innerHTML=USERS.map(u=>`<option value="${esc(u.displayName)}" ${currentUser&&u.displayName===currentUser.displayName?'selected':''}>${esc(u.displayName)}</option>`).join('');
  document.getElementById('timeProject').innerHTML=PROJECTS.map((p,i)=>`<option value="${i}">${esc(p.name)}</option>`).join('');
  document.getElementById('timeDate').value=getTodayStr();
  document.getElementById('timeHours').value='1';
  document.getElementById('timeNotes').value='';
  updateTimeTasks();
  document.getElementById('timeModalOverlay').classList.add('open');
}
function updateTimeTasks(){
  const pi=parseInt(document.getElementById('timeProject').value);
  const tasks=PROJECTS[pi]?PROJECTS[pi].tasks:[];
  document.getElementById('timeTask').innerHTML='<option value="">General</option>'+tasks.map(t=>`<option value="${esc(t.text)}">${esc(t.text)}</option>`).join('');
}
function saveTimeEntry(){
  const employee=document.getElementById('timeEmployee').value;
  const pi=parseInt(document.getElementById('timeProject').value);
  const project=PROJECTS[pi]?PROJECTS[pi].name:'';
  const task=document.getElementById('timeTask').value;
  const hours=parseFloat(document.getElementById('timeHours').value)||0;
  const date=document.getElementById('timeDate').value;
  const notes=document.getElementById('timeNotes').value.trim();
  if(!hours||!date){showToast('Please fill in hours and date','error');return}
  timeEntries.push({id:Date.now().toString(36),employee,project,task,hours,date,notes});
  logActivity('logged time',`${hours}h for "${task||project}" by ${employee}`);
  saveFeatureData();closeModal('timeModalOverlay');showToast(`${hours}h logged`,'success');
  if(currentView==='timetracking')renderTimeTracking();
}
function deleteTimeEntry(id){timeEntries=timeEntries.filter(e=>e.id!==id);saveFeatureData();renderTimeTracking()}

// ═══ 3. HR / TEAM DIRECTORY ═══
function renderHREmployee(c){
  const myName=currentUser.displayName;
  const myLeaves=hrLeaves.filter(l=>l.employee===myName);
  let html=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:8px">
    <div class="exec-section-title" style="margin:0;border:0;padding:0">My Leave Requests</div>
    <button class="btn btn-add" style="font-size:.82rem;padding:7px 16px" onclick="openLeaveModal()">+ Request Leave</button>
  </div>`;
  if(myLeaves.length){
    html+=`<div class="fin-details-table" style="--fin-detail-cols:1fr 1fr 1fr 1fr;margin-bottom:20px">
      <div class="fin-details-row header"><div>Type</div><div>Start</div><div>End</div><div>Status</div></div>`;
    myLeaves.forEach(l=>{
      html+=`<div class="fin-details-row"><div>${esc(l.type)}</div><div>${l.startDate}</div><div>${l.endDate}</div><div><span class="leave-status leave-${l.status}">${l.status}</span></div></div>`;
    });
    html+=`</div>`;
  }else{
    html+=`<div style="text-align:center;padding:40px;color:var(--text-muted);font-size:.9rem">No leave requests yet. Click "+ Request Leave" to submit one.</div>`;
  }
  c.innerHTML=html;
}
function renderHR(){
  const c=document.getElementById('hrContainer');
  if(!canManage()){renderHREmployee(c);return}
  let html=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:8px">
    <div class="exec-section-title" style="margin:0;border:0;padding:0">Team Directory</div>
    <button class="btn btn-add" style="font-size:.82rem;padding:7px 16px" onclick="openLeaveModal()">+ Request Leave</button>
  </div><div class="hr-grid">`;
  USERS.forEach((u,ui)=>{
    const rc=getRoleColor(u.role),rl=getRoleLabel(u.role);
    // Stats for this user
    let assigned=0,done=0,overdue=0;
    PROJECTS.forEach(p=>{p.tasks.forEach(t=>{if(t.person===u.displayName){assigned++;if(t.status==='done')done++;if(isOverdue(t))overdue++}})});
    const totalHours=timeEntries.filter(e=>e.employee===u.displayName).reduce((s,e)=>s+(e.hours||0),0);
    const completionRate=assigned?Math.round(done/assigned*100):0;
    const userLeaves=hrLeaves.filter(l=>l.employee===u.displayName);
    html+=`<div class="hr-card">
      <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px">
        <div class="hr-avatar-lg" style="background:${rc}">${u.displayName.charAt(0)}</div>
        <div><div class="hr-name">${esc(u.displayName)}</div><span class="hr-role-badge" style="color:${rc};background:${rc}15">${rl}</span></div>
      </div>
      <div class="hr-stat-row">
        <div class="hr-stat"><div class="hr-stat-val" style="color:var(--accent-light)">${assigned}</div><div class="hr-stat-label">Tasks</div></div>
        <div class="hr-stat"><div class="hr-stat-val" style="color:var(--done)">${completionRate}%</div><div class="hr-stat-label">Done</div></div>
        <div class="hr-stat"><div class="hr-stat-val" style="color:var(--overdue)">${overdue}</div><div class="hr-stat-label">Overdue</div></div>
        <div class="hr-stat"><div class="hr-stat-val" style="color:var(--weekly)">${totalHours.toFixed(0)}h</div><div class="hr-stat-label">Hours</div></div>
      </div>
      ${userLeaves.length?`<div style="margin-top:10px;font-size:.72rem;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--text-muted);margin-bottom:6px">Leave Records</div>${userLeaves.slice(-3).map(l=>`<div class="hr-leave-row"><span class="leave-type">${esc(l.type)}</span><span class="leave-date">${l.startDate} to ${l.endDate}</span><span class="leave-status leave-${l.status}">${l.status}</span>${canManage()&&l.status==='pending'?`<button class="icon-btn" style="font-size:.65rem;color:var(--done)" title="Approve" onclick="updateLeave('${l.id}','approved')">✓</button><button class="icon-btn" style="font-size:.65rem;color:var(--overdue)" title="Reject" onclick="updateLeave('${l.id}','rejected')">✕</button>`:''}</div>`).join('')}`:''}
    </div>`;
  });
  html+=`</div>`;

  // Performance summary table
  html+=`<div class="exec-section-title" style="margin-top:8px">Performance Overview</div>
  <div class="fin-details-table" style="--fin-detail-cols:160px repeat(5,1fr);margin-bottom:20px">
    <div class="fin-details-row header"><div>Employee</div><div>Assigned</div><div>Completed</div><div>Overdue</div><div>Hours</div><div>Rate</div></div>`;
  USERS.forEach(u=>{
    let assigned=0,done=0,overdue=0;
    PROJECTS.forEach(p=>{p.tasks.forEach(t=>{if(t.person===u.displayName){assigned++;if(t.status==='done')done++;if(isOverdue(t))overdue++}})});
    const hrs=timeEntries.filter(e=>e.employee===u.displayName).reduce((s,e)=>s+(e.hours||0),0);
    const rate=assigned?Math.round(done/assigned*100):0;
    html+=`<div class="fin-details-row"><div class="label">${esc(u.displayName)}</div><div>${assigned}</div><div class="pos">${done}</div><div class="${overdue?'neg':''}">${overdue}</div><div>${hrs.toFixed(1)}h</div><div class="${rate>=75?'pos':rate>=40?'':'neg'}">${rate}%</div></div>`;
  });
  html+=`</div>`;
  c.innerHTML=html;
}

function openLeaveModal(){
  if(canManage()){
    document.getElementById('leaveEmployee').innerHTML=USERS.map(u=>`<option value="${esc(u.displayName)}" ${currentUser&&u.displayName===currentUser.displayName?'selected':''}>${esc(u.displayName)}</option>`).join('');
    document.getElementById('leaveEmployee').disabled=false;
    document.getElementById('leaveStatus').parentElement.style.display='';
  }else{
    document.getElementById('leaveEmployee').innerHTML=`<option value="${esc(currentUser.displayName)}">${esc(currentUser.displayName)}</option>`;
    document.getElementById('leaveEmployee').disabled=true;
    document.getElementById('leaveStatus').value='pending';
    document.getElementById('leaveStatus').parentElement.style.display='none';
  }
  document.getElementById('leaveStart').value=getTodayStr();
  document.getElementById('leaveEnd').value=getTodayStr();
  document.getElementById('leaveType').value='Vacation';
  if(canManage())document.getElementById('leaveStatus').value=isOwner()?'approved':'pending';
  document.getElementById('leaveModalOverlay').classList.add('open');
}
function saveLeave(){
  const employee=document.getElementById('leaveEmployee').value;
  const type=document.getElementById('leaveType').value;
  const startDate=document.getElementById('leaveStart').value;
  const endDate=document.getElementById('leaveEnd').value;
  const status=document.getElementById('leaveStatus').value;
  if(!startDate||!endDate){showToast('Please fill all fields','error');return}
  hrLeaves.push({id:Date.now().toString(36),employee,type,startDate,endDate,status});
  logActivity('leave requested',`${type} for ${employee}: ${startDate} to ${endDate}`);
  saveFeatureData();closeModal('leaveModalOverlay');showToast('Leave request submitted','success');
  if(currentView==='hr')renderHR();
}
function updateLeave(id,status){
  const l=hrLeaves.find(x=>x.id===id);if(!l)return;l.status=status;
  logActivity('leave '+status,`${l.type} for ${l.employee}`);
  saveFeatureData();showToast(`Leave ${status}`,'success');renderHR();
}

// ═══ 4. NOTIFICATIONS & REMINDERS ═══
function generateNotifications(){
  notifications=[];
  const today=getTodayStr();
  // Overdue tasks
  let overdueCount=0;
  PROJECTS.forEach(p=>{if(!canSeeProject(p))return;p.tasks.forEach(t=>{
    if(isOverdue(t)){
      overdueCount++;
      if(overdueCount<=5)notifications.push({id:'od-'+overdueCount,title:'Overdue: '+t.text,body:p.name+(t.person!=='—'?' · Assigned to '+t.person:''),time:new Date().toISOString(),read:false});
    }
    if(t.deadline==='today'&&t.status!=='done'){
      notifications.push({id:'td-'+t.text.substring(0,10),title:'Due today: '+t.text,body:p.name,time:new Date().toISOString(),read:false});
    }
  })});
  if(overdueCount>5){notifications.unshift({id:'od-summary',title:`${overdueCount} tasks overdue`,body:'Check your task list for details',time:new Date().toISOString(),read:false})}
  // Pending leaves
  hrLeaves.filter(l=>l.status==='pending').forEach(l=>{
    notifications.push({id:'lv-'+l.id,title:'Pending leave request',body:`${l.employee}: ${l.type} (${l.startDate})`,time:new Date().toISOString(),read:false});
  });
  updateNotifBadge();
}
function updateNotifBadge(){
  const unread=notifications.filter(n=>!n.read).length;
  const badge=document.getElementById('notifBadge');
  badge.textContent=unread>0?unread:'';badge.setAttribute('data-count',unread);
}
function toggleNotifPanel(e){
  e.stopPropagation();
  const panel=document.getElementById('notifPanel');panel.classList.toggle('open');
  if(panel.classList.contains('open'))renderNotifList();
}
function renderNotifList(){
  const list=document.getElementById('notifList');
  if(!notifications.length){list.innerHTML='<div class="notif-empty">No notifications</div>';return}
  list.innerHTML=notifications.slice(0,20).map(n=>{
    const d=new Date(n.time);const tStr=d.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'});
    return `<div class="notif-item ${n.read?'':'unread'}" onclick="markNotifRead('${n.id}')"><div class="notif-item-title">${esc(n.title)}</div><div class="notif-item-sub">${esc(n.body)}</div><div class="notif-item-time">${tStr}</div></div>`;
  }).join('');
}
function markNotifRead(id){const n=notifications.find(x=>x.id===id);if(n)n.read=true;updateNotifBadge();renderNotifList()}
function clearNotifications(){notifications=[];updateNotifBadge();renderNotifList()}
document.addEventListener('click',e=>{const panel=document.getElementById('notifPanel');if(panel&&!e.target.closest('#notifWrap'))panel.classList.remove('open')});

// ═══ 5. TASK COMMENTS ═══
let commentTarget=null; // {pi,ti}
function openCommentModal(pi,ti){
  commentTarget={pi,ti};
  const t=PROJECTS[pi].tasks[ti];
  document.getElementById('commentModalTitle').textContent='Comments';
  document.getElementById('commentModalTask').textContent=t.text;
  renderComments();
  document.getElementById('commentModalOverlay').classList.add('open');
  setTimeout(()=>document.getElementById('commentInput').focus(),200);
}
function closeCommentModal(){document.getElementById('commentModalOverlay').classList.remove('open');commentTarget=null}
function renderComments(){
  if(!commentTarget)return;
  const t=PROJECTS[commentTarget.pi].tasks[commentTarget.ti];
  const comments=t.comments||[];
  const list=document.getElementById('commentList');
  if(!comments.length){list.innerHTML='<div style="color:var(--text-muted);font-size:.85rem;text-align:center;padding:16px">No comments yet</div>';return}
  list.innerHTML=comments.map(c=>{
    const d=new Date(c.ts);const tStr=d.toLocaleDateString('en-GB',{day:'numeric',month:'short'})+' '+d.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'});
    return `<div class="comment-item"><div class="comment-avatar">${c.user.charAt(0)}</div><div class="comment-body"><div class="comment-author">${esc(c.user)}</div><div class="comment-text">${esc(c.text)}</div><div class="comment-time">${tStr}</div></div></div>`;
  }).join('');
  list.scrollTop=list.scrollHeight;
}
function addComment(){
  if(!commentTarget)return;
  const input=document.getElementById('commentInput');
  const text=input.value.trim();if(!text)return;
  const t=PROJECTS[commentTarget.pi].tasks[commentTarget.ti];
  if(!t.comments)t.comments=[];
  t.comments.push({user:currentUser.displayName,text,ts:new Date().toISOString()});
  input.value='';
  logActivity('commented',`on "${t.text}"`);
  saveProjects();renderComments();
}

// ═══ 6. RECURRING TASKS ═══
function processRecurringTasks(){
  const today=getTodayStr();
  PROJECTS.forEach(p=>{
    p.tasks.forEach(t=>{
      if(t.status==='done'&&(t.deadline==='daily'||t.deadline==='weekly')){
        // Check if already regenerated today
        if(t._lastRecur===today)return;
        t.status='todo';t._lastRecur=today;
      }
    });
  });
  saveProjects();
}
// Run on load and every 60 seconds
setInterval(processRecurringTasks,60000);

// ═══ 7. MILESTONES & GANTT ═══
function renderGanttSection(){
  if(!milestones.length)return'';
  let html=`<div class="exec-section-title" style="display:flex;justify-content:space-between;align-items:center">Milestones & Timeline <button class="btn btn-add" style="font-size:.78rem;padding:5px 12px" onclick="openMilestoneModal()">+ Milestone</button></div>`;
  // Milestones
  milestones.forEach((m,mi)=>{
    const p=PROJECTS[m.projectIndex];
    if(!p)return;
    const tasks=p.tasks;
    const done=tasks.filter(t=>t.status==='done').length;
    const pct=tasks.length?Math.round(done/tasks.length*100):0;
    const isOverdueM=m.targetDate&&m.targetDate<getTodayStr()&&pct<100;
    html+=`<div class="milestone-section">
      <div class="milestone-header"><div><span class="milestone-name">${esc(m.name)}</span><span style="font-size:.72rem;font-weight:600;padding:2px 8px;border-radius:4px;background:${p.color}18;color:${p.color};margin-left:8px">${esc(p.name)}</span></div><span class="milestone-date" style="${isOverdueM?'color:var(--overdue)':''}">${m.targetDate?getDeadlineLabel(m.targetDate):'No date'} ${isOverdueM?'(overdue)':''}</span>${canManage()?`<button class="icon-btn danger" onclick="deleteMilestone(${mi})">✕</button>`:''}</div>
      <div class="milestone-progress"><div class="milestone-bar"><div class="milestone-fill" style="width:${pct}%;background:${pct>=100?'var(--done)':pct>=50?'var(--accent)':'var(--text-muted)'}"></div></div><span class="milestone-pct">${pct}%</span></div>
    </div>`;
  });
  // Gantt chart
  html+=renderGanttChart();
  return html;
}
function renderGanttChart(){
  // Collect tasks with date deadlines for Gantt
  const ganttTasks=[];
  const today=new Date();
  const startDate=new Date(today);startDate.setDate(today.getDate()-7);
  const endDate=new Date(today);endDate.setDate(today.getDate()+30);
  const totalDays=Math.ceil((endDate-startDate)/(1000*60*60*24));
  PROJECTS.forEach(p=>{if(!canSeeProject(p))return;p.tasks.forEach(t=>{
    if(t.status==='done')return;
    let deadlineDate=null;
    if(t.deadline&&t.deadline.includes('-'))deadlineDate=new Date(t.deadline+'T00:00:00');
    else if(t.deadline==='today')deadlineDate=new Date();
    else if(t.deadline==='tomorrow'){deadlineDate=new Date();deadlineDate.setDate(deadlineDate.getDate()+1)}
    if(deadlineDate){
      ganttTasks.push({text:t.text,date:deadlineDate,color:p.color,project:p.name,status:t.status});
    }
  })});
  if(!ganttTasks.length)return'';
  ganttTasks.sort((a,b)=>a.date-b.date);
  // Generate date headers (show every 3 days)
  const dateHeaders=[];
  for(let i=0;i<totalDays;i+=3){
    const d=new Date(startDate);d.setDate(startDate.getDate()+i);
    dateHeaders.push({date:d,label:d.toLocaleDateString('en-GB',{day:'numeric',month:'short'}),offset:i});
  }
  let html=`<div class="gantt-container" style="margin-top:12px"><div class="gantt-chart">
    <div class="gantt-header"><div class="gantt-header-label">Task</div><div class="gantt-header-dates">${dateHeaders.map(d=>`<div class="gantt-header-date">${d.label}</div>`).join('')}</div></div>`;
  // Today line
  const todayOffset=Math.ceil((today-startDate)/(1000*60*60*24));
  const todayPct=(todayOffset/totalDays)*100;
  ganttTasks.slice(0,15).forEach(t=>{
    const dayOffset=Math.ceil((t.date-startDate)/(1000*60*60*24));
    const leftPct=Math.max(0,Math.min(100,(dayOffset/totalDays)*100));
    const isOverdueG=t.date<today&&t.status!=='done';
    html+=`<div class="gantt-row"><div class="gantt-row-label">${esc(t.text)}</div><div class="gantt-row-bars" style="position:relative">
      <div class="gantt-bar" style="left:${Math.max(0,leftPct-6)}%;width:${Math.min(12,100-leftPct+6)}%;background:${isOverdueG?'var(--overdue)':t.color};opacity:${t.status==='progress'?1:.7}">${esc(t.project)}</div>
    </div></div>`;
  });
  html+=`</div></div>`;
  return html;
}
function openMilestoneModal(){
  document.getElementById('milestoneName').value='';
  document.getElementById('milestoneDate').value='';
  document.getElementById('milestoneProject').innerHTML=PROJECTS.map((p,i)=>`<option value="${i}">${esc(p.name)}</option>`).join('');
  document.getElementById('milestoneModalOverlay').classList.add('open');
}
function saveMilestone(){
  const name=document.getElementById('milestoneName').value.trim();
  const projectIndex=parseInt(document.getElementById('milestoneProject').value);
  const targetDate=document.getElementById('milestoneDate').value;
  if(!name){showToast('Please enter a milestone name','error');return}
  milestones.push({id:Date.now().toString(36),name,projectIndex,targetDate});
  logActivity('created milestone',name);
  saveFeatureData();closeModal('milestoneModalOverlay');showToast('Milestone created','success');render();
}
function deleteMilestone(i){milestones.splice(i,1);saveFeatureData();render()}

// ═══ 8. CRM / CONTACTS ═══
function renderCRM(){
  const c=document.getElementById('crmContainer');
  let html=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:8px">
    <div class="exec-section-title" style="margin:0;border:0;padding:0">Contacts Directory</div>
    ${canManage()?`<button class="btn btn-add" style="font-size:.82rem;padding:7px 16px" onclick="openContactModal()">+ Add Contact</button>`:''}
  </div>`;
  // Type filter
  const types=['all','client','vendor','freelancer'];
  html+=`<div style="display:flex;gap:6px;margin-bottom:16px">${types.map(t=>`<button class="filter-btn ${t==='all'?'active':''}" onclick="filterCRM(this,'${t}')">${t.charAt(0).toUpperCase()+t.slice(1)}</button>`).join('')}</div>`;
  html+=`<div class="crm-grid" id="crmGrid">`;
  if(!crmContacts.length){
    html+=`<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--text-muted)">No contacts yet. ${canManage()?'Click + Add Contact to get started.':''}</div>`;
  }
  crmContacts.forEach((ct,i)=>{
    html+=`<div class="crm-card" data-type="${ct.type}">
      <div style="display:flex;justify-content:space-between;align-items:flex-start">
        <div><div class="crm-name">${esc(ct.name)}</div><div class="crm-company">${esc(ct.company||'')}</div></div>
        ${canManage()?`<div style="display:flex;gap:4px"><button class="icon-btn" onclick="editContact(${i})" title="Edit">✎</button><button class="icon-btn danger" onclick="deleteContact(${i})" title="Delete">✕</button></div>`:''}
      </div>
      <span class="crm-type crm-type-${ct.type}">${ct.type}</span>
      ${ct.email?`<div class="crm-detail">📧 ${esc(ct.email)}</div>`:''}
      ${ct.phone?`<div class="crm-detail">📞 ${esc(ct.phone)}</div>`:''}
      ${ct.notes?`<div class="crm-detail" style="color:var(--text-muted);font-style:italic">${esc(ct.notes)}</div>`:''}
      ${ct.projects&&ct.projects.length?`<div class="crm-projects">${ct.projects.map(pn=>{const p=PROJECTS.find(x=>x.name===pn);return `<span class="crm-project-tag" style="background:${p?p.color+'18':'var(--surface-hover)'};color:${p?p.color:'var(--text-muted)'}">${esc(pn)}</span>`}).join('')}</div>`:''}
    </div>`;
  });
  html+=`</div>`;
  c.innerHTML=html;
}
function filterCRM(btn,type){
  btn.parentElement.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');
  document.querySelectorAll('.crm-card').forEach(card=>{card.style.display=type==='all'||card.dataset.type===type?'':'none'});
}
function openContactModal(editing){
  editingContactIndex=editing??null;
  document.getElementById('contactModalTitle').textContent=editing!=null?'Edit Contact':'Add Contact';
  document.getElementById('contactSaveBtn').textContent=editing!=null?'Save Changes':'Add Contact';
  const ct=editing!=null?crmContacts[editing]:{};
  document.getElementById('contactName').value=ct.name||'';
  document.getElementById('contactType').value=ct.type||'client';
  document.getElementById('contactCompany').value=ct.company||'';
  document.getElementById('contactEmail').value=ct.email||'';
  document.getElementById('contactPhone').value=ct.phone||'';
  document.getElementById('contactNotes').value=ct.notes||'';
  const projDiv=document.getElementById('contactProjects');
  projDiv.innerHTML=PROJECTS.map(p=>{
    const checked=ct.projects&&ct.projects.includes(p.name);
    return `<label style="display:flex;align-items:center;gap:4px;font-size:.78rem;padding:3px 8px;border-radius:4px;border:1px solid ${checked?p.color:'var(--border)'};background:${checked?p.color+'18':'transparent'};cursor:pointer;transition:all .15s ease">
      <input type="checkbox" value="${esc(p.name)}" ${checked?'checked':''} style="display:none" onchange="this.parentElement.style.borderColor=this.checked?'${p.color}':'var(--border)';this.parentElement.style.background=this.checked?'${p.color}18':'transparent'">
      <span style="color:${p.color}">${esc(p.name)}</span></label>`;
  }).join('');
  document.getElementById('contactModalOverlay').classList.add('open');
}
function editContact(i){openContactModal(i)}
function saveContact(){
  const name=document.getElementById('contactName').value.trim();
  if(!name){showToast('Please enter a name','error');return}
  const data={
    id:editingContactIndex!=null?crmContacts[editingContactIndex].id:Date.now().toString(36),
    name,type:document.getElementById('contactType').value,
    company:document.getElementById('contactCompany').value.trim(),
    email:document.getElementById('contactEmail').value.trim(),
    phone:document.getElementById('contactPhone').value.trim(),
    notes:document.getElementById('contactNotes').value.trim(),
    projects:[...document.querySelectorAll('#contactProjects input:checked')].map(cb=>cb.value)
  };
  if(editingContactIndex!=null){crmContacts[editingContactIndex]=data;logActivity('updated contact',name)}
  else{crmContacts.push(data);logActivity('added contact',name)}
  saveFeatureData();closeModal('contactModalOverlay');showToast(editingContactIndex!=null?'Contact updated':'Contact added','success');editingContactIndex=null;renderCRM();
}
function deleteContact(i){
  if(!confirm('Delete '+crmContacts[i].name+'?'))return;
  logActivity('deleted contact',crmContacts[i].name);crmContacts.splice(i,1);saveFeatureData();renderCRM();
}

// ═══ 9. DOCUMENT MANAGEMENT ═══
function renderDocs(){
  const c=document.getElementById('docsContainer');
  let html=`<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
    <div class="exec-section-title" style="margin:0;border:0;padding:0">Document Management</div>
    <button class="export-btn" onclick="exportDocList()">⤓ Export List</button>
  </div>`;
  html+=`<div class="doc-upload-zone" onclick="document.getElementById('docFileInput').click()" ondragover="event.preventDefault();this.classList.add('dragover')" ondragleave="this.classList.remove('dragover')" ondrop="event.preventDefault();this.classList.remove('dragover');handleDocUpload(event.dataTransfer.files)">
    <div style="font-size:1.3rem;margin-bottom:4px">📎</div>
    <div style="font-size:.85rem;font-weight:600">Upload Documents</div>
    <div style="font-size:.78rem;color:var(--text-muted)">Drag & drop files here or click to browse</div>
    <input type="file" id="docFileInput" style="display:none" multiple onchange="handleDocUpload(this.files)">
    <div style="margin-top:8px"><select id="docProjectSelect" onclick="event.stopPropagation()" style="padding:6px 10px;border-radius:var(--radius-sm);border:1px solid var(--border);background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;font-size:.8rem">
      <option value="">General (No Project)</option>${PROJECTS.map(p=>`<option value="${esc(p.name)}">${esc(p.name)}</option>`).join('')}
    </select></div>
  </div>`;
  // Group by project
  const byProject={};
  documents.forEach(d=>{const key=d.project||'General';if(!byProject[key])byProject[key]=[];byProject[key].push(d)});
  const projectOrder=['General',...PROJECTS.map(p=>p.name)];
  projectOrder.forEach(pName=>{
    const docs=byProject[pName];if(!docs||!docs.length)return;
    const proj=PROJECTS.find(p=>p.name===pName);
    html+=`<div class="doc-project-section"><div class="doc-project-title"><span style="color:${proj?proj.color:'var(--text-muted)'}">●</span> ${esc(pName)} <span style="font-weight:400;color:var(--text-muted)">(${docs.length})</span></div><div class="doc-grid">`;
    docs.forEach((d,di)=>{
      const ext=(d.name||'').split('.').pop().toLowerCase();
      const icon=ext==='pdf'?'📄':ext==='xlsx'||ext==='xls'?'📊':ext==='doc'||ext==='docx'?'📝':ext==='png'||ext==='jpg'||ext==='jpeg'?'🖼':'📁';
      html+=`<div class="doc-card"><div class="doc-icon">${icon}</div><div class="doc-name">${esc(d.name)}</div><div class="doc-meta">${d.size||''}${d.uploadedBy?' · '+esc(d.uploadedBy):''}</div><div style="margin-top:6px;display:flex;gap:4px;justify-content:center">${canManage()?`<button class="icon-btn danger" style="font-size:.72rem" onclick="deleteDoc('${d.id}')">🗑</button>`:''}</div></div>`;
    });
    html+=`</div></div>`;
  });
  if(!documents.length){html+=`<div style="text-align:center;padding:40px;color:var(--text-muted)">No documents uploaded yet.</div>`}
  c.innerHTML=html;
}
function handleDocUpload(files){
  const project=document.getElementById('docProjectSelect').value;
  Array.from(files).forEach(file=>{
    const sizeStr=file.size>1e6?(file.size/1e6).toFixed(1)+'MB':(file.size/1e3).toFixed(0)+'KB';
    documents.push({id:Date.now().toString(36)+Math.random().toString(36).substr(2,4),name:file.name,size:sizeStr,type:file.type,project:project||'',uploadedBy:currentUser?currentUser.displayName:'',uploadedAt:new Date().toISOString(),dataUrl:null});
    logActivity('uploaded document',file.name+(project?' to '+project:''));
  });
  saveFeatureData();showToast(`${files.length} file(s) uploaded`,'success');renderDocs();
}
function deleteDoc(id){documents=documents.filter(d=>d.id!==id);saveFeatureData();renderDocs()}

// ═══ 10. DARK/LIGHT THEME ═══
function applyTheme(){
  const icon=currentTheme==='light'?'🌙':'☀';
  if(currentTheme==='light')document.body.classList.add('light-theme');
  else document.body.classList.remove('light-theme');
  const tb=document.getElementById('themeToggleBtn');if(tb)tb.textContent=icon;
  const lb=document.getElementById('loginThemeBtn');if(lb)lb.textContent=icon;
}
function toggleTheme(){
  currentTheme=currentTheme==='dark'?'light':'dark';
  localStorage.setItem('mpire_theme',currentTheme);applyTheme();
}
applyTheme();

// ═══ 11. EXPORT REPORTS ═══
function exportTasksCSV(){
  let csv='Project,Task,Person,Deadline,Priority,Status\n';
  PROJECTS.forEach(p=>{if(!canSeeProject(p))return;p.tasks.forEach(t=>{
    csv+=`"${p.name}","${t.text}","${t.person}","${getDeadlineLabel(t.deadline)}","${t.priority}","${t.status}"\n`;
  })});
  downloadCSV(csv,'mpire_tasks_'+getTodayStr()+'.csv');
}
function exportTimesheet(){
  let csv='Employee,Project,Task,Hours,Date,Notes\n';
  timeEntries.forEach(e=>{csv+=`"${e.employee}","${e.project}","${e.task}","${e.hours}","${e.date}","${e.notes||''}"\n`});
  downloadCSV(csv,'mpire_timesheet_'+getTodayStr()+'.csv');
}
function exportActivityLog(){
  let csv='Timestamp,User,Action,Detail\n';
  activityLog.forEach(e=>{csv+=`"${e.ts}","${e.user}","${e.action}","${(e.detail||'').replace(/"/g,'""')}"\n`});
  downloadCSV(csv,'mpire_activity_'+getTodayStr()+'.csv');
}
function exportDocList(){
  let csv='Document,Project,Uploaded By,Size,Date\n';
  documents.forEach(d=>{csv+=`"${d.name}","${d.project||'General'}","${d.uploadedBy||''}","${d.size||''}","${d.uploadedAt||''}"\n`});
  downloadCSV(csv,'mpire_documents_'+getTodayStr()+'.csv');
}
function downloadCSV(csv,filename){
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download=filename;a.click();
  URL.revokeObjectURL(url);showToast('Exported '+filename,'success');
}

// ═══ 12. ENHANCED ACTIVITY LOG ═══
function openActivityLog(){
  loadActivityFromCloud().then(()=>{
    // Populate filter dropdowns
    const users=[...new Set(activityLog.map(e=>e.user))];
    const actions=[...new Set(activityLog.map(e=>e.action))];
    document.getElementById('actFilterUser').innerHTML='<option value="">All Users</option>'+users.map(u=>`<option value="${esc(u)}">${esc(u)}</option>`).join('');
    document.getElementById('actFilterAction').innerHTML='<option value="">All Actions</option>'+actions.map(a=>`<option value="${esc(a)}">${esc(a)}</option>`).join('');
    document.getElementById('actFilterDate').value='';
    renderActivityList();
    document.getElementById('activityModalOverlay').classList.add('open');
  });
}
function renderActivityList(){
  const filterUser=document.getElementById('actFilterUser').value;
  const filterAction=document.getElementById('actFilterAction').value;
  const filterDate=document.getElementById('actFilterDate').value;
  const list=document.getElementById('activityList');
  let filtered=[...activityLog].reverse();
  if(filterUser)filtered=filtered.filter(e=>e.user===filterUser);
  if(filterAction)filtered=filtered.filter(e=>e.action===filterAction);
  if(filterDate)filtered=filtered.filter(e=>e.ts&&e.ts.startsWith(filterDate));
  if(!filtered.length){list.innerHTML='<div style="text-align:center;padding:24px;color:var(--text-muted)">No matching activity</div>';return}
  list.innerHTML=filtered.slice(0,100).map(e=>{
    const d=new Date(e.ts);
    const timeStr=d.toLocaleDateString('en-GB',{day:'numeric',month:'short'})+' '+d.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'});
    const actionColor=e.action==='completed'?'var(--done)':e.action.includes('deleted')?'var(--overdue)':e.action.includes('created')||e.action.includes('added')?'var(--accent)':'var(--weekly)';
    return `<div class="activity-item">
      <div class="activity-dot" style="background:${actionColor}"></div>
      <div class="activity-content">
        <div class="activity-action"><strong>${esc(e.user)}</strong> ${esc(e.action)}</div>
        <div class="activity-detail">${esc(e.detail||'')}</div>
      </div>
      <div class="activity-time">${timeStr}</div>
    </div>`;
  }).join('');
}

// ═══ ADD COMMENT BUTTONS TO TASK ROWS ═══
// Patch the render to include comment buttons and milestones
const _origRender2=render;
render=function(){
  _origRender2();
  // Add comment buttons to task rows
  if(currentView==='tasks'&&!showBacklog){
    document.querySelectorAll('.task-row').forEach(row=>{
      const editBtn=row.querySelector('.icon-btn[title="Edit task"]');
      if(editBtn&&!row.querySelector('.task-comment-btn')){
        const onc=editBtn.getAttribute('onclick');
        const match=onc&&onc.match(/openEditTask\((\d+),(\d+)\)/);
        if(match){
          const pi=match[1],ti=match[2];
          const t=PROJECTS[pi]&&PROJECTS[pi].tasks[ti];
          const commentCount=t&&t.comments?t.comments.length:0;
          const btn=document.createElement('button');
          btn.className='task-comment-btn';
          btn.textContent='💬'+(commentCount>0?' '+commentCount:'');
          btn.title='Comments';
          btn.onclick=function(e){e.stopPropagation();openCommentModal(parseInt(pi),parseInt(ti))};
          editBtn.parentElement.insertBefore(btn,editBtn);
        }
      }
    });
    // Also render milestones & gantt at the bottom of the task view
    if(!showBacklog&&milestones.length){
      const container=document.getElementById('projectContainer');
      const ganttDiv=document.createElement('div');
      ganttDiv.innerHTML=renderGanttSection();
      container.appendChild(ganttDiv);
    }
  }
};

// Add export button rendering for task view
const _origRender3=render;
render=function(){
  _origRender3();
  if(currentView==='tasks'&&!showBacklog){
    const filterBar=document.getElementById('filterBar');
    if(filterBar&&!filterBar.querySelector('.export-btn')){
      const btn=document.createElement('button');
      btn.className='export-btn';btn.innerHTML='⤓ Export';btn.style.marginLeft='auto';
      btn.onclick=exportTasksCSV;
      filterBar.appendChild(btn);
    }
    // Add milestone button if manager and no milestones exist
    if(canManage()&&!milestones.length){
      const filterBar=document.getElementById('filterBar');
      if(filterBar&&!filterBar.querySelector('.milestone-add-btn')){
        const btn=document.createElement('button');
        btn.className='backlog-btn milestone-add-btn';btn.innerHTML='◆ Milestone';
        btn.onclick=openMilestoneModal;
        filterBar.appendChild(btn);
      }
    }
  }
};

// Process recurring on first load
setTimeout(processRecurringTasks,1000);
</script>
</body>
</html>
