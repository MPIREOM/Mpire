<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Project Task Board</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Playfair+Display:wght@700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<style>
:root{--bg:#0f1117;--surface:#181a22;--surface-hover:#1e2130;--border:#2a2d3a;--text:#e8e9ed;--text-muted:#8b8fa3;--accent:#c9a46c;--accent-light:#e0c98f;--today:#e05c5c;--today-bg:rgba(224,92,92,.1);--tomorrow:#e0a33c;--tomorrow-bg:rgba(224,163,60,.1);--weekly:#5ca0e0;--weekly-bg:rgba(92,160,224,.1);--daily:#9b7ae0;--daily-bg:rgba(155,122,224,.1);--done:#4ead6b;--done-bg:rgba(78,173,107,.08);--progress:#e0a33c;--progress-bg:rgba(224,163,60,.1);--overdue:#ff4d6a;--overdue-bg:rgba(255,77,106,.1);--high:#e05c5c;--medium:#e0a33c;--low:#5ca0e0;--my-task:rgba(201,164,108,.08);--radius:12px}
*{margin:0;padding:0;box-sizing:border-box}
body{background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;min-height:100vh;-webkit-text-size-adjust:100%;overflow-x:hidden}

/* LOGIN */
.login-page{display:flex;align-items:center;justify-content:center;min-height:100vh;background:radial-gradient(ellipse at 30% 20%,rgba(201,164,108,.06) 0%,transparent 60%),radial-gradient(ellipse at 70% 80%,rgba(92,160,224,.04) 0%,transparent 60%),var(--bg)}
.login-card{background:var(--surface);border:1px solid var(--border);border-radius:20px;padding:48px 44px;width:420px;max-width:92vw;box-shadow:0 24px 80px rgba(0,0,0,.4);animation:loginIn .5s ease both}
@keyframes loginIn{from{opacity:0;transform:translateY(30px) scale(.96)}to{opacity:1;transform:none}}
.login-logo{font-family:'Playfair Display',serif;font-size:2rem;font-weight:800;color:var(--accent-light);text-align:center;margin-bottom:6px}
.login-sub{text-align:center;color:var(--text-muted);font-size:.9rem;margin-bottom:32px}
.login-field{margin-bottom:20px}
.login-field label{display:block;font-size:.78rem;font-weight:600;text-transform:uppercase;letter-spacing:.6px;color:var(--text-muted);margin-bottom:7px}
.login-field input{width:100%;padding:12px 16px;border-radius:10px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;font-size:.95rem;transition:border-color .2s}
.login-field input:focus{outline:none;border-color:var(--accent)}
.login-btn{width:100%;padding:13px;border-radius:10px;border:none;background:var(--accent);color:var(--bg);font-family:'DM Sans',sans-serif;font-size:.95rem;font-weight:700;cursor:pointer;transition:all .2s;margin-top:8px}
.login-btn:hover{background:var(--accent-light)}
.login-error{color:var(--overdue);font-size:.82rem;text-align:center;margin-top:14px;min-height:20px;font-weight:500}
.login-footer{text-align:center;margin-top:24px;font-size:.78rem;color:var(--text-muted)}

/* SPLASH SCREEN */
.splash{position:fixed;inset:0;z-index:9999;background:radial-gradient(ellipse at 50% 40%,#1a1c28 0%,#0f1117 70%);display:flex;flex-direction:column;align-items:center;justify-content:center;opacity:1;transition:opacity .6s ease,visibility .6s ease;visibility:visible}
.splash.hide{opacity:0;visibility:hidden;pointer-events:none}
.splash-logo-wrap{position:relative;display:flex;flex-direction:column;align-items:center;gap:0}
/* M mark container */
.splash-m{width:120px;height:120px;position:relative;opacity:0;animation:splashMIn .8s cubic-bezier(.16,1,.3,1) .2s forwards}
.splash-m svg{width:100%;height:100%}
@keyframes splashMIn{from{opacity:0;transform:scale(.6) translateY(20px)}to{opacity:1;transform:scale(1) translateY(0)}}
/* Glow behind logo */
.splash-glow{position:absolute;top:50%;left:50%;width:200px;height:200px;transform:translate(-50%,-50%);background:radial-gradient(circle,rgba(201,164,108,.25) 0%,transparent 70%);border-radius:50%;opacity:0;animation:splashGlow 1.2s ease .4s forwards;pointer-events:none}
@keyframes splashGlow{from{opacity:0;transform:translate(-50%,-50%) scale(.5)}to{opacity:1;transform:translate(-50%,-50%) scale(1)}}
/* Brand text */
.splash-brand{display:flex;flex-direction:column;align-items:center;gap:4px;margin-top:18px}
.splash-title{font-family:'Playfair Display',serif;font-size:2.6rem;font-weight:800;letter-spacing:12px;color:var(--accent-light);opacity:0;animation:splashTextIn .7s cubic-bezier(.16,1,.3,1) .6s forwards}
.splash-sub{font-size:.72rem;font-weight:600;letter-spacing:6px;text-transform:uppercase;color:var(--text-muted);opacity:0;animation:splashTextIn .7s cubic-bezier(.16,1,.3,1) .8s forwards}
@keyframes splashTextIn{from{opacity:0;transform:translateY(14px);letter-spacing:20px}to{opacity:1;transform:translateY(0);letter-spacing:inherit}}
/* Welcome line */
.splash-welcome{margin-top:32px;font-size:.88rem;color:var(--text-muted);opacity:0;animation:splashFadeIn .6s ease 1.1s forwards}
@keyframes splashFadeIn{from{opacity:0}to{opacity:1}}
/* Horizontal line that draws in */
.splash-line{width:0;height:1px;background:linear-gradient(90deg,transparent,var(--accent),transparent);margin-top:20px;animation:splashLine .8s ease .5s forwards}
@keyframes splashLine{from{width:0}to{width:180px}}

.app{display:none}.app.visible{display:block}

/* HEADER */
.header{padding:40px 48px 28px;border-bottom:1px solid var(--border);background:linear-gradient(180deg,#14161f 0%,var(--bg) 100%)}
.header-top{display:flex;justify-content:space-between;align-items:flex-start;flex-wrap:wrap;gap:16px}
.header-left h1{font-family:'Playfair Display',serif;font-size:2.4rem;font-weight:800;color:var(--accent-light);letter-spacing:-.5px}
.header-left .subtitle{color:var(--text-muted);font-size:.95rem;margin-top:4px}
.header-right{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
.user-badge{display:flex;align-items:center;gap:8px;padding:6px 16px;border-radius:20px;background:rgba(201,164,108,.1);border:1px solid var(--border);font-size:.85rem;font-weight:500}
.ub-avatar{width:26px;height:26px;border-radius:50%;background:var(--accent);display:flex;align-items:center;justify-content:center;font-size:.72rem;font-weight:700;color:var(--bg)}
.ub-role{font-size:.7rem;font-weight:600;text-transform:uppercase;letter-spacing:.5px;padding:2px 8px;border-radius:10px}
.hdr-btn{padding:7px 16px;border-radius:20px;border:1px solid var(--border);background:transparent;color:var(--text-muted);font-family:'DM Sans',sans-serif;font-size:.82rem;font-weight:500;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:5px}
.hdr-btn:hover{border-color:var(--accent);color:var(--text)}
.logout-btn:hover{border-color:var(--overdue)!important;color:var(--overdue)!important}

.stats-row{display:flex;gap:24px;margin-top:20px;flex-wrap:wrap}
.stat{display:flex;align-items:center;gap:8px;font-size:.85rem;color:var(--text-muted)}
.stat-dot{width:8px;height:8px;border-radius:50%}
.stat strong{color:var(--text);font-weight:600}

.team-bar{display:flex;gap:10px;margin-top:18px;flex-wrap:wrap;align-items:center}
.team-bar-label{font-size:.78rem;font-weight:600;text-transform:uppercase;letter-spacing:.6px;color:var(--text-muted);margin-right:4px}
.team-chip{display:flex;align-items:center;gap:6px;padding:5px 14px;border-radius:20px;background:rgba(201,164,108,.08);border:1px solid var(--border);font-size:.82rem;font-weight:500;color:var(--text);transition:all .2s;cursor:pointer}
.team-chip:hover{border-color:var(--accent);background:rgba(201,164,108,.15)}
.team-chip.active{background:var(--accent);border-color:var(--accent);color:var(--bg)}
.team-chip.active .chip-count{background:var(--bg);color:var(--accent)}
.chip-count{background:var(--accent);color:var(--bg);font-size:.72rem;font-weight:700;width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center}

.filter-bar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:16px}
.filter-btn{padding:7px 16px;border-radius:20px;border:1px solid var(--border);background:transparent;color:var(--text-muted);font-family:'DM Sans',sans-serif;font-size:.82rem;font-weight:500;cursor:pointer;transition:all .2s}
.filter-btn:hover{border-color:var(--accent);color:var(--text)}
.filter-btn.active{background:var(--accent);border-color:var(--accent);color:var(--bg)}
.add-project-btn{padding:7px 18px;border-radius:20px;border:1px dashed var(--accent);background:transparent;color:var(--accent);font-family:'DM Sans',sans-serif;font-size:.82rem;font-weight:600;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;gap:5px}
.add-project-btn:hover{background:rgba(201,164,108,.1)}
.backlog-btn{padding:7px 18px;border-radius:20px;border:1px solid #5ca0e0;background:transparent;color:#5ca0e0;font-family:'DM Sans',sans-serif;font-size:.82rem;font-weight:600;cursor:pointer;transition:all .2s;display:inline-flex;align-items:center;gap:5px}
.backlog-btn:hover{background:rgba(92,160,224,.1)}
.backlog-btn.active{background:#5ca0e0;color:var(--bg)}

.main{padding:32px 48px 60px}

/* PROJECT & TASKS */
.project{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:24px;overflow:hidden;animation:fadeUp .45s ease both;transition:border-color .2s}
.project:hover{border-color:#3a3e50}
@keyframes fadeUp{from{opacity:0;transform:translateY(18px)}to{opacity:1;transform:translateY(0)}}
.project-header{display:flex;justify-content:space-between;align-items:center;padding:18px 24px;cursor:pointer;user-select:none}
.project-header:hover{background:var(--surface-hover)}
.project-title-area{display:flex;align-items:center;gap:14px}
.project-icon{width:38px;height:38px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1.1rem;font-weight:700;color:var(--bg);flex-shrink:0}
.project-name{font-size:1.1rem;font-weight:700;letter-spacing:-.2px}
.project-count{font-size:.78rem;color:var(--text-muted);font-weight:500;margin-left:2px}
.project-right{display:flex;align-items:center;gap:10px}
.project-progress{display:flex;align-items:center;gap:10px}
.progress-bar{width:100px;height:5px;background:var(--border);border-radius:4px;overflow:hidden}
.progress-fill{height:100%;background:var(--accent);border-radius:4px;transition:width .5s ease}
.progress-text{font-size:.78rem;color:var(--text-muted);font-weight:500;min-width:28px;text-align:right}
.chevron{color:var(--text-muted);transition:transform .25s ease;font-size:.9rem;margin-left:4px}
.project.collapsed .chevron{transform:rotate(-90deg)}
.project.collapsed .task-list{display:none}
.icon-btn{background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:1rem;padding:4px 8px;border-radius:6px;transition:all .2s;display:flex;align-items:center;justify-content:center}
.icon-btn:hover{background:var(--surface-hover);color:var(--text)}
.icon-btn.danger:hover{background:var(--overdue-bg);color:var(--overdue)}

.task-list{border-top:1px solid var(--border)}
.task-row{display:grid;grid-template-columns:40px 1fr 160px 130px 120px 110px 36px;align-items:center;padding:14px 24px;border-bottom:1px solid rgba(42,45,58,.5);transition:background .25s;gap:8px}
.task-row:hover{background:var(--surface-hover)}
.task-row.done{background:var(--done-bg)}.task-row.done .task-text{text-decoration:line-through;color:var(--text-muted)}
.task-row.in-progress{background:var(--progress-bg)}
.task-row.overdue-row{background:var(--overdue-bg)}
.task-row.my-task{border-left:3px solid var(--accent);background:var(--my-task)}
.task-row.my-task:hover{background:rgba(201,164,108,.12)}
.task-row.my-task.done{background:var(--done-bg);border-left-color:var(--done)}
.task-row.my-task.in-progress{background:var(--progress-bg);border-left-color:var(--progress)}
.task-row.my-task.overdue-row{background:var(--overdue-bg);border-left-color:var(--overdue)}

.checkbox{width:20px;height:20px;border-radius:6px;border:2px solid var(--border);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;flex-shrink:0;-webkit-tap-highlight-color:transparent}
.checkbox:hover{border-color:var(--accent)}
.checkbox.checked{background:var(--done);border-color:var(--done)}
.checkbox.checked::after{content:'âœ“';color:white;font-size:.75rem;font-weight:700}

.task-text-wrap{display:flex;align-items:center;gap:8px}
.task-text{font-size:.92rem;font-weight:500;line-height:1.4;transition:all .2s}
.overdue-icon{color:var(--overdue);font-size:.95rem;font-weight:700;display:flex;align-items:center;gap:3px;animation:pulse 1.5s ease infinite;flex-shrink:0}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
.overdue-icon .overdue-tip{font-size:.7rem;font-weight:600;color:var(--overdue);white-space:nowrap}

.deadline-cell{display:flex;align-items:center;gap:6px;cursor:pointer;position:relative}
.deadline-badge{font-size:.78rem;font-weight:600;padding:4px 10px;border-radius:6px;text-align:center;width:fit-content;white-space:nowrap}
.deadline-today{background:var(--today-bg);color:var(--today)}
.deadline-tomorrow{background:var(--tomorrow-bg);color:var(--tomorrow)}
.deadline-weekly{background:var(--weekly-bg);color:var(--weekly)}
.deadline-daily{background:var(--daily-bg);color:var(--daily)}
.deadline-pending{background:rgba(139,143,163,.1);color:var(--text-muted)}
.deadline-date{background:rgba(201,164,108,.12);color:var(--accent-light)}
.deadline-overdue{background:var(--overdue-bg);color:var(--overdue)}
.deadline-edit-icon{font-size:.7rem;color:var(--text-muted);opacity:0;transition:opacity .15s}
.deadline-cell:hover .deadline-edit-icon{opacity:1}

.deadline-popover{position:absolute;top:100%;left:0;z-index:50;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:12px;box-shadow:0 12px 40px rgba(0,0,0,.5);display:none;min-width:200px}
.deadline-popover.show{display:block}
.deadline-popover select,.deadline-popover input{width:100%;padding:7px 10px;border-radius:6px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;font-size:.85rem;margin-bottom:8px}
.deadline-popover input[type="date"]{color-scheme:dark}
.pop-actions{display:flex;gap:6px;justify-content:flex-end}
.pop-btn{padding:5px 14px;border-radius:6px;font-family:'DM Sans',sans-serif;font-size:.78rem;font-weight:600;cursor:pointer;border:none;transition:all .15s}
.pop-btn-save{background:var(--accent);color:var(--bg)}.pop-btn-save:hover{background:var(--accent-light)}
.pop-btn-cancel{background:transparent;border:1px solid var(--border);color:var(--text-muted)}

.priority-select{font-size:.78rem;font-weight:600;padding:4px 8px;border-radius:6px;border:1px solid transparent;background:transparent;font-family:'DM Sans',sans-serif;cursor:pointer;transition:all .2s;-webkit-appearance:none;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%238b8fa3'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 6px center;padding-right:20px}
.priority-select:hover{border-color:var(--border)}
.priority-select option{background:var(--surface)}
.priority-select.p-high{color:var(--high)}.priority-select.p-medium{color:var(--medium)}.priority-select.p-low{color:var(--low)}
.status-select{font-size:.78rem;font-weight:500;padding:4px 8px;border-radius:6px;border:1px solid var(--border);background:transparent;color:var(--text-muted);font-family:'DM Sans',sans-serif;cursor:pointer;transition:all .2s}
.status-select:hover{border-color:var(--accent)}
.status-select option{background:var(--surface);color:var(--text)}
.status-select.s-progress{border-color:var(--progress);color:var(--progress)}
.status-select.s-done{border-color:var(--done);color:var(--done)}
.person-select{font-size:.82rem;font-weight:500;padding:4px 8px;border-radius:6px;border:1px solid var(--border);background:transparent;color:var(--text);font-family:'DM Sans',sans-serif;cursor:pointer;transition:all .2s;max-width:130px}
.person-select:hover{border-color:var(--accent)}
.person-select option{background:var(--surface);color:var(--text)}
.person-select:disabled,.priority-select:disabled,.status-select:disabled{opacity:.5;cursor:default;pointer-events:none}

.task-header{display:grid;grid-template-columns:40px 1fr 160px 130px 120px 110px 36px;padding:10px 24px;font-size:.72rem;font-weight:600;text-transform:uppercase;letter-spacing:.8px;color:var(--text-muted);border-bottom:1px solid var(--border);gap:8px}
.add-task-row{display:flex;align-items:center;gap:8px;padding:10px 24px;border-top:1px dashed rgba(42,45,58,.7);cursor:pointer;transition:background .15s}
.add-task-row:hover{background:var(--surface-hover)}
.add-icon{width:20px;height:20px;border-radius:6px;border:2px dashed var(--border);display:flex;align-items:center;justify-content:center;font-size:.85rem;color:var(--text-muted);font-weight:500;transition:all .2s}
.add-task-row:hover .add-icon{border-color:var(--accent);color:var(--accent)}
.add-task-label{font-size:.85rem;color:var(--text-muted);font-weight:500}
.add-task-row:hover .add-task-label{color:var(--accent)}

/* MODALS */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.65);display:flex;align-items:center;justify-content:center;z-index:1000;opacity:0;pointer-events:none;transition:opacity .25s ease}
.modal-overlay.open{opacity:1;pointer-events:all}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:16px;width:520px;max-width:92vw;padding:0;transform:translateY(20px) scale(.97);transition:transform .3s ease;box-shadow:0 20px 60px rgba(0,0,0,.5);max-height:90vh;overflow-y:auto}
.modal-overlay.open .modal{transform:translateY(0) scale(1)}
.modal-header{padding:24px 28px 16px;border-bottom:1px solid var(--border)}
.modal-header h2{font-family:'Playfair Display',serif;font-size:1.3rem;font-weight:700;color:var(--accent-light)}
.modal-header p{font-size:.85rem;color:var(--text-muted);margin-top:4px}
.modal-body{padding:20px 28px 8px}
.field{margin-bottom:18px}
.field label{display:block;font-size:.78rem;font-weight:600;text-transform:uppercase;letter-spacing:.6px;color:var(--text-muted);margin-bottom:7px}
.field input,.field select,.field textarea{width:100%;padding:10px 14px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;font-size:.9rem;transition:border-color .2s}
.field input:focus,.field select:focus,.field textarea:focus{outline:none;border-color:var(--accent)}
.field select option{background:var(--bg);color:var(--text)}
.field-row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.field input[type="date"]{color-scheme:dark}
.modal-footer{padding:16px 28px 24px;display:flex;justify-content:flex-end;gap:10px}
.btn{padding:10px 22px;border-radius:8px;font-family:'DM Sans',sans-serif;font-size:.88rem;font-weight:600;cursor:pointer;border:none;transition:all .2s}
.btn-cancel{background:transparent;border:1px solid var(--border);color:var(--text-muted)}.btn-cancel:hover{border-color:var(--text-muted);color:var(--text)}
.btn-add{background:var(--accent);color:var(--bg)}.btn-add:hover{background:var(--accent-light)}
.btn-danger{background:var(--overdue);color:white}.btn-danger:hover{background:#ff6680}
.color-options{display:flex;gap:8px;flex-wrap:wrap}
.color-swatch{width:30px;height:30px;border-radius:8px;cursor:pointer;border:2px solid transparent;transition:all .15s}
.color-swatch:hover{transform:scale(1.15)}
.color-swatch.selected{border-color:white;box-shadow:0 0 0 2px var(--accent)}

/* SETTINGS */
.settings-section{margin-bottom:24px}
.settings-section h3{font-size:.9rem;font-weight:700;color:var(--accent-light);margin-bottom:12px;text-transform:uppercase;letter-spacing:.5px}
.settings-user-row{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:var(--bg);border-radius:8px;margin-bottom:8px;gap:10px}
.settings-user-info{display:flex;align-items:center;gap:10px}
.settings-user-avatar{width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.72rem;font-weight:700;color:var(--bg);flex-shrink:0}
.settings-user-name{font-size:.9rem;font-weight:600}
.settings-user-pass{font-size:.78rem;color:var(--text-muted);font-family:monospace}
.settings-remove-btn{background:none;border:1px solid var(--border);color:var(--text-muted);padding:4px 12px;border-radius:6px;font-size:.78rem;cursor:pointer;transition:all .15s;font-family:'DM Sans',sans-serif}
.settings-remove-btn:hover{border-color:var(--overdue);color:var(--overdue)}
.settings-add-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.settings-add-row input,.settings-add-row select{flex:1;min-width:80px;padding:8px 12px;border-radius:8px;border:1px solid var(--border);background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;font-size:.85rem}
.settings-add-row input:focus{outline:none;border-color:var(--accent)}
.settings-add-btn{padding:8px 18px;border-radius:8px;border:none;background:var(--accent);color:var(--bg);font-family:'DM Sans',sans-serif;font-size:.82rem;font-weight:600;cursor:pointer}
.vis-project-row{display:flex;align-items:center;justify-content:space-between;padding:8px 14px;background:var(--bg);border-radius:8px;margin-bottom:6px}
.vis-project-name{font-size:.88rem;font-weight:500}
.vis-toggles{display:flex;gap:6px;flex-wrap:wrap}
.vis-toggle{padding:3px 10px;border-radius:12px;font-size:.72rem;font-weight:600;border:1px solid var(--border);background:transparent;color:var(--text-muted);cursor:pointer;transition:all .15s}
.vis-toggle.on{background:var(--accent);border-color:var(--accent);color:var(--bg)}
.vis-toggle:hover{border-color:var(--accent)}

/* BACKLOG */
.backlog-section{margin-bottom:28px}
.backlog-user-header{display:flex;align-items:center;gap:10px;margin-bottom:12px;padding:12px 18px;background:var(--surface);border:1px solid var(--border);border-radius:10px}
.backlog-avatar{width:34px;height:34px;border-radius:50%;background:var(--accent);display:flex;align-items:center;justify-content:center;font-size:.8rem;font-weight:700;color:var(--bg)}
.backlog-name{font-size:1rem;font-weight:700}
.backlog-count{font-size:.82rem;color:var(--text-muted);margin-left:4px}
.backlog-task{display:flex;align-items:center;gap:12px;padding:10px 18px;background:var(--surface);border-radius:8px;margin-bottom:4px;font-size:.88rem}
.backlog-task .bt-check{color:var(--done);font-weight:700;font-size:.8rem}
.backlog-task .bt-text{flex:1;color:var(--text-muted);text-decoration:line-through}
.backlog-task .bt-project{font-size:.75rem;padding:3px 8px;border-radius:5px;font-weight:600;white-space:nowrap}
.backlog-task .bt-date{font-size:.75rem;color:var(--text-muted)}
.backlog-empty{color:var(--text-muted);font-size:.88rem;font-style:italic;padding:12px 18px}

/* KPI Cards */
.kpi-row{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:16px}
.kpi-card{background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:14px 16px;display:flex;flex-direction:column;gap:4px;transition:border-color .2s}
.kpi-card:hover{border-color:var(--accent)}
.kpi-label{font-size:.72rem;font-weight:600;text-transform:uppercase;letter-spacing:.6px;color:var(--text-muted)}
.kpi-value{font-size:1.5rem;font-weight:700;line-height:1.2}
.kpi-sub{font-size:.75rem;color:var(--text-muted);font-weight:500}
.kpi-value.kpi-green{color:var(--done)}
.kpi-value.kpi-red{color:var(--overdue)}
.kpi-value.kpi-gold{color:var(--accent-light)}
.kpi-value.kpi-blue{color:var(--weekly)}
.kpi-bar{width:100%;height:6px;background:var(--border);border-radius:4px;margin-top:6px;overflow:hidden}
.kpi-bar-fill{height:100%;border-radius:4px;transition:width .5s ease}
.backlog-task .bt-undo{background:none;border:1px solid var(--border);color:var(--text-muted);padding:3px 10px;border-radius:6px;font-size:.72rem;cursor:pointer;transition:all .15s;font-family:'DM Sans',sans-serif;white-space:nowrap}
.backlog-task .bt-undo:hover{border-color:var(--accent);color:var(--accent)}

/* VIEW TOGGLE */
.view-toggle{display:flex;gap:0;background:var(--bg);border:1px solid var(--border);border-radius:10px;overflow:hidden}
.view-toggle-btn{padding:7px 18px;border:none;background:transparent;color:var(--text-muted);font-family:'DM Sans',sans-serif;font-size:.82rem;font-weight:600;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:6px}
.view-toggle-btn:hover{color:var(--text);background:var(--surface-hover)}
.view-toggle-btn.active{background:var(--accent);color:var(--bg)}

/* FINANCIAL DASHBOARD */
.fin-upload-area{border:2px dashed var(--border);border-radius:var(--radius);padding:40px 32px;text-align:center;transition:all .25s;cursor:pointer;background:var(--surface);margin-bottom:28px}
.fin-upload-area:hover,.fin-upload-area.dragover{border-color:var(--accent);background:rgba(201,164,108,.05)}
.fin-upload-icon{font-size:2.5rem;margin-bottom:10px;opacity:.6}
.fin-upload-title{font-size:1rem;font-weight:600;color:var(--text);margin-bottom:4px}
.fin-upload-sub{font-size:.82rem;color:var(--text-muted)}
.fin-upload-input{display:none}

.fin-business-tabs{display:flex;gap:8px;margin-bottom:24px;flex-wrap:wrap;align-items:center}
.fin-tab{padding:8px 18px;border-radius:20px;border:1px solid var(--border);background:transparent;color:var(--text-muted);font-family:'DM Sans',sans-serif;font-size:.84rem;font-weight:600;cursor:pointer;transition:all .2s;display:flex;align-items:center;gap:6px}
.fin-tab:hover{border-color:var(--accent);color:var(--text)}
.fin-tab.active{background:var(--accent);border-color:var(--accent);color:var(--bg)}
.fin-tab .tab-remove{font-size:.7rem;opacity:.6;margin-left:2px;transition:opacity .15s}
.fin-tab:hover .tab-remove{opacity:1}
.fin-overview-tab{border-color:#9b7ae0;color:#9b7ae0}
.fin-overview-tab:hover{background:rgba(155,122,224,.1)}
.fin-overview-tab.active{background:#9b7ae0;color:var(--bg)}

.fin-kpi-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:28px}
.fin-kpi{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px;transition:border-color .2s}
.fin-kpi:hover{border-color:var(--accent)}
.fin-kpi-label{font-size:.72rem;font-weight:600;text-transform:uppercase;letter-spacing:.7px;color:var(--text-muted);margin-bottom:8px}
.fin-kpi-value{font-size:1.8rem;font-weight:700;line-height:1.1;margin-bottom:4px}
.fin-kpi-sub{font-size:.78rem;color:var(--text-muted);font-weight:500;display:flex;align-items:center;gap:4px}
.fin-kpi-sub .up{color:var(--done)}.fin-kpi-sub .down{color:var(--overdue)}
.fin-kpi-value.green{color:var(--done)}.fin-kpi-value.red{color:var(--overdue)}.fin-kpi-value.gold{color:var(--accent-light)}.fin-kpi-value.blue{color:var(--weekly)}.fin-kpi-value.purple{color:#9b7ae0}

.fin-charts-row{display:grid;grid-template-columns:2fr 1fr;gap:20px;margin-bottom:28px}
.fin-chart-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:24px;overflow:hidden}
.fin-chart-title{font-size:.88rem;font-weight:700;margin-bottom:16px;color:var(--text)}
.fin-chart-wrap{position:relative;width:100%;height:280px}
.fin-chart-wrap canvas{width:100%!important;height:100%!important}

.fin-details-table{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;margin-bottom:28px}
.fin-details-title{padding:18px 24px;font-size:.88rem;font-weight:700;border-bottom:1px solid var(--border)}
.fin-details-row{display:grid;grid-template-columns:var(--fin-detail-cols,200px repeat(auto-fill,minmax(90px,1fr)));padding:10px 24px;border-bottom:1px solid rgba(42,45,58,.5);font-size:.84rem;gap:8px;align-items:center}
.fin-details-row:hover{background:var(--surface-hover)}
.fin-details-row.header{font-size:.72rem;font-weight:600;text-transform:uppercase;letter-spacing:.6px;color:var(--text-muted)}
.fin-details-row.total{font-weight:700;background:rgba(201,164,108,.05);border-top:2px solid var(--border)}
.fin-details-row .label{font-weight:600;color:var(--text)}.fin-details-row .sub-label{color:var(--text-muted);padding-left:16px}
.fin-details-row .neg{color:var(--overdue)}.fin-details-row .pos{color:var(--done)}

.fin-empty{text-align:center;padding:60px 32px;color:var(--text-muted)}
.fin-empty-icon{font-size:3rem;margin-bottom:12px;opacity:.4}
.fin-empty-title{font-size:1.1rem;font-weight:600;color:var(--text);margin-bottom:6px}
.fin-empty-sub{font-size:.88rem}

/* â•â•â• RESPONSIVE â•â•â• */

/* Tablet */
@media(max-width:900px){
  .header{padding:24px 20px 20px}
  .main{padding:20px 20px 40px}
  .header-left h1{font-size:1.8rem}
  .login-card{padding:32px 24px}
  .task-row,.task-header{grid-template-columns:32px 1fr 120px 110px 100px 90px 32px;gap:6px}
  .task-row{padding:12px 16px}
  .project-header{padding:14px 18px}
}

/* Mobile */
@media(max-width:640px){
  .header{padding:18px 14px 14px}
  .main{padding:14px 10px 40px}
  .header-left h1{font-size:1.35rem}
  .header-left .subtitle{font-size:.82rem}
  .header-top{gap:10px}
  .header-right{gap:8px;width:100%;justify-content:flex-end}
  .user-badge{padding:5px 10px;font-size:.78rem}
  .ub-avatar{width:22px;height:22px;font-size:.65rem}
  .ub-role{font-size:.62rem;padding:2px 6px}
  .hdr-btn{padding:6px 12px;font-size:.78rem}

  /* Stats row: 2-column grid */
  .stats-row{gap:8px 16px;margin-top:14px;display:grid;grid-template-columns:1fr 1fr}
  .stat{font-size:.8rem}

  /* Team & filter bars */
  .team-bar{gap:6px;margin-top:12px}
  .team-chip{padding:4px 10px;font-size:.76rem}
  .chip-count{width:17px;height:17px;font-size:.65rem}
  .filter-bar{gap:6px;margin-top:12px}
  .filter-btn{padding:6px 12px;font-size:.78rem}
  .add-project-btn,.backlog-btn{padding:6px 14px;font-size:.78rem}

  /* Project cards */
  .project{border-radius:10px;margin-bottom:16px}
  .project-header{padding:12px 14px;flex-wrap:wrap;gap:8px}
  .project-title-area{gap:10px}
  .project-icon{width:32px;height:32px;font-size:.9rem;border-radius:8px}
  .project-name{font-size:.95rem}
  .project-count{font-size:.72rem}
  .progress-bar{width:60px}
  .progress-text{font-size:.72rem}

  /* Task rows: stacked card layout */
  .task-header{display:none}
  .task-row{display:flex;flex-wrap:wrap;gap:8px 10px;padding:12px 14px;align-items:center}
  .task-row>div:first-child{flex:0 0 auto}
  .task-text-wrap{flex:1 1 calc(100% - 44px);min-width:0}
  .task-text{font-size:.88rem}
  .overdue-icon{font-size:.85rem}
  .overdue-icon .overdue-tip{font-size:.65rem}

  /* Inline meta row beneath text */
  .deadline-cell,.task-row>div:nth-child(4),.task-row>div:nth-child(5),.task-row>div:nth-child(6){flex:0 0 auto}
  .deadline-badge{font-size:.72rem;padding:3px 8px}
  .person-select{font-size:.76rem;padding:3px 6px;max-width:100px}
  .priority-select{font-size:.72rem;padding:3px 6px;padding-right:18px}
  .status-select{font-size:.72rem;padding:3px 6px}
  .task-row>div:last-child{flex:0 0 auto;margin-left:auto}

  .add-task-row{padding:10px 14px}
  .add-icon{width:18px;height:18px;font-size:.8rem}
  .add-task-label{font-size:.8rem}

  /* Deadline popover */
  .deadline-popover{min-width:180px;padding:10px;left:auto;right:0}

  /* Modals: full-width on mobile */
  .modal{width:100%;max-width:100vw;border-radius:14px 14px 0 0;margin-top:auto;max-height:85vh}
  .modal-overlay.open{align-items:flex-end}
  .modal-header{padding:18px 20px 12px}
  .modal-header h2{font-size:1.1rem}
  .modal-body{padding:14px 20px 8px}
  .modal-footer{padding:12px 20px 20px}
  .field label{font-size:.74rem}
  .field input,.field select,.field textarea{padding:9px 12px;font-size:.85rem}
  .field-row{grid-template-columns:1fr;gap:10px}
  .btn{padding:9px 18px;font-size:.84rem}

  /* Settings modal */
  .settings-user-row{flex-direction:column;align-items:flex-start;gap:8px;padding:10px 12px}
  .settings-user-row>div:last-child{width:100%;display:flex;gap:6px}
  .settings-user-row>div:last-child .settings-remove-btn{flex:1}
  .settings-add-row{flex-direction:column}
  .settings-add-row input,.settings-add-row select{width:100%;min-width:unset}
  .vis-project-row{flex-direction:column;align-items:flex-start;gap:6px;padding:8px 12px}
  .vis-toggles{gap:5px}
  .vis-toggle{font-size:.7rem;padding:3px 8px}

  /* Backlog */
  .backlog-user-header{padding:10px 14px}
  .backlog-avatar{width:28px;height:28px;font-size:.72rem}
  .backlog-name{font-size:.9rem}
  .backlog-task{padding:8px 14px;gap:8px;flex-wrap:wrap}
  .backlog-task .bt-text{font-size:.82rem}
  .backlog-task .bt-project{font-size:.7rem}
  .kpi-row{grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:12px}
  .kpi-card{padding:10px 12px}
  .kpi-value{font-size:1.2rem}

  /* Financial */
  .fin-kpi-grid{grid-template-columns:repeat(2,1fr);gap:10px}
  .fin-kpi{padding:14px}
  .fin-kpi-value{font-size:1.3rem}
  .fin-charts-row{grid-template-columns:1fr;gap:14px}
  .fin-chart-wrap{height:220px}
  .fin-upload-area{padding:28px 18px}
  .fin-details-row{grid-template-columns:140px repeat(auto-fill,minmax(70px,1fr));font-size:.76rem;padding:8px 14px}
  .view-toggle-btn{padding:6px 12px;font-size:.78rem}

  /* Login */
  .login-card{padding:28px 20px;width:100%;max-width:100vw;border-radius:16px;margin:12px}
  .login-logo{font-size:1.6rem}
  .login-sub{font-size:.82rem;margin-bottom:24px}
  .login-field input{padding:11px 14px;font-size:.9rem}
  .login-btn{padding:12px;font-size:.9rem}
}

/* Small phones */
@media(max-width:380px){
  .header{padding:14px 10px 12px}
  .main{padding:10px 8px 36px}
  .header-left h1{font-size:1.15rem}
  .stats-row{grid-template-columns:1fr 1fr;gap:6px 10px}
  .stat{font-size:.74rem}
  .project-header{padding:10px 12px}
  .task-row{padding:10px 12px;gap:6px 8px}
  .task-text{font-size:.84rem}
  .person-select,.priority-select,.status-select{font-size:.7rem}
  .modal{border-radius:12px 12px 0 0}
}
</style>
</head>
<body>

<!-- Splash Screen -->
<div class="splash" id="splashScreen" style="display:none">
  <div class="splash-logo-wrap">
    <div class="splash-glow"></div>
    <div class="splash-m">
      <svg viewBox="0 0 120 120" fill="none" xmlns="http://www.w3.org/2000/svg">
        <!-- Outer frame -->
        <rect x="4" y="4" width="112" height="112" rx="22" stroke="#c9a46c" stroke-width="2.5" fill="none" opacity=".3"/>
        <!-- M lettermark -->
        <path d="M32 88V38l28 30 28-30v50" stroke="#c9a46c" stroke-width="6" stroke-linecap="round" stroke-linejoin="round" fill="none">
          <animate attributeName="stroke-dasharray" from="0 250" to="250 0" dur="1s" begin=".3s" fill="freeze"/>
        </path>
        <!-- Accent dot -->
        <circle cx="60" cy="32" r="4" fill="#e0c98f" opacity="0">
          <animate attributeName="opacity" from="0" to="1" dur=".3s" begin="1s" fill="freeze"/>
          <animate attributeName="r" from="0" to="4" dur=".3s" begin="1s" fill="freeze"/>
        </circle>
      </svg>
    </div>
    <div class="splash-line"></div>
    <div class="splash-brand">
      <div class="splash-title">MPIRE</div>
    </div>
    <div class="splash-welcome" id="splashWelcome"></div>
  </div>
</div>

<div class="login-page" id="loginPage">
  <div class="login-card">
    <div class="login-logo">MPIRE</div>
    <div class="login-sub">Sign in to access your dashboard</div>
    <div class="login-field"><label>Username</label><input type="text" id="loginUser" placeholder="Enter your username" autocomplete="off"></div>
    <div class="login-field"><label>Password</label><input type="password" id="loginPass" placeholder="Enter your password"></div>
    <button class="login-btn" onclick="doLogin()">Sign In</button>
    <div class="login-error" id="loginError"></div>
    <div class="login-footer">Project Task Board Â· Secure Login</div>
  </div>
</div>

<div class="app" id="app">
<div class="header">
  <div class="header-top">
    <div class="header-left"><h1>Task Board</h1><div class="subtitle"><span id="projectCount">0</span> projects Â· <span id="totalTasks">0</span> tasks</div></div>
    <div class="header-right">
      <div class="user-badge"><span class="ub-avatar" id="ubAvatar"></span><span id="ubName"></span><span class="ub-role" id="ubRole"></span></div>
      <div class="view-toggle" id="viewToggle" style="display:none">
        <button class="view-toggle-btn active" id="viewTasksBtn" onclick="switchView('tasks')">Tasks</button>
        <button class="view-toggle-btn" id="viewFinBtn" onclick="switchView('financials')">Financials</button>
      </div>
      <button class="hdr-btn" id="settingsBtn" style="display:none" onclick="openSettingsModal()">âš™ Settings</button>
      <button class="hdr-btn logout-btn" onclick="doLogout()">Logout</button>
    </div>
  </div>
  <div id="tasksHeaderSection">
  <div class="stats-row">
    <div class="stat"><div class="stat-dot" style="background:var(--today)"></div>Today <strong id="statToday">0</strong></div>
    <div class="stat"><div class="stat-dot" style="background:var(--tomorrow)"></div>Tomorrow <strong id="statTomorrow">0</strong></div>
    <div class="stat"><div class="stat-dot" style="background:var(--daily)"></div>Daily <strong id="statDaily">0</strong></div>
    <div class="stat"><div class="stat-dot" style="background:var(--weekly)"></div>Weekly <strong id="statWeekly">0</strong></div>
    <div class="stat"><div class="stat-dot" style="background:var(--overdue)"></div>Overdue <strong id="statOverdue">0</strong></div>
    <div class="stat"><div class="stat-dot" style="background:var(--progress)"></div>In Progress <strong id="statProgress">0</strong></div>
    <div class="stat"><div class="stat-dot" style="background:var(--done)"></div>Done <strong id="statDone">0</strong></div>
  </div>
  <div class="team-bar" id="teamBar"><span class="team-bar-label">Team</span></div>
  <div class="filter-bar" id="filterBar">
    <button class="filter-btn active" data-filter="all">All</button>
    <button class="filter-btn" data-filter="today">Today</button>
    <button class="filter-btn" data-filter="tomorrow">Tomorrow</button>
    <button class="filter-btn" data-filter="pending">Pending</button>
    <button class="add-project-btn" id="addProjectBtn" style="display:none" onclick="openProjectModal()">+ New Project</button>
    <button class="backlog-btn" id="backlogBtn" style="display:none" onclick="toggleBacklog()">ðŸ“‹ Backlog</button>
  </div>
  </div>
</div>
<div class="main" id="projectContainer"></div>
<div class="main" id="financialContainer" style="display:none"></div>
</div>

<!-- Task Modal (Add) -->
<div class="modal-overlay" id="taskModalOverlay"><div class="modal">
  <div class="modal-header"><h2 id="taskModalTitle">Add New Task</h2><p>Project: <strong id="modalProjectName"></strong></p></div>
  <div class="modal-body">
    <div class="field"><label>Task Description</label><input type="text" id="newTaskText" placeholder="What needs to be done?" autocomplete="off"></div>
    <div class="field-row"><div class="field"><label>Deadline</label><select id="newDeadlineType" onchange="toggleDateField()"><option value="today">Today</option><option value="tomorrow">Tomorrow</option><option value="daily">Daily</option><option value="weekly">Weekly</option><option value="pending">Pending</option><option value="date">Pick a Date</option></select></div><div class="field" id="datePickerField" style="display:none"><label>Date</label><input type="date" id="newDeadlineDate"></div></div>
    <div class="field-row"><div class="field"><label>Person</label><select id="newPerson"></select></div><div class="field"><label>Priority</label><select id="newPriority"><option value="high">ðŸ”´ High</option><option value="medium" selected>ðŸŸ¡ Medium</option><option value="low">ðŸ”µ Low</option></select></div></div>
  </div>
  <div class="modal-footer"><button class="btn btn-cancel" onclick="closeTaskModal()">Cancel</button><button class="btn btn-add" id="taskModalSaveBtn" onclick="saveTaskModal()">Add Task</button></div>
</div></div>

<!-- Project Modal -->
<div class="modal-overlay" id="projectModalOverlay"><div class="modal">
  <div class="modal-header"><h2>New Project</h2><p>Create a new project</p></div>
  <div class="modal-body"><div class="field"><label>Project Name</label><input type="text" id="newProjectName" placeholder="e.g. Marketing Campaign" autocomplete="off"></div><div class="field"><label>Color</label><div class="color-options" id="colorOptions"></div></div></div>
  <div class="modal-footer"><button class="btn btn-cancel" onclick="closeProjectModal()">Cancel</button><button class="btn btn-add" onclick="addProject()">Create Project</button></div>
</div></div>

<!-- Delete Modal -->
<div class="modal-overlay" id="deleteModalOverlay"><div class="modal">
  <div class="modal-header"><h2>Delete Project</h2><p>Are you sure you want to delete <strong id="deleteProjectName"></strong>?</p></div>
  <div class="modal-footer"><button class="btn btn-cancel" onclick="closeDeleteModal()">Cancel</button><button class="btn btn-danger" onclick="confirmDeleteProject()">Delete</button></div>
</div></div>

<!-- Settings Modal -->
<div class="modal-overlay" id="settingsModalOverlay"><div class="modal" style="width:620px">
  <div class="modal-header"><h2>âš™ Admin Settings</h2><p>Manage users, roles & project visibility</p></div>
  <div class="modal-body" id="settingsBody"></div>
  <div class="modal-footer"><button class="btn btn-add" onclick="closeSettingsModal()">Done</button></div>
</div></div>

<script>
// â•â•â• DATA â•â•â•
const USERS=[
  {username:'Almuhannad',password:'7242',role:'owner',displayName:'Almuhannad'},
  {username:'Harith',password:'3917',role:'user',displayName:'Harith'},
  {username:'Hilal',password:'5683',role:'user',displayName:'Hilal'},
  {username:'Marwan',password:'8246',role:'user',displayName:'Marwan'},
];
const PROJECTS=[
  {name:"Sama Hotel",color:"#c9a46c",visibility:{},tasks:[
    {text:"Tell Harith to buy descent",person:"Harith",deadline:"today",priority:"high",status:"todo"},
    {text:"Follow up on pending rents",person:"â€”",deadline:"daily",priority:"high",status:"todo"},
    {text:"Send the sheet to ROP",person:"â€”",deadline:"today",priority:"medium",status:"todo"},
    {text:"Take cheque to bank",person:"â€”",deadline:"tomorrow",priority:"medium",status:"todo"},
  ]},
  {name:"Real Estate",color:"#5ca0e0",visibility:{},tasks:[
    {text:"Follow up with Harith on filling the sheet (before end of month)",person:"Harith",deadline:"weekly",priority:"high",status:"todo"},
    {text:"Take cheque to bank",person:"â€”",deadline:"tomorrow",priority:"medium",status:"todo"},
  ]},
  {name:"MPire Production",color:"#9b7ae0",visibility:{},tasks:[
    {text:"Follow up with team to send quotes",person:"Team",deadline:"tomorrow",priority:"high",status:"todo"},
  ]},
  {name:"Hospitality Company",color:"#e0a33c",visibility:{},tasks:[
    {text:"Waiting on Hilal's reply",person:"Hilal",deadline:"pending",priority:"medium",status:"todo"},
  ]},
  {name:"The Peak",color:"#4ead6b",visibility:{},tasks:[
    {text:"Print new cups",person:"â€”",deadline:"today",priority:"low",status:"todo"},
    {text:"Follow up with Harith on purchases and delivery time",person:"Harith",deadline:"tomorrow",priority:"medium",status:"todo"},
  ]},
  {name:"Al Jaban Alali",color:"#e05c5c",visibility:{},tasks:[
    {text:"Review contract with Marwan",person:"Marwan",deadline:"today",priority:"high",status:"todo"},
  ]},
  {name:"Business Manager",color:"#e08a5c",visibility:{},tasks:[
    {text:"Take Porsche to dealership",person:"â€”",deadline:"tomorrow",priority:"low",status:"todo"},
  ]}
];
const PROJECT_COLORS=['#c9a46c','#5ca0e0','#9b7ae0','#e0a33c','#4ead6b','#e05c5c','#e08a5c','#5cc0b8','#b06ec9','#7a8ee0'];
let currentUser=null,activeFilter='all',activePersonFilter=null,taskModalProjectIndex=null,deleteProjectIndex=null,selectedProjectColor=PROJECT_COLORS[0],openPopover=null;
let editingTask=null; // {pi,ti} when editing
let showBacklog=false;
let currentView='tasks'; // 'tasks' or 'financials'
let financialData=[]; // [{businessName,fileName,parsedPL:{periods,revenue,cogs,grossProfit,opex,netProfit,otherRows}}]
let activeFinBusiness=null; // null = overview, or index into financialData
let finCharts={}; // store chart instances for cleanup

// â•â•â• SUPABASE SETUP â•â•â•
const SUPABASE_URL='https://tqhanahgzlkrqdbmfpfp.supabase.co';
const SUPABASE_KEY='sb_publishable_4qWwGX4zgtzMhrB8YI4vHw_LcE6eNRr';
const supabase=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);

// â•â•â• FINANCIAL DATA PERSISTENCE (Cloud + Local Cache) â•â•â•
function saveFinancialData(){
  try{localStorage.setItem('mpire_financial_data',JSON.stringify(financialData))}catch(e){}
  if(!currentUser)return;
  supabase.from('financial_data').upsert({username:currentUser.username,data:financialData,updated_at:new Date().toISOString()},{onConflict:'username'}).then(({error})=>{
    if(error)console.warn('Supabase save error:',error.message);
  });
}
function loadFinancialData(){
  try{const d=localStorage.getItem('mpire_financial_data');if(d){financialData=JSON.parse(d)}}catch(e){financialData=[]}
}
async function loadFinancialDataFromCloud(){
  if(!currentUser)return;
  try{
    const{data,error}=await supabase.from('financial_data').select('data').eq('username',currentUser.username).maybeSingle();
    if(error){console.warn('Supabase load error:',error.message);return}
    if(data&&data.data){
      financialData=data.data;
      try{localStorage.setItem('mpire_financial_data',JSON.stringify(financialData))}catch(e){}
    }
  }catch(e){console.warn('Cloud load failed, using local cache:',e)}
}
loadFinancialData();

function esc(s){const d=document.createElement('div');d.textContent=s;return d.innerHTML}
function getTodayStr(){const d=new Date();return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0')}
function getPeopleList(){return ['â€”',...USERS.map(u=>u.displayName),'Team']}
function isOverdue(t){if(t.status==='done')return false;const dl=t.deadline;if(dl&&dl.includes('-')&&dl<getTodayStr())return true;return false}

// Permissions
function isOwner(){return currentUser&&currentUser.role==='owner'}
function isManager(){return currentUser&&currentUser.role==='manager'}
function canManage(){return isOwner()||isManager()}
function canEditTask(){return canManage()}
function canChangeStatus(t){if(canManage())return true;return currentUser&&t.person===currentUser.displayName}
function canAccessSettings(){return isOwner()}
function canSeeProject(p){if(!currentUser)return false;if(isOwner())return true;if(p.visibility[currentUser.username]===false)return false;return true}
function getRoleLabel(r){return r==='owner'?'Owner':r==='manager'?'Manager':'User'}
function getRoleColor(r){return r==='owner'?'var(--accent)':r==='manager'?'#5ca0e0':'var(--text-muted)'}
function getDeadlineLabel(d){const m={today:'Today',tomorrow:'Tomorrow',daily:'Daily',weekly:'Weekly',pending:'Pending'};if(m[d])return m[d];if(d&&d.includes('-')){const dt=new Date(d+'T00:00:00');return dt.toLocaleDateString('en-GB',{day:'numeric',month:'short',year:'numeric'})}return d||'None'}
function getDeadlineClass(d,t){if(t&&isOverdue(t))return'deadline-overdue';return['today','tomorrow','weekly','daily','pending'].includes(d)?`deadline-${d}`:'deadline-date'}

// â•â•â• LOGIN â•â•â•
function doLogin(){
  const u=document.getElementById('loginUser').value.trim(),p=document.getElementById('loginPass').value;
  const user=USERS.find(x=>x.username.toLowerCase()===u.toLowerCase()&&x.password===p);
  if(!user){document.getElementById('loginError').textContent='Invalid username or password';return}
  currentUser=user;
  // Load financial data from cloud while splash plays
  const cloudLoad=loadFinancialDataFromCloud();
  document.getElementById('loginPage').style.display='none';
  // Show splash screen
  const splash=document.getElementById('splashScreen');
  splash.style.display='flex';splash.classList.remove('hide');
  document.getElementById('splashWelcome').textContent='Welcome back, '+user.displayName;
  // After animation, transition to dashboard
  setTimeout(async()=>{
    await cloudLoad;
    splash.classList.add('hide');
    document.getElementById('app').classList.add('visible');
    setupApp();
    setTimeout(()=>{splash.style.display='none'},700);
  },2600);
}
function doLogout(){currentUser=null;showBacklog=false;currentView='tasks';financialData=[];activeFinBusiness=null;document.getElementById('app').classList.remove('visible');document.getElementById('loginPage').style.display='flex';document.getElementById('loginUser').value='';document.getElementById('loginPass').value='';document.getElementById('loginError').textContent=''}
document.getElementById('loginPass').addEventListener('keydown',e=>{if(e.key==='Enter')doLogin()});
document.getElementById('loginUser').addEventListener('keydown',e=>{if(e.key==='Enter')document.getElementById('loginPass').focus()});

function setupApp(){
  document.getElementById('ubAvatar').textContent=currentUser.displayName.charAt(0);
  document.getElementById('ubName').textContent=currentUser.displayName;
  const rl=document.getElementById('ubRole');rl.textContent=getRoleLabel(currentUser.role);rl.style.color=getRoleColor(currentUser.role);rl.style.background=currentUser.role==='owner'?'rgba(201,164,108,.15)':currentUser.role==='manager'?'rgba(92,160,224,.15)':'rgba(139,143,163,.15)';
  document.getElementById('settingsBtn').style.display=canAccessSettings()?'flex':'none';
  document.getElementById('viewToggle').style.display=isOwner()?'flex':'none';
  document.getElementById('addProjectBtn').style.display=canManage()?'inline-flex':'none';
  document.getElementById('backlogBtn').style.display=canManage()?'inline-flex':'none';
  activeFilter='all';activePersonFilter=null;showBacklog=false;currentView='tasks';switchView('tasks');
}

// â•â•â• TEAM BAR â•â•â•
function renderTeamBar(){
  const bar=document.getElementById('teamBar'),counts={};
  PROJECTS.forEach(p=>{if(!canSeeProject(p))return;p.tasks.forEach(t=>{if(t.person&&t.person!=='â€”'&&t.status!=='done')counts[t.person]=(counts[t.person]||0)+1})});
  bar.innerHTML='<span class="team-bar-label">Team</span>';
  if(!Object.keys(counts).length){bar.innerHTML+='<span style="font-size:.82rem;color:var(--text-muted)">No assigned tasks</span>';return}
  bar.innerHTML+=`<div class="team-chip ${activePersonFilter===null?'active':''}" onclick="setPersonFilter(null)"><span>All</span></div>`;
  Object.entries(counts).sort((a,b)=>b[1]-a[1]).forEach(([n,c])=>{bar.innerHTML+=`<div class="team-chip ${activePersonFilter===n?'active':''}" onclick="setPersonFilter('${esc(n)}')"><span>${esc(n)}</span><span class="chip-count">${c}</span></div>`});
}
function setPersonFilter(p){activePersonFilter=p;render()}

// â•â•â• BACKLOG â•â•â•
function toggleBacklog(){showBacklog=!showBacklog;document.querySelector('.backlog-btn').classList.toggle('active',showBacklog);render()}

function renderBacklog(){
  const container=document.getElementById('projectContainer');container.innerHTML='';
  // Gather all tasks by user for KPI calculation
  const userStats={};
  PROJECTS.forEach((p,pi)=>{if(!canSeeProject(p))return;p.tasks.forEach((t,ti)=>{
    const person=t.person||'â€”';
    if(!userStats[person])userStats[person]={completed:[],overdue:[],total:0,inProgress:0,todo:0};
    userStats[person].total++;
    if(t.status==='done')userStats[person].completed.push({...t,projectName:p.name,projectColor:p.color,pi,ti});
    else if(t.status==='progress')userStats[person].inProgress++;
    else userStats[person].todo++;
    if(isOverdue(t))userStats[person].overdue.push({...t,projectName:p.name,projectColor:p.color});
  })});
  // Only show users who have completed tasks or overdue tasks
  const relevantUsers=Object.entries(userStats).filter(([_,s])=>s.completed.length>0||s.overdue.length>0);
  if(!relevantUsers.length){container.innerHTML='<div class="backlog-empty">No completed tasks yet.</div>';return}
  relevantUsers.sort((a,b)=>b[1].completed.length-a[1].completed.length).forEach(([person,stats])=>{
    const sec=document.createElement('div');sec.className='backlog-section';
    const completionRate=stats.total>0?Math.round((stats.completed.length/stats.total)*100):0;
    const overdueCount=stats.overdue.length;
    const barColor=completionRate>=75?'var(--done)':completionRate>=40?'var(--progress)':'var(--overdue)';
    sec.innerHTML=`
      <div class="backlog-user-header"><div class="backlog-avatar">${person.charAt(0)}</div><span class="backlog-name">${esc(person)}</span><span class="backlog-count">${stats.total} total tasks</span></div>
      <div class="kpi-row">
        <div class="kpi-card"><span class="kpi-label">Completed</span><span class="kpi-value kpi-green">${stats.completed.length}</span><span class="kpi-sub">of ${stats.total} tasks</span><div class="kpi-bar"><div class="kpi-bar-fill" style="width:${completionRate}%;background:${barColor}"></div></div></div>
        <div class="kpi-card"><span class="kpi-label">Past Due</span><span class="kpi-value ${overdueCount>0?'kpi-red':'kpi-green'}">${overdueCount}</span><span class="kpi-sub">${overdueCount>0?'tasks overdue':'all on track'}</span></div>
        <div class="kpi-card"><span class="kpi-label">In Progress</span><span class="kpi-value kpi-gold">${stats.inProgress}</span><span class="kpi-sub">${stats.todo} still to do</span></div>
        <div class="kpi-card"><span class="kpi-label">Performance</span><span class="kpi-value ${completionRate>=75?'kpi-green':completionRate>=40?'kpi-gold':'kpi-red'}">${completionRate}%</span><span class="kpi-sub">completion rate</span><div class="kpi-bar"><div class="kpi-bar-fill" style="width:${completionRate}%;background:${barColor}"></div></div></div>
      </div>
      ${overdueCount>0?`<div style="margin-bottom:12px"><div style="font-size:.78rem;font-weight:600;color:var(--overdue);margin-bottom:6px;padding:0 4px">âš  OVERDUE TASKS</div>${stats.overdue.map(t=>`<div class="backlog-task" style="border-left:3px solid var(--overdue)"><span class="overdue-icon" style="animation:none">âš </span><span style="flex:1;font-size:.88rem">${esc(t.text)}</span><span class="bt-project" style="background:${t.projectColor}20;color:${t.projectColor}">${esc(t.projectName)}</span><span class="bt-date" style="color:var(--overdue)">${getDeadlineLabel(t.deadline)}</span></div>`).join('')}</div>`:''}
      ${stats.completed.length>0?`<div style="font-size:.78rem;font-weight:600;color:var(--done);margin-bottom:6px;padding:0 4px">âœ“ COMPLETED TASKS</div>`:''}
      ${stats.completed.map(t=>`<div class="backlog-task"><span class="bt-check">âœ“</span><span class="bt-text">${esc(t.text)}</span><span class="bt-project" style="background:${t.projectColor}20;color:${t.projectColor}">${esc(t.projectName)}</span><span class="bt-date">${getDeadlineLabel(t.deadline)}</span><button class="bt-undo" onclick="undoComplete(${t.pi},${t.ti})" title="Move back to task list">â†© Undo</button></div>`).join('')}`;
    container.appendChild(sec);
  });
}
function undoComplete(pi,ti){PROJECTS[pi].tasks[ti].status='todo';render()}

// â•â•â• RENDER â•â•â•
function render(){
  if(showBacklog){renderBacklog();renderTeamBar();updateStats();return}
  const container=document.getElementById('projectContainer');container.innerHTML='';
  const PEOPLE=getPeopleList();
  let totalTasks=0,doneCount=0,progressCount=0,overdueCount=0,todayCount=0,tomorrowCount=0,dailyCount=0,weeklyCount=0,visibleProjects=0;

  PROJECTS.forEach((project,pi)=>{
    if(!canSeeProject(project))return;
    let tasks=project.tasks.filter(t=>t.status!=='done');
    if(activeFilter!=='all')tasks=tasks.filter(t=>t.deadline===activeFilter);
    if(activePersonFilter)tasks=tasks.filter(t=>t.person===activePersonFilter);
    if((activeFilter!=='all'||activePersonFilter)&&tasks.length===0)return;

    visibleProjects++;totalTasks+=tasks.length;
    progressCount+=tasks.filter(t=>t.status==='progress').length;
    overdueCount+=tasks.filter(t=>isOverdue(t)).length;
    // Progress bar uses all tasks (including done in backlog) to show true project progress
    const allProjectTasks=project.tasks;
    const doneInPAll=allProjectTasks.filter(t=>t.status==='done').length;doneCount+=doneInPAll;
    const pct=allProjectTasks.length?Math.round((doneInPAll/allProjectTasks.length)*100):0;
    tasks.forEach(t=>{if(t.deadline==='today')todayCount++;else if(t.deadline==='tomorrow')tomorrowCount++;else if(t.deadline==='daily')dailyCount++;else if(t.deadline==='weekly')weeklyCount++});

    const el=document.createElement('div');el.className='project';
    el.innerHTML=`
      <div class="project-header">
        <div class="project-title-area" onclick="toggleProject(this.parentElement)"><div class="project-icon" style="background:${project.color}">${project.name.charAt(0)}</div><div><span class="project-name">${esc(project.name)}</span><span class="project-count">${tasks.length} task${tasks.length!==1?'s':''}</span></div></div>
        <div class="project-right">
          <div class="project-progress" onclick="toggleProject(this.parentElement.parentElement)"><div class="progress-bar"><div class="progress-fill" style="width:${pct}%"></div></div><span class="progress-text">${pct}%</span><span class="chevron">â–¼</span></div>
          ${canManage()?`<button class="icon-btn danger" title="Delete project" onclick="event.stopPropagation();openDeleteModal(${pi})">ðŸ—‘</button>`:''}
        </div>
      </div>
      <div class="task-list">
        <div class="task-header"><div></div><div>Task</div><div>Deadline</div><div>Person</div><div>Priority</div><div>Status</div><div></div></div>
        ${tasks.map(t=>{
          const ri=project.tasks.indexOf(t),isDone=t.status==='done',isProg=t.status==='progress',overdue=isOverdue(t),isMyTask=currentUser&&t.person===currentUser.displayName;
          let rowCls=isDone?'done':(isProg?'in-progress':'');if(overdue&&!isDone)rowCls+=' overdue-row';if(isMyTask)rowCls+=' my-task';
          const statusCls=isDone?'s-done':(isProg?'s-progress':''),dlClass=getDeadlineClass(t.deadline,t);
          const canEdit=canEditTask(),canStatus=canChangeStatus(t),dis=canEdit?'':'disabled',sDis=canStatus?'':'disabled';
          return `<div class="task-row ${rowCls}">
            <div class="checkbox ${isDone?'checked':''}" ${canStatus?`onclick="toggleCheck(${pi},${ri})"`:'style="opacity:.4;cursor:default"'}></div>
            <div class="task-text-wrap">${overdue?'<span class="overdue-icon">âš  <span class="overdue-tip">OVERDUE</span></span>':''}<span class="task-text">${esc(t.text)}</span></div>
            ${canEdit?`<div class="deadline-cell" onclick="event.stopPropagation();toggleDeadlinePopover('pop-${pi}-${ri}')"><span class="deadline-badge ${dlClass}">${getDeadlineLabel(t.deadline)}</span><span class="deadline-edit-icon">âœŽ</span><div class="deadline-popover" id="pop-${pi}-${ri}"><select id="dltype-${pi}-${ri}" onchange="togglePopDateField(${pi},${ri})"><option value="today" ${t.deadline==='today'?'selected':''}>Today</option><option value="tomorrow" ${t.deadline==='tomorrow'?'selected':''}>Tomorrow</option><option value="daily" ${t.deadline==='daily'?'selected':''}>Daily</option><option value="weekly" ${t.deadline==='weekly'?'selected':''}>Weekly</option><option value="pending" ${t.deadline==='pending'?'selected':''}>Pending</option><option value="date" ${(t.deadline&&t.deadline.includes('-'))?'selected':''}>Pick a Date</option></select><input type="date" id="dldate-${pi}-${ri}" value="${(t.deadline&&t.deadline.includes('-'))?t.deadline:''}" style="display:${(t.deadline&&t.deadline.includes('-'))?'block':'none'}"><div class="pop-actions"><button class="pop-btn pop-btn-cancel" onclick="event.stopPropagation();closeDeadlinePopover()">Cancel</button><button class="pop-btn pop-btn-save" onclick="event.stopPropagation();saveDeadline(${pi},${ri})">Save</button></div></div></div>`:`<div><span class="deadline-badge ${dlClass}">${getDeadlineLabel(t.deadline)}</span></div>`}
            <div><select class="person-select" ${dis} onchange="PROJECTS[${pi}].tasks[${ri}].person=this.value;renderTeamBar()">${PEOPLE.map(p=>`<option value="${esc(p)}" ${t.person===p?'selected':''}>${esc(p)}</option>`).join('')}</select></div>
            <div><select class="priority-select p-${t.priority}" ${dis} onchange="setPriority(${pi},${ri},this.value)"><option value="high" ${t.priority==='high'?'selected':''}>ðŸ”´ High</option><option value="medium" ${t.priority==='medium'?'selected':''}>ðŸŸ¡ Medium</option><option value="low" ${t.priority==='low'?'selected':''}>ðŸ”µ Low</option></select></div>
            <div><select class="status-select ${statusCls}" ${sDis} onchange="setStatus(${pi},${ri},this.value)"><option value="todo" ${t.status==='todo'?'selected':''}>To Do</option><option value="progress" ${t.status==='progress'?'selected':''}>In Progress</option><option value="done" ${t.status==='done'?'selected':''}>Done</option></select></div>
            <div>${canEdit?`<button class="icon-btn" title="Edit task" onclick="openEditTask(${pi},${ri})">âœŽ</button>`:''}</div>
          </div>`}).join('')}
        ${canManage()?`<div class="add-task-row" onclick="openTaskModal(${pi})"><div class="add-icon">+</div><span class="add-task-label">Add task</span></div>`:''}
      </div>`;
    container.appendChild(el);
  });
  document.getElementById('projectCount').textContent=visibleProjects;
  document.getElementById('totalTasks').textContent=totalTasks;
  document.getElementById('statToday').textContent=todayCount;document.getElementById('statTomorrow').textContent=tomorrowCount;
  document.getElementById('statDaily').textContent=dailyCount;document.getElementById('statWeekly').textContent=weeklyCount;
  document.getElementById('statOverdue').textContent=overdueCount;document.getElementById('statProgress').textContent=progressCount;
  document.getElementById('statDone').textContent=doneCount;renderTeamBar();
}

function updateStats(){
  let todayCount=0,tomorrowCount=0,dailyCount=0,weeklyCount=0,overdueCount=0,progressCount=0,doneCount=0,totalTasks=0,visibleProjects=0;
  PROJECTS.forEach(p=>{if(!canSeeProject(p))return;visibleProjects++;p.tasks.forEach(t=>{totalTasks++;if(t.status==='done')doneCount++;if(t.status==='progress')progressCount++;if(isOverdue(t))overdueCount++;if(t.deadline==='today')todayCount++;else if(t.deadline==='tomorrow')tomorrowCount++;else if(t.deadline==='daily')dailyCount++;else if(t.deadline==='weekly')weeklyCount++})});
  document.getElementById('projectCount').textContent=visibleProjects;document.getElementById('totalTasks').textContent=totalTasks;
  document.getElementById('statToday').textContent=todayCount;document.getElementById('statTomorrow').textContent=tomorrowCount;
  document.getElementById('statDaily').textContent=dailyCount;document.getElementById('statWeekly').textContent=weeklyCount;
  document.getElementById('statOverdue').textContent=overdueCount;document.getElementById('statProgress').textContent=progressCount;document.getElementById('statDone').textContent=doneCount;
}

function toggleProject(h){h.closest('.project').classList.toggle('collapsed')}
function toggleCheck(pi,ti){const t=PROJECTS[pi].tasks[ti];if(!canChangeStatus(t))return;t.status=t.status==='done'?'todo':'done';render()}
function setStatus(pi,ti,v){if(!canChangeStatus(PROJECTS[pi].tasks[ti]))return;PROJECTS[pi].tasks[ti].status=v;render()}
function setPriority(pi,ti,v){if(!canManage())return;PROJECTS[pi].tasks[ti].priority=v;render()}

// Deadline popover
function toggleDeadlinePopover(id){closeDeadlinePopover();const p=document.getElementById(id);if(p){p.classList.add('show');openPopover=p}}
function closeDeadlinePopover(){if(openPopover){openPopover.classList.remove('show');openPopover=null}}
function togglePopDateField(pi,ri){document.getElementById(`dldate-${pi}-${ri}`).style.display=document.getElementById(`dltype-${pi}-${ri}`).value==='date'?'block':'none'}
function saveDeadline(pi,ri){let dl=document.getElementById(`dltype-${pi}-${ri}`).value;if(dl==='date')dl=document.getElementById(`dldate-${pi}-${ri}`).value||'pending';PROJECTS[pi].tasks[ri].deadline=dl;closeDeadlinePopover();render()}
document.addEventListener('click',e=>{if(openPopover&&!e.target.closest('.deadline-cell'))closeDeadlinePopover()});

// â•â•â• TASK MODAL (Add & Edit) â•â•â•
function openTaskModal(pi){
  editingTask=null;taskModalProjectIndex=pi;
  document.getElementById('taskModalTitle').textContent='Add New Task';
  document.getElementById('taskModalSaveBtn').textContent='Add Task';
  document.getElementById('modalProjectName').textContent=PROJECTS[pi].name;
  document.getElementById('newTaskText').value='';document.getElementById('newDeadlineType').value='today';
  document.getElementById('newDeadlineDate').value='';document.getElementById('newPriority').value='medium';
  document.getElementById('datePickerField').style.display='none';
  document.getElementById('newPerson').innerHTML=getPeopleList().map(p=>`<option value="${p}">${p}</option>`).join('');
  document.getElementById('taskModalOverlay').classList.add('open');
  setTimeout(()=>document.getElementById('newTaskText').focus(),200);
}
function openEditTask(pi,ti){
  const t=PROJECTS[pi].tasks[ti];editingTask={pi,ti};taskModalProjectIndex=pi;
  document.getElementById('taskModalTitle').textContent='Edit Task';
  document.getElementById('taskModalSaveBtn').textContent='Save Changes';
  document.getElementById('modalProjectName').textContent=PROJECTS[pi].name;
  document.getElementById('newTaskText').value=t.text;
  if(t.deadline&&t.deadline.includes('-')){document.getElementById('newDeadlineType').value='date';document.getElementById('newDeadlineDate').value=t.deadline;document.getElementById('datePickerField').style.display='block'}else{document.getElementById('newDeadlineType').value=t.deadline||'today';document.getElementById('newDeadlineDate').value='';document.getElementById('datePickerField').style.display='none'}
  document.getElementById('newPriority').value=t.priority;
  const PEOPLE=getPeopleList();document.getElementById('newPerson').innerHTML=PEOPLE.map(p=>`<option value="${p}" ${t.person===p?'selected':''}>${p}</option>`).join('');
  document.getElementById('taskModalOverlay').classList.add('open');
  setTimeout(()=>document.getElementById('newTaskText').focus(),200);
}
function closeTaskModal(){document.getElementById('taskModalOverlay').classList.remove('open');taskModalProjectIndex=null;editingTask=null}
function toggleDateField(){document.getElementById('datePickerField').style.display=document.getElementById('newDeadlineType').value==='date'?'block':'none'}
function saveTaskModal(){
  const text=document.getElementById('newTaskText').value.trim();if(!text)return;
  let dt=document.getElementById('newDeadlineType').value,deadline=dt;
  if(dt==='date')deadline=document.getElementById('newDeadlineDate').value||'pending';
  const person=document.getElementById('newPerson').value,priority=document.getElementById('newPriority').value;
  if(editingTask){
    const t=PROJECTS[editingTask.pi].tasks[editingTask.ti];
    t.text=text;t.deadline=deadline;t.person=person;t.priority=priority;
  }else{
    if(taskModalProjectIndex===null)return;
    PROJECTS[taskModalProjectIndex].tasks.push({text,person,deadline,priority,status:'todo'});
  }
  closeTaskModal();render();
}
document.getElementById('taskModalOverlay').addEventListener('click',e=>{if(e.target===e.currentTarget)closeTaskModal()});

// Project Modal
function openProjectModal(){document.getElementById('newProjectName').value='';selectedProjectColor=PROJECT_COLORS[0];renderColorOptions();document.getElementById('projectModalOverlay').classList.add('open');setTimeout(()=>document.getElementById('newProjectName').focus(),200)}
function closeProjectModal(){document.getElementById('projectModalOverlay').classList.remove('open')}
function renderColorOptions(){document.getElementById('colorOptions').innerHTML=PROJECT_COLORS.map(c=>`<div class="color-swatch ${c===selectedProjectColor?'selected':''}" style="background:${c}" onclick="selectedProjectColor='${c}';renderColorOptions()"></div>`).join('')}
function addProject(){const name=document.getElementById('newProjectName').value.trim();if(!name)return;PROJECTS.push({name,color:selectedProjectColor,visibility:{},tasks:[]});closeProjectModal();render()}
document.getElementById('projectModalOverlay').addEventListener('click',e=>{if(e.target===e.currentTarget)closeProjectModal()});

// Delete Modal
function openDeleteModal(pi){deleteProjectIndex=pi;document.getElementById('deleteProjectName').textContent=PROJECTS[pi].name;document.getElementById('deleteModalOverlay').classList.add('open')}
function closeDeleteModal(){document.getElementById('deleteModalOverlay').classList.remove('open');deleteProjectIndex=null}
function confirmDeleteProject(){if(deleteProjectIndex!==null)PROJECTS.splice(deleteProjectIndex,1);closeDeleteModal();render()}
document.getElementById('deleteModalOverlay').addEventListener('click',e=>{if(e.target===e.currentTarget)closeDeleteModal()});

// â•â•â• SETTINGS â•â•â•
function openSettingsModal(){renderSettings();document.getElementById('settingsModalOverlay').classList.add('open')}
function closeSettingsModal(){document.getElementById('settingsModalOverlay').classList.remove('open');render()}
document.getElementById('settingsModalOverlay').addEventListener('click',e=>{if(e.target===e.currentTarget)closeSettingsModal()});

function renderSettings(){
  const body=document.getElementById('settingsBody');
  body.innerHTML=`
    <div class="settings-section">
      <h3>ðŸ‘¥ Users & Roles</h3>
      <p style="font-size:.82rem;color:var(--text-muted);margin-bottom:12px"><span style="color:var(--accent)">â—</span> Owner &nbsp;<span style="color:#5ca0e0">â—</span> Manager &nbsp;<span style="color:var(--text-muted)">â—</span> User</p>
      ${USERS.map((u,i)=>{
        const rc=getRoleColor(u.role),rl=getRoleLabel(u.role);
        let actions='';
        if(u.role==='owner'){actions='<span style="font-size:.72rem;color:var(--text-muted);font-style:italic">God Mode</span>'}
        else{const pb=u.role==='user'?`<button class="settings-remove-btn" style="border-color:#5ca0e0;color:#5ca0e0" onclick="setRole(${i},'manager')">â†‘ Manager</button>`:`<button class="settings-remove-btn" onclick="setRole(${i},'user')">â†“ User</button>`;actions=`${pb}<button class="settings-remove-btn" onclick="removeUser(${i})">Remove</button>`}
        return `<div class="settings-user-row"><div class="settings-user-info"><div class="settings-user-avatar" style="background:${rc}">${u.displayName.charAt(0)}</div><div><div class="settings-user-name">${esc(u.displayName)} <span style="color:${rc};font-size:.72rem;font-weight:600">${rl.toUpperCase()}</span></div><div class="settings-user-pass">Password: ${u.password}</div></div></div><div style="display:flex;gap:6px;align-items:center">${actions}</div></div>`
      }).join('')}
      <div style="margin-top:12px"><div class="settings-add-row"><input type="text" id="addUserName" placeholder="Username"><input type="text" id="addUserPass" placeholder="4-digit PIN" maxlength="4"><select id="addUserRole"><option value="user">User</option><option value="manager">Manager</option></select><button class="settings-add-btn" onclick="addUser()">+ Add</button></div></div>
    </div>
    <div class="settings-section">
      <h3>ðŸ“ Project Visibility</h3>
      <p style="font-size:.82rem;color:var(--text-muted);margin-bottom:12px">Toggle which projects each user/manager can see. Owner always sees all.</p>
      ${PROJECTS.map((p,pi)=>{
        const toggleUsers=USERS.filter(u=>u.role!=='owner');
        if(!toggleUsers.length)return'<p style="font-size:.82rem;color:var(--text-muted)">No users to configure.</p>';
        return `<div class="vis-project-row"><div class="vis-project-name" style="color:${p.color}">â— ${esc(p.name)}</div><div class="vis-toggles">${toggleUsers.map(u=>{const isOn=p.visibility[u.username]!==false;const roleTag=u.role==='manager'?'<span style="font-size:.6rem;color:#5ca0e0"> M</span>':'';return `<button class="vis-toggle ${isOn?'on':''}" onclick="toggleVisibility(${pi},'${esc(u.username)}')">${esc(u.displayName)}${roleTag}</button>`}).join('')}</div></div>`
      }).join('')}
    </div>`;
}
function setRole(i,role){if(USERS[i].role==='owner')return;USERS[i].role=role;renderSettings()}
function removeUser(i){if(USERS[i].role==='owner')return;USERS.splice(i,1);renderSettings()}
function addUser(){const name=document.getElementById('addUserName').value.trim(),pass=document.getElementById('addUserPass').value.trim(),role=document.getElementById('addUserRole').value;if(!name){alert('Please enter a username');return}if(!pass||pass.length!==4||isNaN(pass)){alert('Please enter a 4-digit PIN');return}if(USERS.find(u=>u.username.toLowerCase()===name.toLowerCase())){alert('Username already exists');return}USERS.push({username:name,password:pass,role,displayName:name});renderSettings()}
function toggleVisibility(pi,username){const p=PROJECTS[pi];if(p.visibility[username]===false)delete p.visibility[username];else p.visibility[username]=false;renderSettings()}

// â•â•â• FINANCIAL TRACKER â•â•â•
function switchView(view){
  currentView=view;
  document.getElementById('viewTasksBtn').classList.toggle('active',view==='tasks');
  document.getElementById('viewFinBtn').classList.toggle('active',view==='financials');
  const tasksHeader=document.getElementById('tasksHeaderSection');
  const projContainer=document.getElementById('projectContainer');
  const finContainer=document.getElementById('financialContainer');
  const h1=document.querySelector('.header-left h1');
  const subtitle=document.querySelector('.header-left .subtitle');
  if(view==='tasks'){
    tasksHeader.style.display='';projContainer.style.display='';finContainer.style.display='none';
    h1.textContent='Task Board';subtitle.style.display='';
    render();
  }else{
    tasksHeader.style.display='none';projContainer.style.display='none';finContainer.style.display='';
    h1.textContent='Financial Dashboard';subtitle.style.display='none';
    renderFinancialDashboard();
  }
}

function handleFinFileUpload(files){
  Array.from(files).forEach(file=>{
    if(!file.name.match(/\.(xlsx|xls|csv)$/i)){alert('Please upload Excel files (.xlsx, .xls) or CSV files');return}
    const reader=new FileReader();
    reader.onload=function(e){
      try{
        const wb=XLSX.read(e.target.result,{type:'array'});
        const parsed=parsePLFromWorkbook(wb,file.name);
        if(parsed){
          financialData.push(parsed);
          saveFinancialData();
          activeFinBusiness=financialData.length-1;
          renderFinancialDashboard();
        }else{alert('Could not find P&L data in "'+file.name+'". Make sure the file contains a Profit & Loss sheet with recognizable line items (Revenue, Cost, Profit, etc.).')}
      }catch(err){alert('Error reading file: '+err.message)}
    };
    reader.readAsArrayBuffer(file);
  });
}

function removeFinBusiness(idx){
  financialData.splice(idx,1);
  saveFinancialData();
  if(activeFinBusiness>=financialData.length)activeFinBusiness=financialData.length>0?0:null;
  if(financialData.length===0)activeFinBusiness=null;
  renderFinancialDashboard();
}

// â•â•â• P&L AUTO-DETECTION â•â•â•
const PL_KEYWORDS={
  revenue:['revenue','total revenue','sales','total sales','net revenue','net sales','income','total income','turnover','gross revenue'],
  cogs:['cost of goods sold','cogs','cost of sales','cost of revenue','direct costs','cost of goods','cos'],
  grossProfit:['gross profit','gross income','gross margin'],
  opex:['operating expenses','total operating expenses','total expenses','operating costs','overhead','selling general','sg&a','admin expenses','general & administrative','general and administrative'],
  operatingIncome:['operating income','operating profit','ebit','earnings before interest'],
  netProfit:['net profit','net income','net earnings','profit after tax','net profit/(loss)','net income/(loss)','profit for the period','profit for the year','bottom line','net profit after tax'],
  ebitda:['ebitda','earnings before interest tax depreciation'],
  depreciation:['depreciation','depreciation & amortization','depreciation and amortization','d&a'],
  interest:['interest expense','interest','finance costs','financial expenses'],
  tax:['tax','income tax','tax expense','provision for taxes','taxation']
};

function matchPLKey(label){
  if(!label)return null;
  const l=label.toString().toLowerCase().replace(/[^a-z0-9&/ ]/g,'').trim();
  if(!l)return null;
  for(const[key,patterns]of Object.entries(PL_KEYWORDS)){
    for(const p of patterns){if(l===p||l.startsWith(p))return key}
  }
  return null;
}

function detectPeriodHeaders(row){
  const periods=[];
  const monthPat=/^(jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)/i;
  const qPat=/^q[1-4]/i;
  const yearPat=/^(19|20)\d{2}$/;
  const dateMonthPat=/^\d{1,2}[\/\-]\d{4}$/;
  for(let c=1;c<row.length;c++){
    const v=row[c];
    if(v==null)continue;
    const s=v.toString().trim();
    if(monthPat.test(s)||qPat.test(s)||yearPat.test(s)||dateMonthPat.test(s)){
      periods.push({col:c,label:s});
    }
  }
  return periods;
}

function parsePLFromWorkbook(wb,fileName){
  // Try to find a P&L sheet by name
  const plNamePats=[/p\s*[&\/]\s*l/i,/profit/i,/loss/i,/income\s*statement/i,/pnl/i];
  let targetSheet=null;
  for(const name of wb.SheetNames){
    for(const pat of plNamePats){if(pat.test(name)){targetSheet=name;break}}
    if(targetSheet)break;
  }
  // If not found by name, scan all sheets for P&L content
  const sheetsToTry=targetSheet?[targetSheet]:wb.SheetNames;
  for(const sheetName of sheetsToTry){
    const ws=wb.Sheets[sheetName];
    const data=XLSX.utils.sheet_to_json(ws,{header:1,defval:null});
    if(!data||data.length<3)continue;
    const result=extractPLData(data);
    if(result){
      const bizName=fileName.replace(/\.(xlsx|xls|csv)$/i,'').replace(/[_-]/g,' ');
      return{businessName:bizName,fileName,sheetName,...result};
    }
  }
  return null;
}

function extractPLData(data){
  let periods=[];
  let headerRow=-1;
  // Find the header row with period labels
  for(let r=0;r<Math.min(data.length,15);r++){
    const row=data[r];
    if(!row)continue;
    const detected=detectPeriodHeaders(row);
    if(detected.length>=1){periods=detected;headerRow=r;break}
  }
  // If no period headers found, treat as single-period (column B = values)
  if(periods.length===0){
    // Check if column B has numbers for known P&L rows
    const singlePeriod=extractSinglePeriod(data);
    if(singlePeriod)return singlePeriod;
    return null;
  }
  // Extract P&L values
  const plData={periods:periods.map(p=>p.label),revenue:[],cogs:[],grossProfit:[],opex:[],operatingIncome:[],netProfit:[],ebitda:[],depreciation:[],interest:[],tax:[],otherRows:[]};
  let foundAny=false;
  for(let r=headerRow+1;r<data.length;r++){
    const row=data[r];
    if(!row||!row[0])continue;
    const label=row[0].toString().trim();
    const key=matchPLKey(label);
    const values=periods.map(p=>{const v=row[p.col];return typeof v==='number'?v:(parseFloat(String(v).replace(/[,$()]/g,''))||0)});
    if(key&&plData[key]!==undefined){
      if(plData[key].length===0){plData[key]=values;foundAny=true}
      else{plData.otherRows.push({label,key,values})}
    }else if(label&&values.some(v=>v!==0)){
      plData.otherRows.push({label,key:null,values});
    }
  }
  if(!foundAny)return null;
  // Auto-calculate missing fields
  if(plData.revenue.length&&plData.cogs.length&&!plData.grossProfit.length){
    plData.grossProfit=plData.revenue.map((r,i)=>r-(plData.cogs[i]||0));
  }
  if(plData.grossProfit.length&&plData.opex.length&&!plData.netProfit.length&&!plData.operatingIncome.length){
    plData.netProfit=plData.grossProfit.map((g,i)=>g-Math.abs(plData.opex[i]||0));
  }
  return{parsedPL:plData};
}

function extractSinglePeriod(data){
  const plData={periods:['Total'],revenue:[],cogs:[],grossProfit:[],opex:[],operatingIncome:[],netProfit:[],ebitda:[],depreciation:[],interest:[],tax:[],otherRows:[]};
  let foundAny=false;
  for(let r=0;r<data.length;r++){
    const row=data[r];
    if(!row||!row[0])continue;
    const label=row[0].toString().trim();
    const key=matchPLKey(label);
    // Find first numeric value in the row
    let val=0;
    for(let c=1;c<row.length;c++){
      const v=row[c];
      if(typeof v==='number'){val=v;break}
      const parsed=parseFloat(String(v||'').replace(/[,$()]/g,''));
      if(!isNaN(parsed)){val=parsed;break}
    }
    if(key&&plData[key]!==undefined&&plData[key].length===0){
      plData[key]=[val];foundAny=true;
    }else if(label&&val!==0){
      plData.otherRows.push({label,key,values:[val]});
    }
  }
  if(!foundAny)return null;
  if(plData.revenue.length&&plData.cogs.length&&!plData.grossProfit.length){
    plData.grossProfit=plData.revenue.map((r,i)=>r-(plData.cogs[i]||0));
  }
  return{parsedPL:plData};
}

// â•â•â• FINANCIAL KPI HELPERS â•â•â•
function fmtMoney(n){
  if(n==null||isNaN(n))return'â€”';
  const abs=Math.abs(n);
  const sign=n<0?'-':'';
  if(abs>=1e9)return sign+(abs/1e9).toFixed(1)+'B';
  if(abs>=1e6)return sign+(abs/1e6).toFixed(1)+'M';
  if(abs>=1e3)return sign+(abs/1e3).toFixed(1)+'K';
  return sign+abs.toFixed(0);
}
function fmtPct(n){return n==null||isNaN(n)?'â€”':n.toFixed(1)+'%'}
function arrSum(a){return a.reduce((s,v)=>s+(v||0),0)}
function arrLast(a){return a.length?a[a.length-1]:0}
function calcGrowth(a){if(a.length<2)return null;const prev=a[a.length-2],cur=a[a.length-1];if(!prev)return null;return((cur-prev)/Math.abs(prev))*100}

// â•â•â• RENDER FINANCIAL DASHBOARD â•â•â•
function destroyFinCharts(){Object.values(finCharts).forEach(c=>{if(c&&c.destroy)c.destroy()});finCharts={}}

function renderFinancialDashboard(){
  destroyFinCharts();
  const container=document.getElementById('financialContainer');
  if(!financialData.length){
    container.innerHTML=`
      <div class="fin-upload-area" id="finUploadArea" onclick="document.getElementById('finFileInput').click()" ondragover="event.preventDefault();this.classList.add('dragover')" ondragleave="this.classList.remove('dragover')" ondrop="event.preventDefault();this.classList.remove('dragover');handleFinFileUpload(event.dataTransfer.files)">
        <div class="fin-upload-icon">ðŸ“Š</div>
        <div class="fin-upload-title">Upload P&L Excel File</div>
        <div class="fin-upload-sub">Drag & drop your Excel file here, or click to browse. Each file represents one business.</div>
        <input type="file" id="finFileInput" class="fin-upload-input" accept=".xlsx,.xls,.csv" multiple onchange="handleFinFileUpload(this.files)">
      </div>
      <div class="fin-empty">
        <div class="fin-empty-icon">ðŸ“ˆ</div>
        <div class="fin-empty-title">No Financial Data Yet</div>
        <div class="fin-empty-sub">Upload Excel files with P&L sheets to see your financial KPIs, charts, and performance metrics.</div>
      </div>`;
    return;
  }
  // Build HTML
  let html=`
    <div class="fin-upload-area" style="padding:18px 24px;margin-bottom:20px;display:flex;align-items:center;gap:16px;cursor:pointer" onclick="document.getElementById('finFileInput').click()" ondragover="event.preventDefault();this.classList.add('dragover')" ondragleave="this.classList.remove('dragover')" ondrop="event.preventDefault();this.classList.remove('dragover');handleFinFileUpload(event.dataTransfer.files)">
      <span style="font-size:1.3rem">ðŸ“Š</span>
      <div><div style="font-size:.88rem;font-weight:600">Upload Another Business</div><div style="font-size:.78rem;color:var(--text-muted)">Drop Excel file or click to browse</div></div>
      <input type="file" id="finFileInput" class="fin-upload-input" accept=".xlsx,.xls,.csv" multiple onchange="handleFinFileUpload(this.files)">
    </div>
    <div class="fin-business-tabs">
      <button class="fin-tab fin-overview-tab ${activeFinBusiness===null?'active':''}" onclick="activeFinBusiness=null;renderFinancialDashboard()">Overview</button>
      ${financialData.map((b,i)=>`<button class="fin-tab ${activeFinBusiness===i?'active':''}" onclick="activeFinBusiness=${i};renderFinancialDashboard()">${esc(b.businessName)}<span class="tab-remove" onclick="event.stopPropagation();removeFinBusiness(${i})">âœ•</span></button>`).join('')}
    </div>`;
  if(activeFinBusiness===null){
    html+=renderFinOverview();
  }else{
    html+=renderFinBusiness(financialData[activeFinBusiness]);
  }
  container.innerHTML=html;
  // Render charts after DOM is ready
  setTimeout(()=>{
    if(activeFinBusiness===null)renderOverviewCharts();
    else renderBusinessCharts(financialData[activeFinBusiness]);
  },50);
}

function renderFinOverview(){
  // Aggregate across all businesses
  let totalRevenue=0,totalCogs=0,totalGP=0,totalOpex=0,totalNet=0,bizCount=financialData.length;
  const bizSummaries=[];
  financialData.forEach(b=>{
    const pl=b.parsedPL;
    const rev=arrSum(pl.revenue),cogs=arrSum(pl.cogs),gp=arrSum(pl.grossProfit),opex=arrSum(pl.opex),net=arrSum(pl.netProfit);
    totalRevenue+=rev;totalCogs+=cogs;totalGP+=gp;totalOpex+=opex;totalNet+=net;
    bizSummaries.push({name:b.businessName,revenue:rev,cogs,grossProfit:gp,opex,netProfit:net,margin:rev?((net/rev)*100):0});
  });
  const totalGrossMargin=totalRevenue?((totalGP/totalRevenue)*100):0;
  const totalNetMargin=totalRevenue?((totalNet/totalRevenue)*100):0;
  return `
    <div class="fin-kpi-grid">
      <div class="fin-kpi"><div class="fin-kpi-label">Total Revenue</div><div class="fin-kpi-value gold">${fmtMoney(totalRevenue)}</div><div class="fin-kpi-sub">${bizCount} business${bizCount!==1?'es':''}</div></div>
      <div class="fin-kpi"><div class="fin-kpi-label">Total Gross Profit</div><div class="fin-kpi-value green">${fmtMoney(totalGP)}</div><div class="fin-kpi-sub">Margin: ${fmtPct(totalGrossMargin)}</div></div>
      <div class="fin-kpi"><div class="fin-kpi-label">Total Net Profit</div><div class="fin-kpi-value ${totalNet>=0?'green':'red'}">${fmtMoney(totalNet)}</div><div class="fin-kpi-sub">Margin: ${fmtPct(totalNetMargin)}</div></div>
      <div class="fin-kpi"><div class="fin-kpi-label">Total Expenses</div><div class="fin-kpi-value red">${fmtMoney(totalCogs+totalOpex)}</div><div class="fin-kpi-sub">COGS: ${fmtMoney(totalCogs)} + OpEx: ${fmtMoney(totalOpex)}</div></div>
    </div>
    <div class="fin-charts-row">
      <div class="fin-chart-card"><div class="fin-chart-title">Revenue by Business</div><div class="fin-chart-wrap"><canvas id="overviewRevenueChart"></canvas></div></div>
      <div class="fin-chart-card"><div class="fin-chart-title">Profit Margin Comparison</div><div class="fin-chart-wrap"><canvas id="overviewMarginChart"></canvas></div></div>
    </div>
    <div class="fin-details-table" style="--fin-detail-cols:200px repeat(6,minmax(80px,1fr))">
      <div class="fin-details-title">Business Performance Summary</div>
      <div class="fin-details-row header"><div>Business</div><div>Revenue</div><div>COGS</div><div>Gross Profit</div><div>OpEx</div><div>Net Profit</div><div>Margin</div></div>
      ${bizSummaries.map(b=>`<div class="fin-details-row"><div class="label">${esc(b.name)}</div><div>${fmtMoney(b.revenue)}</div><div class="neg">${fmtMoney(b.cogs)}</div><div class="pos">${fmtMoney(b.grossProfit)}</div><div class="neg">${fmtMoney(b.opex)}</div><div class="${b.netProfit>=0?'pos':'neg'}">${fmtMoney(b.netProfit)}</div><div class="${b.margin>=0?'pos':'neg'}">${fmtPct(b.margin)}</div></div>`).join('')}
      <div class="fin-details-row total"><div class="label">TOTAL</div><div>${fmtMoney(totalRevenue)}</div><div class="neg">${fmtMoney(totalCogs)}</div><div class="pos">${fmtMoney(totalGP)}</div><div class="neg">${fmtMoney(totalOpex)}</div><div class="${totalNet>=0?'pos':'neg'}">${fmtMoney(totalNet)}</div><div class="${totalNetMargin>=0?'pos':'neg'}">${fmtPct(totalNetMargin)}</div></div>
    </div>`;
}

function renderFinBusiness(biz){
  const pl=biz.parsedPL,periods=pl.periods;
  const totalRev=arrSum(pl.revenue),totalCogs=arrSum(pl.cogs),totalGP=arrSum(pl.grossProfit);
  const totalOpex=arrSum(pl.opex),totalNet=arrSum(pl.netProfit);
  const grossMargin=totalRev?((totalGP/totalRev)*100):0;
  const netMargin=totalRev?((totalNet/totalRev)*100):0;
  const revGrowth=calcGrowth(pl.revenue);
  const profitGrowth=calcGrowth(pl.netProfit);
  return `
    <div class="fin-kpi-grid">
      <div class="fin-kpi"><div class="fin-kpi-label">Revenue</div><div class="fin-kpi-value gold">${fmtMoney(totalRev)}</div><div class="fin-kpi-sub">${revGrowth!==null?`<span class="${revGrowth>=0?'up':'down'}">${revGrowth>=0?'â–²':'â–¼'} ${fmtPct(Math.abs(revGrowth))}</span> vs prev period`:`${periods.length} period${periods.length!==1?'s':''}`}</div></div>
      <div class="fin-kpi"><div class="fin-kpi-label">Gross Profit</div><div class="fin-kpi-value green">${fmtMoney(totalGP)}</div><div class="fin-kpi-sub">Margin: ${fmtPct(grossMargin)}</div></div>
      <div class="fin-kpi"><div class="fin-kpi-label">Net Profit</div><div class="fin-kpi-value ${totalNet>=0?'green':'red'}">${fmtMoney(totalNet)}</div><div class="fin-kpi-sub">${profitGrowth!==null?`<span class="${profitGrowth>=0?'up':'down'}">${profitGrowth>=0?'â–²':'â–¼'} ${fmtPct(Math.abs(profitGrowth))}</span> vs prev`:`Margin: ${fmtPct(netMargin)}`}</div></div>
      <div class="fin-kpi"><div class="fin-kpi-label">Net Margin</div><div class="fin-kpi-value ${netMargin>=20?'green':netMargin>=0?'gold':'red'}">${fmtPct(netMargin)}</div><div class="fin-kpi-sub">Gross: ${fmtPct(grossMargin)}</div></div>
    </div>
    <div class="fin-kpi-grid" style="grid-template-columns:repeat(4,1fr)">
      <div class="fin-kpi"><div class="fin-kpi-label">COGS</div><div class="fin-kpi-value red">${fmtMoney(totalCogs)}</div><div class="fin-kpi-sub">${totalRev?fmtPct((totalCogs/totalRev)*100):''} of revenue</div></div>
      <div class="fin-kpi"><div class="fin-kpi-label">Operating Expenses</div><div class="fin-kpi-value red">${fmtMoney(totalOpex)}</div><div class="fin-kpi-sub">${totalRev?fmtPct((totalOpex/totalRev)*100):''} of revenue</div></div>
      <div class="fin-kpi"><div class="fin-kpi-label">EBITDA</div><div class="fin-kpi-value purple">${pl.ebitda.length?fmtMoney(arrSum(pl.ebitda)):'â€”'}</div><div class="fin-kpi-sub">${pl.ebitda.length&&totalRev?fmtPct((arrSum(pl.ebitda)/totalRev)*100)+' margin':''}</div></div>
      <div class="fin-kpi"><div class="fin-kpi-label">Last Period Revenue</div><div class="fin-kpi-value gold">${fmtMoney(arrLast(pl.revenue))}</div><div class="fin-kpi-sub">${periods.length?periods[periods.length-1]:''}</div></div>
    </div>
    ${periods.length>1?`
    <div class="fin-charts-row">
      <div class="fin-chart-card"><div class="fin-chart-title">Revenue & Profit Trend</div><div class="fin-chart-wrap"><canvas id="bizTrendChart"></canvas></div></div>
      <div class="fin-chart-card"><div class="fin-chart-title">Expense Breakdown</div><div class="fin-chart-wrap"><canvas id="bizExpenseChart"></canvas></div></div>
    </div>
    <div class="fin-charts-row" style="grid-template-columns:1fr 1fr">
      <div class="fin-chart-card"><div class="fin-chart-title">Margin Trend</div><div class="fin-chart-wrap"><canvas id="bizMarginChart"></canvas></div></div>
      <div class="fin-chart-card"><div class="fin-chart-title">Revenue vs Costs</div><div class="fin-chart-wrap"><canvas id="bizWaterfallChart"></canvas></div></div>
    </div>`:''}
    <div class="fin-details-table" style="--fin-detail-cols:200px repeat(${periods.length+1},minmax(80px,1fr))">
      <div class="fin-details-title">P&L Details â€” ${esc(biz.businessName)} (Sheet: ${esc(biz.sheetName||'â€”')})</div>
      <div class="fin-details-row header"><div>Line Item</div>${periods.map(p=>`<div>${esc(p)}</div>`).join('')}<div>Total</div></div>
      ${pl.revenue.length?`<div class="fin-details-row"><div class="label">Revenue</div>${pl.revenue.map(v=>`<div class="pos">${fmtMoney(v)}</div>`).join('')}<div class="pos"><strong>${fmtMoney(totalRev)}</strong></div></div>`:''}
      ${pl.cogs.length?`<div class="fin-details-row"><div class="label">COGS</div>${pl.cogs.map(v=>`<div class="neg">${fmtMoney(v)}</div>`).join('')}<div class="neg"><strong>${fmtMoney(totalCogs)}</strong></div></div>`:''}
      ${pl.grossProfit.length?`<div class="fin-details-row total"><div class="label">Gross Profit</div>${pl.grossProfit.map(v=>`<div class="pos">${fmtMoney(v)}</div>`).join('')}<div class="pos"><strong>${fmtMoney(totalGP)}</strong></div></div>`:''}
      ${pl.opex.length?`<div class="fin-details-row"><div class="label">Operating Expenses</div>${pl.opex.map(v=>`<div class="neg">${fmtMoney(v)}</div>`).join('')}<div class="neg"><strong>${fmtMoney(totalOpex)}</strong></div></div>`:''}
      ${pl.operatingIncome.length?`<div class="fin-details-row"><div class="label">Operating Income</div>${pl.operatingIncome.map(v=>`<div class="${v>=0?'pos':'neg'}">${fmtMoney(v)}</div>`).join('')}<div class="${arrSum(pl.operatingIncome)>=0?'pos':'neg'}"><strong>${fmtMoney(arrSum(pl.operatingIncome))}</strong></div></div>`:''}
      ${pl.depreciation.length?`<div class="fin-details-row"><div class="sub-label">Depreciation</div>${pl.depreciation.map(v=>`<div>${fmtMoney(v)}</div>`).join('')}<div>${fmtMoney(arrSum(pl.depreciation))}</div></div>`:''}
      ${pl.interest.length?`<div class="fin-details-row"><div class="sub-label">Interest</div>${pl.interest.map(v=>`<div class="neg">${fmtMoney(v)}</div>`).join('')}<div class="neg">${fmtMoney(arrSum(pl.interest))}</div></div>`:''}
      ${pl.tax.length?`<div class="fin-details-row"><div class="sub-label">Tax</div>${pl.tax.map(v=>`<div class="neg">${fmtMoney(v)}</div>`).join('')}<div class="neg">${fmtMoney(arrSum(pl.tax))}</div></div>`:''}
      ${pl.netProfit.length?`<div class="fin-details-row total"><div class="label">Net Profit</div>${pl.netProfit.map(v=>`<div class="${v>=0?'pos':'neg'}">${fmtMoney(v)}</div>`).join('')}<div class="${totalNet>=0?'pos':'neg'}"><strong>${fmtMoney(totalNet)}</strong></div></div>`:''}
      ${pl.ebitda.length?`<div class="fin-details-row"><div class="label">EBITDA</div>${pl.ebitda.map(v=>`<div class="pos">${fmtMoney(v)}</div>`).join('')}<div class="pos"><strong>${fmtMoney(arrSum(pl.ebitda))}</strong></div></div>`:''}
    </div>`;
}

// â•â•â• CHART RENDERING â•â•â•
const chartColors=['#c9a46c','#5ca0e0','#9b7ae0','#e0a33c','#4ead6b','#e05c5c','#e08a5c','#5cc0b8'];
const chartDefaults={responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#8b8fa3',font:{family:'DM Sans',size:11}}}},scales:{x:{ticks:{color:'#8b8fa3',font:{family:'DM Sans',size:10}},grid:{color:'rgba(42,45,58,.5)'}},y:{ticks:{color:'#8b8fa3',font:{family:'DM Sans',size:10},callback:v=>fmtMoney(v)},grid:{color:'rgba(42,45,58,.5)'}}}};

function renderOverviewCharts(){
  const revEl=document.getElementById('overviewRevenueChart');
  const margEl=document.getElementById('overviewMarginChart');
  if(!revEl||!margEl)return;
  const names=financialData.map(b=>b.businessName);
  const revenues=financialData.map(b=>arrSum(b.parsedPL.revenue));
  const margins=financialData.map(b=>{const rev=arrSum(b.parsedPL.revenue);const net=arrSum(b.parsedPL.netProfit);return rev?(net/rev)*100:0});
  finCharts.overviewRevenue=new Chart(revEl,{type:'bar',data:{labels:names,datasets:[{label:'Revenue',data:revenues,backgroundColor:chartColors.slice(0,names.length),borderRadius:6}]},options:{...chartDefaults,plugins:{...chartDefaults.plugins,legend:{display:false}}}});
  finCharts.overviewMargin=new Chart(margEl,{type:'bar',data:{labels:names,datasets:[{label:'Net Margin %',data:margins,backgroundColor:margins.map(m=>m>=0?'rgba(78,173,107,.7)':'rgba(255,77,106,.7)'),borderRadius:6}]},options:{...chartDefaults,plugins:{...chartDefaults.plugins,legend:{display:false}},scales:{...chartDefaults.scales,y:{...chartDefaults.scales.y,ticks:{...chartDefaults.scales.y.ticks,callback:v=>v+'%'}}}}});
}

function renderBusinessCharts(biz){
  const pl=biz.parsedPL,periods=pl.periods;
  if(periods.length<2)return;
  // Revenue & Profit trend
  const trendEl=document.getElementById('bizTrendChart');
  if(trendEl){
    const datasets=[{label:'Revenue',data:pl.revenue,borderColor:'#c9a46c',backgroundColor:'rgba(201,164,108,.1)',fill:true,tension:.3}];
    if(pl.grossProfit.length)datasets.push({label:'Gross Profit',data:pl.grossProfit,borderColor:'#4ead6b',backgroundColor:'rgba(78,173,107,.1)',fill:true,tension:.3});
    if(pl.netProfit.length)datasets.push({label:'Net Profit',data:pl.netProfit,borderColor:'#5ca0e0',backgroundColor:'rgba(92,160,224,.1)',fill:true,tension:.3});
    finCharts.bizTrend=new Chart(trendEl,{type:'line',data:{labels:periods,datasets},options:chartDefaults});
  }
  // Expense breakdown
  const expEl=document.getElementById('bizExpenseChart');
  if(expEl){
    const expLabels=[],expValues=[],expColors=[];
    if(pl.cogs.length){expLabels.push('COGS');expValues.push(Math.abs(arrSum(pl.cogs)));expColors.push('#e05c5c')}
    if(pl.opex.length){expLabels.push('OpEx');expValues.push(Math.abs(arrSum(pl.opex)));expColors.push('#e0a33c')}
    if(pl.depreciation.length){expLabels.push('Depreciation');expValues.push(Math.abs(arrSum(pl.depreciation)));expColors.push('#9b7ae0')}
    if(pl.interest.length){expLabels.push('Interest');expValues.push(Math.abs(arrSum(pl.interest)));expColors.push('#5ca0e0')}
    if(pl.tax.length){expLabels.push('Tax');expValues.push(Math.abs(arrSum(pl.tax)));expColors.push('#e08a5c')}
    if(expLabels.length){
      finCharts.bizExpense=new Chart(expEl,{type:'doughnut',data:{labels:expLabels,datasets:[{data:expValues,backgroundColor:expColors,borderColor:'#181a22',borderWidth:3}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right',labels:{color:'#8b8fa3',font:{family:'DM Sans',size:11},padding:12}}}}});
    }
  }
  // Margin trend
  const margEl=document.getElementById('bizMarginChart');
  if(margEl&&pl.revenue.length){
    const grossMargins=pl.revenue.map((r,i)=>r?(((pl.grossProfit[i]||0)/r)*100):0);
    const netMargins=pl.revenue.map((r,i)=>r?(((pl.netProfit[i]||0)/r)*100):0);
    finCharts.bizMargin=new Chart(margEl,{type:'line',data:{labels:periods,datasets:[{label:'Gross Margin %',data:grossMargins,borderColor:'#4ead6b',tension:.3},{label:'Net Margin %',data:netMargins,borderColor:'#5ca0e0',tension:.3}]},options:{...chartDefaults,scales:{...chartDefaults.scales,y:{...chartDefaults.scales.y,ticks:{...chartDefaults.scales.y.ticks,callback:v=>v.toFixed(0)+'%'}}}}});
  }
  // Revenue vs Costs bar
  const watEl=document.getElementById('bizWaterfallChart');
  if(watEl){
    finCharts.bizWaterfall=new Chart(watEl,{type:'bar',data:{labels:periods,datasets:[{label:'Revenue',data:pl.revenue,backgroundColor:'rgba(201,164,108,.7)',borderRadius:4},{label:'Total Costs',data:pl.revenue.map((r,i)=>(pl.cogs[i]||0)+(pl.opex[i]||0)),backgroundColor:'rgba(224,92,92,.5)',borderRadius:4}]},options:chartDefaults});
  }
}

// Global keys
document.addEventListener('keydown',e=>{if(e.key==='Escape'){closeTaskModal();closeProjectModal();closeDeleteModal();closeSettingsModal();closeDeadlinePopover()}if(e.key==='Enter'){if(document.getElementById('taskModalOverlay').classList.contains('open'))saveTaskModal();else if(document.getElementById('projectModalOverlay').classList.contains('open'))addProject()}});

// Filters
document.querySelectorAll('.filter-btn').forEach(btn=>{btn.addEventListener('click',()=>{document.querySelectorAll('.filter-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');activeFilter=btn.dataset.filter;showBacklog=false;document.querySelector('.backlog-btn')?.classList.remove('active');render()})});
</script>
</body>
</html>
