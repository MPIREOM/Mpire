// Reads .env.local and generates a TypeScript file with server-only env vars
// as literal string constants — bypasses all bundler/runtime env issues.
import { readFileSync, writeFileSync, mkdirSync } from 'fs';

function readKey(content, key) {
  const match = content.match(new RegExp(`^${key}=(.+)$`, 'm'));
  return match ? match[1].trim() : '';
}

let content = '';
try {
  content = readFileSync('.env.local', 'utf8');
} catch {
  console.warn('Warning: .env.local not found, generated server-env will have empty values');
}

const serviceRoleKey = readKey(content, 'SUPABASE_SERVICE_ROLE_KEY');

mkdirSync('src/lib/generated', { recursive: true });
writeFileSync(
  'src/lib/generated/server-env.ts',
  `// AUTO-GENERATED by scripts/gen-server-env.mjs — do not edit manually
import 'server-only';

export const SUPABASE_SERVICE_ROLE_KEY = '${serviceRoleKey}';
`
);

console.log('Generated src/lib/generated/server-env.ts');
